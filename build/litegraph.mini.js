/*packed*/import{Node}from"./Node.js";import{Link}from"./Link.js";import{Graph}from"./Graph.js";import{Group}from"./Group.js";import{ContextMenu}from"./ContextMenu.js";var Lite=new class{constructor(){this.VERSION="0.10.2",this.CANVAS_GRID_SIZE=10,this.NODE_TITLE_HEIGHT=30,this.NODE_TITLE_TEXT_Y=20,this.NODE_SLOT_HEIGHT=20,this.NODE_WIDGET_HEIGHT=20,this.NODE_WIDTH=140,this.NODE_MIN_WIDTH=50,this.NODE_COLLAPSED_RADIUS=10,this.NODE_COLLAPSED_WIDTH=80,this.NODE_TITLE_COLOR="#999",this.NODE_SELECTED_TITLE_COLOR="#FFF",this.NODE_TEXT_SIZE=14,this.NODE_TEXT_COLOR="#AAA",this.NODE_SUBTEXT_SIZE=12,this.NODE_DEFAULT_COLOR="#333",this.NODE_DEFAULT_BGCOLOR="#353535",this.NODE_DEFAULT_BOXCOLOR="#666",this.NODE_DEFAULT_SHAPE="box",this.NODE_BOX_OUTLINE_COLOR="#FFF",this.DEFAULT_SHADOW_COLOR="rgba(0,0,0,0.5)",this.DEFAULT_GROUP_FONT=24,this.WIDGET_BGCOLOR="#222",this.WIDGET_OUTLINE_COLOR="#666",this.WIDGET_TEXT_COLOR="#DDD",this.WIDGET_SECONDARY_TEXT_COLOR="#999",this.LINK_COLOR="#9A9",this.EVENT_LINK_COLOR="#A86",this.CONNECTING_LINK_COLOR="#AFA",this.MAX_NUMBER_OF_NODES=1e3,this.DEFAULT_POSITION=[100,100],this.VALID_SHAPES=["default","box","round","card"],this.BOX_SHAPE=1,this.ROUND_SHAPE=2,this.CIRCLE_SHAPE=3,this.CARD_SHAPE=4,this.ARROW_SHAPE=5,this.GRID_SHAPE=6,this.INPUT=1,this.OUTPUT=2,this.EVENT=-1,this.ACTION=-1,this.NODE_MODES=["Always","On Event","Never","On Trigger","On Request"],this.NODE_MODES_COLORS=["#666","#422","#333","#224","#626"],this.ALWAYS=0,this.ON_EVENT=1,this.NEVER=2,this.ON_TRIGGER=3,this.ON_REQUEST=4,this.UP=1,this.DOWN=2,this.LEFT=3,this.RIGHT=4,this.CENTER=5,this.LINK_RENDER_MODES=["Straight","Linear","Spline"],this.STRAIGHT_LINK=0,this.LINEAR_LINK=1,this.SPLINE_LINK=2,this.NORMAL_TITLE=0,this.NO_TITLE=1,this.TRANSPARENT_TITLE=2,this.AUTOHIDE_TITLE=3,this.VERTICAL_LAYOUT="vertical",this.proxy=null,this.node_images_path="",this.debug=!1,this.catch_exceptions=!0,this.throw_errors=!0,this.allow_scripts=!1,this.use_deferred_actions=!0,this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.Globals={},this.searchbox_extras={},this.auto_sort_node_types=!1,this.node_box_coloured_when_on=!1,this.node_box_coloured_by_mode=!1,this.dialog_close_on_mouse_leave=!0,this.dialog_close_on_mouse_leave_delay=500,this.shift_click_do_break_link_from=!1,this.click_do_break_link_to=!1,this.search_hide_on_mouse_leave=!0,this.search_filter_enabled=!1,this.search_show_all_on_open=!0,this.show_node_tooltip=!1,this.show_node_tooltip_use_descr_property=!1,this.auto_load_slot_types=!1,this.registered_slot_in_types={},this.registered_slot_out_types={},this.slot_types_in=[],this.slot_types_out=[],this.slot_types_default_in=[],this.slot_types_default_out=[],this.graphDefaultConfig={align_to_grid:!0,links_ontop:!1},this.alt_drag_do_clone_nodes=!1,this.alt_shift_drag_connect_clone_with_input=!0,this.do_add_triggers_slots=!1,this.allow_multi_output_for_events=!0,this.middle_click_slot_add_default_node=!1,this.release_link_on_empty_shows_menu=!1,this.two_fingers_opens_menu=!1,this.backspace_delete=!0,this.ctrl_shift_v_paste_connect_unselected_outputs=!1,this.actionHistory_enabled=!1,this.actionHistoryMaxSave=40,this.refreshAncestorsOnTriggers=!1,this.refreshAncestorsOnActions=!1,this.ensureUniqueExecutionAndActionCall=!1,this.use_uuids=!1,this.context_menu_filter_enabled=!1,this.showCanvasOptions=!1,this.availableCanvasOptions=["allow_addOutSlot_onExecuted","free_resize","highquality_render","use_gradients","pause_rendering","clear_background","read_only","live_mode","show_info","allow_dragcanvas","allow_dragnodes","allow_interaction","allow_searchbox","move_destination_link_without_shift","set_canvas_dirty_on_mouse_event","always_render_background","render_shadows","render_canvas_border","render_connections_shadows","render_connections_border","render_connection_arrows","render_collapsed_slots","render_execution_order","render_title_colored","render_link_tooltip"],this.actionHistoryMaxSave=40,this.canRemoveSlots=!0,this.canRemoveSlots_onlyOptional=!0,this.canRenameSlots=!0,this.canRenameSlots_onlyOptional=!0,this.ensureNodeSingleExecution=!1,this.ensureNodeSingleAction=!1,this.preventAncestorRecalculation=!1,this.ensureUniqueExecutionAndActionCall=!0,this.allowMultiOutputForEvents=!1}registerNodeType(type,base_class){if(!base_class.prototype)throw new Error("Cannot register a simple object, it must be a class with a prototype");base_class.type=type,Lite.debug&&console.log("Node registered: "+type);var classname=base_class.name,pos=type.lastIndexOf("/");base_class.category=type.substring(0,pos),base_class.title||(base_class.title=classname);const propertyDescriptors=Object.getOwnPropertyDescriptors(Node.prototype);Object.keys(propertyDescriptors).forEach(propertyName=>{base_class.prototype.hasOwnProperty(propertyName)||Object.defineProperty(base_class.prototype,propertyName,propertyDescriptors[propertyName])});pos=this.registered_node_types[type];if(pos&&Lite.debug&&console.log("replacing node type: "+type),!Object.prototype.hasOwnProperty.call(base_class.prototype,"shape")&&(Object.defineProperty(base_class.prototype,"shape",{set:function(v){switch(v){case"default":delete this._shape;break;case"box":this._shape=Lite.BOX_SHAPE;break;case"round":this._shape=Lite.ROUND_SHAPE;break;case"circle":this._shape=Lite.CIRCLE_SHAPE;break;case"card":this._shape=Lite.CARD_SHAPE;break;default:this._shape=v}},get:function(){return this._shape},enumerable:!0,configurable:!0}),base_class.supported_extensions))for(let i in base_class.supported_extensions){const ext=base_class.supported_extensions[i];ext&&ext.constructor===String&&(this.node_types_by_file_extension[ext.toLowerCase()]=base_class)}if((this.registered_node_types[type]=base_class).constructor.name&&(this.Nodes[classname]=base_class),Lite.onNodeTypeRegistered?.(type,base_class),pos&&Lite.onNodeTypeReplaced?.(type,base_class,pos),base_class.prototype.onPropertyChange&&console.warn("Lite node class "+type+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),base_class.supported_extensions)for(var i=0;i<base_class.supported_extensions.length;i++){var ext=base_class.supported_extensions[i];ext&&ext.constructor===String&&(this.node_types_by_file_extension[ext.toLowerCase()]=base_class)}this.auto_load_slot_types&&new base_class(base_class.title??"tmpnode")}unregisterNodeType(type){var base_class=type.constructor===String?this.registered_node_types[type]:type;if(!base_class)throw new Error("node type not found: "+type);delete this.registered_node_types[base_class.type],base_class.constructor.name&&delete this.Nodes[base_class.constructor.name]}registerNodeAndSlotType(type,slot_type,out=!1){var class_type=(type.constructor===String&&"anonymous"!==this.registered_node_types[type]?this.registered_node_types[type]:type).constructor.type;let allTypes=[];allTypes="string"==typeof slot_type?slot_type.split(","):slot_type==this.EVENT||slot_type==this.ACTION?["_event_"]:["*"];for(let i=0;i<allTypes.length;++i){let slotType=allTypes[i];""===slotType&&(slotType="*");var registerTo=out?"registered_slot_out_types":"registered_slot_in_types";void 0===this[registerTo][slotType]&&(this[registerTo][slotType]={nodes:[]}),this[registerTo][slotType].nodes.includes(class_type)||this[registerTo][slotType].nodes.push(class_type),out?this.slot_types_out.includes(slotType.toLowerCase())||(this.slot_types_out.push(slotType.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(slotType.toLowerCase())||(this.slot_types_in.push(slotType.toLowerCase()),this.slot_types_in.sort())}}buildNodeClassFromObject(name,object){var ctor_code="";if(object.inputs)for(let i=0;i<object.inputs.length;++i){var _name=object.inputs[i][0];let _type=object.inputs[i][1];ctor_code+="this.addInput('"+_name+"',"+(_type=_type&&_type.constructor===String?'"'+_type+'"':_type)+");\n"}if(object.outputs)for(let i=0;i<object.outputs.length;++i){let _name=object.outputs[i][0],_type=object.outputs[i][1];ctor_code+="this.addOutput('"+_name+"',"+(_type=_type&&_type.constructor===String?'"'+_type+'"':_type)+");\n"}if(object.properties)for(var i in object.properties){let prop=object.properties[i];prop&&prop.constructor===String&&(prop='"'+prop+'"'),ctor_code+="this.addProperty('"+i+"',"+prop+");\n"}ctor_code+="if(this.onCreate)this.onCreate()";var classobj=Function(ctor_code);for(let i in object)"inputs"!=i&&"outputs"!=i&&"properties"!=i&&(classobj.prototype[i]=object[i]);return classobj.title=object.title||name.split("/").pop(),classobj.desc=object.desc||"Generated from object",this.registerNodeType(name,classobj),classobj}wrapFunctionAsNode(name,func,param_types,return_type,properties){const names=Lite.getParameterNames(func);var code=names.map((name,i)=>{return`this.addInput('${name}', ${param_types?.[i]?`'${param_types[i]}'`:"0"});`}).join("\n"),return_type=return_type?`'${return_type}'`:0,properties=properties?`this.properties = ${JSON.stringify(properties)};`:"",code=new Function(`
            ${code}
            this.addOutput('out', ${return_type});
            ${properties}
        `);return code.title=name.split("/").pop(),code.desc="Generated from "+func.name,code.prototype.onExecute=function(){var params=names.map((name,i)=>this.getInputData(i)),params=func.apply(this,params);this.setOutputData(0,params)},this.registerNodeType(name,code),code}clearRegisteredTypes(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}addNodeMethod(name,func){for(var i in Node.prototype[name]=func,this.registered_node_types){i=this.registered_node_types[i];i.prototype[name]&&(i.prototype["_"+name]=i.prototype[name]),i.prototype[name]=func}}createNode(type,title,options={}){var base_class=this.registered_node_types[type]??null;if(!base_class)return Lite.debug&&console.log(`GraphNode type "${type}" not registered.`),null;title=title??base_class.title??type;let node=null;if(Lite.catch_exceptions)try{node=new base_class(title)}catch(err){return console.error(err),null}else node=new base_class(title);return node.type=type,node.title??=title,node.properties??={},node.properties_info??=[],node.flags??={},node.size??=node.computeSize(),node.pos??=Lite.DEFAULT_POSITION.concat(),node.mode??=Lite.ALWAYS,Object.assign(node,options),node.onNodeCreated?.(),node}getNodeType(type){return this.registered_node_types[type]}getNodeTypesInCategory(category,filter){var filteredTypes=Object.values(this.registered_node_types).filter(type=>type.filter===filter&&(""===category?null===type.category:type.category===category));return this.auto_sort_node_types&&filteredTypes.sort((a,b)=>a.title.localeCompare(b.title)),filteredTypes}getNodeTypesCategories(filter){const categories={"":1};Object.values(this.registered_node_types).forEach(type=>{type.category&&!type.skip_list&&type.filter===filter&&(categories[type.category]=1)});var result=Object.keys(categories);return this.auto_sort_node_types?result.sort():result}reloadNodes(folder_wildcard){var tmp=document.getElementsByTagName("script"),script_files=[];for(let i=0;i<tmp.length;i++)script_files.push(tmp[i]);var docHeadObj=document.getElementsByTagName("head")[0];folder_wildcard=document.location.href+folder_wildcard;for(let i=0;i<script_files.length;i++){var src=script_files[i].src;if(src&&src.substr(0,folder_wildcard.length)==folder_wildcard)try{Lite.debug&&console.log("Reloading: "+src);var dynamicScript=document.createElement("script");dynamicScript.type="text/javascript",dynamicScript.src=src,docHeadObj.appendChild(dynamicScript),docHeadObj.removeChild(script_files[i])}catch(err){if(Lite.throw_errors)throw err;Lite.debug&&console.log("Error while reloading "+src)}}Lite.debug&&console.log("Nodes reloaded")}cloneObject(obj,target){if(null==obj)return null;var clonedObj=JSON.parse(JSON.stringify(obj));if(!target)return clonedObj;for(const key in clonedObj)Object.prototype.hasOwnProperty.call(clonedObj,key)&&(target[key]=clonedObj[key]);return target}uuidv4(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,a=>(a^16*Math.random()>>a/4).toString(16))}isValidConnection(type_a,type_b){if(""!==type_b&&"*"!==type_b||(type_b=0),!(type_a=""!==type_a&&"*"!==type_a?type_a:0)||!type_b||type_a===type_b||type_a===Lite.EVENT&&type_b===Lite.ACTION)return!0;if(type_a=String(type_a).toLowerCase(),type_b=String(type_b).toLowerCase(),!type_a.includes(",")&&!type_b.includes(","))return type_a===type_b;var type_a=type_a.split(","),supported_types_b=type_b.split(",");for(const supported_type_a of type_a)for(const supported_type_b of supported_types_b)if(this.isValidConnection(supported_type_a,supported_type_b))return!0;return!1}registerSearchboxExtra(node_type,description,data){this.searchbox_extras[description.toLowerCase()]={type:node_type,desc:description,data:data}}fetchFile(url,type,on_complete,on_error){if(url){if(type=type||"text",url.constructor===String)return"http"==url.substr(0,4)&&Lite.proxy&&(url=Lite.proxy+url.substr(url.indexOf(":")+3)),fetch(url).then(response=>{if(response.ok)return"arraybuffer"==type?response.arrayBuffer():"text"==type||"string"==type?response.text():"json"==type?response.json():"blob"==type?response.blob():void 0;throw new Error("File not found")}).then(data=>{on_complete&&on_complete(data)}).catch(error=>{console.error("error fetching file:",url),on_error&&on_error(error)});if(url.constructor===File||url.constructor===Blob){var reader=new FileReader;if(reader.onload=e=>{e=e.target.result;"json"==type&&(e=JSON.parse(e)),on_complete&&on_complete(e)},"arraybuffer"==type)return reader.readAsArrayBuffer(url);if("text"==type||"json"==type)return reader.readAsText(url);if("blob"==type)return reader.readAsBinaryString(url)}}return null}compareObjects(a,b){var aKeys=Object.keys(a);return aKeys.length===Object.keys(b).length&&aKeys.every(key=>a[key]===b[key])}distance(a,b){var[a,yA]=a,[b,yB]=b;return Math.sqrt((b-a)**2+(yB-yA)**2)}colorToString(c){return"rgba("+Math.round(255*c[0]).toFixed()+","+Math.round(255*c[1]).toFixed()+","+Math.round(255*c[2]).toFixed()+","+(4==c.length?c[3].toFixed(2):"1.0")+")"}canvasFillTextMultiline(context,text,x,y,maxWidth,lineHeight){var words=(text+"").trim().split(" "),line="",ret={lines:[],maxW:0,height:0};if(1<words.length)for(var n=0;n<words.length;n++){var testLine=line+words[n]+" ",testWidth=context.measureText(testLine).width;maxWidth<testWidth&&0<n?(context.fillText(line,x,y+lineHeight*ret.lines.length),line=words[n]+" ",ret.max=testWidth,ret.lines.push(line)):line=testLine}else line=words[0];return context.fillText(line,x,y+lineHeight*ret.lines.length),ret.lines.push(line),ret.height=lineHeight*ret.lines.length||lineHeight,ret}isInsideRectangle(x,y,left,top,width,height){return left<x&&x<left+width&&top<y&&y<top+height}growBounding(bounding,x,y){x<bounding[0]?bounding[0]=x:x>bounding[2]&&(bounding[2]=x),y<bounding[1]?bounding[1]=y:y>bounding[3]&&(bounding[3]=y)}isInsideBounding(p,bb){return p[0]>=bb[0][0]&&p[1]>=bb[0][1]&&p[0]<=bb[1][0]&&p[1]<=bb[1][1]}overlapBounding(a,b){var A_end_x=a[0]+a[2],A_end_y=a[1]+a[3],B_end_x=b[0]+b[2],B_end_y=b[1]+b[3];return!(a[0]>B_end_x||a[1]>B_end_y||A_end_x<b[0]||A_end_y<b[1])}hex2num(hex){hex=(hex="#"==hex.charAt(0)?hex.slice(1):hex).toUpperCase();for(var int1,int2,value=new Array(3),k=0,i=0;i<6;i+=2)int1="0123456789ABCDEF".indexOf(hex.charAt(i)),int2="0123456789ABCDEF".indexOf(hex.charAt(i+1)),value[k]=16*int1+int2,k++;return value}num2hex(triplet){for(var int1,int2,hex="#",i=0;i<3;i++)int1=triplet[i]/16,int2=triplet[i]%16,hex+="0123456789ABCDEF".charAt(int1)+"0123456789ABCDEF".charAt(int2);return hex}extendClass=(target,origin)=>{for(var i in origin)target.hasOwnProperty(i)||(target[i]=origin[i]);if(origin.prototype)for(let i in origin.prototype)!origin.prototype.hasOwnProperty(i)||target.prototype.hasOwnProperty(i)||(origin.prototype.__lookupGetter__(i)?target.prototype.__defineGetter__(i,origin.prototype.__lookupGetter__(i)):target.prototype[i]=origin.prototype[i],origin.prototype.__lookupSetter__(i)&&target.prototype.__defineSetter__(i,origin.prototype.__lookupSetter__(i)))};getParameterNames=func=>(func+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean);clamp=(v,a,b)=>v<a?a:b<v?b:v};Lite.Link=Link,Lite.Graph=Graph,Lite.Node=Node,Lite.Group=Group,Lite.ContextMenu=ContextMenu,"undefined"!=typeof performance?Lite.getTime=performance.now.bind(performance):"undefined"!=typeof Date&&Date.now?Lite.getTime=Date.now.bind(Date):"undefined"!=typeof process?Lite.getTime=()=>{var t=process.hrtime();return.001*t[0]+1e-6*t[1]}:Lite.getTime=function(){return(new Date).getTime()},"undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||(callback=>{window.setTimeout(callback,1e3/60)}));export{Lite};

import{Lite}from"./Lite.js";class ContextMenu{constructor(values,options={}){(this.options=options).scroll_speed??=.1,this.menu_elements=[],this.#linkToParent(),this.#validateEventClass(),this.#createRoot(),this.#bindEvents(),this.setTitle(this.options.title),this.addItems(values),this.#insertMenu(),this.#calculateBestPosition()}#createRoot(){var root=this.root=document.createElement("div");return this.options.className&&(root.className=this.options.className),root.classList.add("litegraph","litecontextmenu","litemenubar-panel"),root.style.minWidth="80px",root.style.minHeight="10px",root}#bindEvents(){const root=this.root;root.style.pointerEvents="none",setTimeout(()=>{root.style.pointerEvents="auto"},100),root.addEventListener("pointerup",e=>(e.preventDefault(),!0)),root.addEventListener("contextmenu",e=>(2==e.button&&e.preventDefault(),!1)),root.addEventListener("pointerdown",e=>{if(2==e.button)return this.close(),e.preventDefault(),!0}),root.addEventListener("wheel",e=>{var pos=parseInt(root.style.top);return root.style.top=(pos+e.deltaY*this.options.scroll_speed).toFixed()+"px",e.preventDefault(),!0}),root.addEventListener("pointerenter",_event=>{root.closing_timer&&clearTimeout(root.closing_timer)})}#linkToParent(){var parentMenu=this.options.parentMenu;parentMenu&&(parentMenu.constructor!==this.constructor?(console.error("parentMenu must be of class ContextMenu, ignoring it"),this.options.parentMenu=null):(this.parentMenu=parentMenu,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this))}#validateEventClass(){var eventClass;this.options.event&&"MouseEvent"!==(eventClass=this.options.event.constructor.name)&&"CustomEvent"!==eventClass&&"PointerEvent"!==eventClass&&(console.error(`Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Ignoring it. (${eventClass})`),this.options.event=null)}setTitle(title){var element;title&&(this.titleElement??=document.createElement("div"),(element=this.titleElement).className="litemenu-title",element.innerHTML=title,this.root.parentElement||this.root.appendChild(element))}addItems(values){for(let i=0;i<values.length;i++){let name=values[i];"string"!=typeof name&&(name=name&&void 0!==name.content?String(name.content):String(name));var value=values[i];this.menu_elements.push(this.addItem(name,value,this.options))}}#insertMenu(){const doc=this.options.event?.target.ownerDocument??document;var parent=doc.fullscreenElement??doc.body;const root=this.root,that=this;Lite.context_menu_filter_enabled&&(doc?(root.f_textfilter&&(doc.removeEventListener("keydown",root.f_textfilter,!1),doc.removeEventListener("keydown",root.f_textfilter,!0),root.f_textfilter=!1),root.f_textfilter=function(e){if(that.current_submenu)Lite.debug&&console.debug("Prevent filtering on ParentMenu",that);else{if(that.allOptions||(that.allOptions=that.menu_elements,that.selectedOption=!1),that.currentOptions||(that.currentOptions=that.allOptions),that.filteringText||(that.filteringText=""),e.key){var kdone=!1;switch(e.key){case"Backspace":that.filteringText.length&&(that.filteringText=that.filteringText.substring(0,that.filteringText.length-1),kdone=!0);break;case"Escape":root.f_textfilter&&(doc.removeEventListener("keydown",root.f_textfilter,!1),doc.removeEventListener("keydown",root.f_textfilter,!0),root.f_textfilter=!1),that.close();break;case"ArrowDown":for(;that.selectedOption=!1!==that.selectedOption?Math.min(Math.max(that.selectedOption+1,0),that.allOptions.length-1):0,that.allOptions[that.selectedOption]&&that.allOptions[that.selectedOption].hidden&&that.selectedOption<that.allOptions.length-1;);that.allOptions[that.selectedOption]&&that.allOptions[that.selectedOption].hidden&&(that.selectedOption=that.currentOptions[that.currentOptions.length-1].menu_index),kdone=!0;break;case"ArrowUp":for(;that.selectedOption=!1!==that.selectedOption?Math.min(Math.max(that.selectedOption-1,0),that.allOptions.length-1):0,that.allOptions[that.selectedOption]&&that.allOptions[that.selectedOption].hidden&&0<that.selectedOption;);that.allOptions[that.selectedOption]&&that.allOptions[that.selectedOption].hidden&&(that.currentOptions&&that.currentOptions.length?that.selectedOption=that.currentOptions[0].menu_index:that.selectedOption=!1),kdone=!0;break;case"ArrowLeft":break;case"ArrowRight":case"Enter":if(!1!==that.selectedOption)that.allOptions[that.selectedOption]?(Lite.debug&&console.debug("ContextElement simCLICK",that.allOptions[iO]),that.allOptions[that.selectedOption].do_click&&that.allOptions[that.selectedOption].do_click(that.options.event,ignore_parent_menu)):(Lite.debug&&console.debug("ContextElement selection wrong",that.selectedOption),that.selectedOption=!1!==that.selectedOption?Math.min(Math.max(that.selectedOption,0),that.allOptions.length-1):0);else if(that.filteringText.length)for(var iO in that.allOptions)if("none"!==that.allOptions[iO].style.display&&!(that.allOptions[iO].classList+"").includes("separator")&&"Search"!==that.allOptions[iO].textContent){Lite.debug&&console.debug("ContextElement simCLICK",that.allOptions[iO]),root.f_textfilter&&doc&&(doc.removeEventListener("keydown",root.f_textfilter,!1),doc.removeEventListener("keydown",root.f_textfilter,!0),Lite.debug)&&console.debug("Cleaned ParentContextMenu listener",doc,that);var ignore_parent_menu=!1;that.allOptions[iO].do_click(e,ignore_parent_menu);break}kdone=!0;break;default:Lite.debug&&console.debug("ContextMenu filter: keyEvent",e.keyCode,e.key),String.fromCharCode(e.key).match(/(\w|\s)/g)}kdone||1!=e.key.length||(that.filteringText+=e.key,that.parentMenu)}if(that.filteringText&&""!==that.filteringText){var aFilteredOpts=[];for(iO in that.currentOptions=[],that.allOptions){var txtCont=that.allOptions[iO].textContent,doesContainW=txtCont.toLocaleLowerCase().includes(that.filteringText.toLocaleLowerCase()),isStartW=txtCont.toLocaleLowerCase().startsWith(that.filteringText.toLocaleLowerCase()),wSplits=txtCont.split("/"),wSplits=1<wSplits.length&&wSplits[wSplits.length-1].toLocaleLowerCase().startsWith(that.filteringText.toLocaleLowerCase())||1==wSplits.length&&isStartW,txtCont=(that.allOptions[iO].classList+"").includes("separator")||"Search"===txtCont;that.allOptions[iO].menu_index=iO,doesContainW&&!txtCont?(aFilteredOpts.push(that.allOptions[iO]),that.allOptions[iO].style.display="block",that.allOptions[iO].hidden=!1,that.currentOptions.push(that.allOptions[iO]),that.allOptions[iO].filtered_index=that.currentOptions.length-1):(that.allOptions[iO].hidden=!0,that.allOptions[iO].style.display="none",that.allOptions[iO].filtered_index=!1),wSplits?that.allOptions[iO].style.fontWeight="bold":isStartW&&(that.allOptions[iO].style.fontStyle="italic")}that.selectedOption=!1!==that.selectedOption?Math.min(Math.max(that.selectedOption,0),that.allOptions.length-1):0,that.allOptions[that.selectedOption]&&that.allOptions[that.selectedOption].hidden&&that.currentOptions.length&&(that.selectedOption=that.currentOptions[0].menu_index)}else for(var iO in aFilteredOpts=that.allOptions,that.currentOptions=that.allOptions,that.allOptions)that.allOptions[iO].style.display="block",that.allOptions[iO].style.fontStyle="inherit",that.allOptions[iO].style.fontWeight="inherit",that.allOptions[iO].hidden=!1,that.allOptions[iO].filtered_index=!1,that.allOptions[iO].menu_index=iO;if(!1!==that.selectedOption)for(var iO in Lite.debug&&console.debug("ContextMenu selection: ",that.selectedOption),that.allOptions){var isSelected=that.selectedOption+""==iO+"";Lite.debug,isSelected?that.allOptions[iO].classList.add("selected"):that.allOptions[iO].classList.remove("selected")}document.body.getBoundingClientRect(),root.getBoundingClientRect();root.style.top=that.top_original+"px"}},doc.addEventListener("keydown",root.f_textfilter,!0)):console.warning("NO root document to add context menu and event",doc,options)),parent.appendChild(this.root)}#calculateBestPosition(){var rect,root_rect,options=this.options,root=this.root;let left=options.left||0,top=options.top||0;this.top_original=top,options.event&&(left=options.event.clientX-10,top=options.event.clientY-10,options.title&&(top-=20),this.top_original=top,options.parentMenu&&(rect=options.parentMenu.root.getBoundingClientRect(),left=rect.left+rect.width),rect=document.body.getBoundingClientRect(),root_rect=root.getBoundingClientRect(),0===rect.height&&console.error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),rect.width&&left>rect.width-root_rect.width-10&&(left=rect.width-root_rect.width-10),rect.height)&&top>rect.height-root_rect.height-10&&(top=rect.height-root_rect.height-10),root.style.left=left+"px",root.style.top=top+"px",options.scale&&(root.style.transform=`scale(${options.scale})`)}addItem(name,value,options={}){var element=document.createElement("div");let disabled=!(element.className="litemenu-entry submenu");null===value?element.classList.add("separator"):(element.innerHTML=value?.title??name,(element.value=value)&&(value.disabled&&(disabled=!0,element.classList.add("disabled")),value.submenu||value.has_submenu)&&element.classList.add("has_submenu"),"function"==typeof value?(element.dataset.value=name,element.onclick_callback=value):element.dataset.value=value,value.className&&(element.className+=" "+value.className)),this.root.appendChild(element),disabled||element.addEventListener("click",handleMenuItemClick),!disabled&&options.autoopen&&element.addEventListener("pointerenter",event=>{var value=this.value;value&&value.has_submenu&&handleMenuItemClick.call(this,event)});var that=this;function handleMenuItemClick(event){var value=this.value;let closeParent=!0;if((Lite.debug&&console.debug("ContextMenu handleMenuItemClick",value,options,closeParent,this.current_submenu,this),that.current_submenu?.close(event),options.callback&&(Lite.debug&&console.debug("ContextMenu handleMenuItemClick callback",this,value,options,event,that,options.node),!0===options.callback.call(this,value,options,event,that,options.node))&&(closeParent=!1),value)&&(value.callback&&!options.ignore_item_callbacks&&!0!==value.disabled&&(Lite.debug&&console.debug("ContextMenu using value callback and !ignore_item_callbacks",this,value,options,event,that,options.node),!0===value.callback.call(this,value,options,event,that,options.extra))&&(closeParent=!1),value.submenu)){if(Lite.debug&&console.debug("ContextMenu SUBMENU",this,value,value.submenu.options,e,that,options),!value.submenu.options)throw new Error("ContextMenu submenu needs options");new that.constructor(value.submenu.options,{callback:value.submenu.callback,event:event,parentMenu:that,ignore_item_callbacks:value.submenu.ignore_item_callbacks,title:value.submenu.title,extra:value.submenu.extra,autoopen:options.autoopen}),closeParent=!1}closeParent&&!that.lock&&that.close()}return element}close(e,ignore_parent_menu){if(this.root.f_textfilter){let doc=document;doc.removeEventListener("keydown",this.root.f_textfilter,!0),doc.removeEventListener("keydown",this.root.f_textfilter,!1),(doc=(doc=e&&e.target?e.target.ownerDocument:doc)||document).removeEventListener("keydown",this.root.f_textfilter,!0),doc.removeEventListener("keydown",this.root.f_textfilter,!1)}this.parentMenu&&!ignore_parent_menu&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===e?this.parentMenu.close():e&&!ContextMenu.isCursorOverElement(e,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,"pointerleave",e)),this.current_submenu?.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}static closeAll=(ref_window=window)=>{ref_window=ref_window.document.querySelectorAll(".litecontextmenu");ref_window.length&&ref_window.forEach(element=>{element.close?element.close():element.parentNode?.removeChild(element)})};static trigger(element,event_name,params,origin){event_name=new CustomEvent(event_name,{bubbles:!0,cancelable:!0,detail:params});return Object.defineProperty(event_name,"target",{value:origin}),element.dispatchEvent?element.dispatchEvent(event_name):element.__events&&element.__events.dispatchEvent(event_name),event_name}getTopMenu(){return this.options.parentMenu?.getTopMenu()??this}getFirstEvent(){return this.options.parentMenu?.getFirstEvent()??this.options.event}static isCursorOverElement(event,element){return Lite.isInsideRectangle(event.clientX,event.clientY,element.left,element.top,element.width,element.height)}}export{ContextMenu};

import{Lite}from"../Lite.js";import{DragAndScale}from"../dragandscale.js";class Canvas{constructor(canvas,graph,options){this.options=options??={skip_render:!1,autoresize:!1,clip_all_nodes:!1},this.background_image=Canvas.DEFAULT_BACKGROUND_IMAGE,canvas&&canvas.constructor===String&&(canvas=document.querySelector(canvas)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=Lite.NODE_TEXT_SIZE+"px Arial",this.inner_text_font=`normal ${Lite.NODE_SUBTEXT_SIZE}px Arial`,this.node_title_color=Lite.NODE_TITLE_COLOR,this.default_link_color=Lite.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.move_destination_link_without_shift=!1,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!0,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.free_resize=!0,this.links_render_mode=Lite.SPLINE_LINK,this.autoresize=options.autoresize,this.skip_render=options.skip_render,this.clip_all_nodes=options.clip_all_nodes,this.free_resize=options.free_resize,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=options.viewport||null,this.low_quality_rendering_threshold=5,graph?.attachCanvas(this),this.setCanvas(canvas,options.skip_events),this.clear(),this.skip_render||options.skip_render||this.startRendering()}clear(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.low_quality_rendering_counter=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.onClear?.()}setGraph(graph,skip_clear){this.graph!=graph&&(skip_clear||this.clear(),graph?(graph.attachCanvas(this),this._graph_stack&&=null,this.setDirty(!0,!0)):this.graph?.detachCanvas(this))}getTopGraph(){return this._graph_stack.length?this._graph_stack[0]:this.graph}openSubgraph(graph){if(!graph)throw new Error("graph cannot be null");if(this.graph==graph)throw new Error("graph cannot be the same");this.clear(),this.graph&&(this._graph_stack||=[],this._graph_stack.push(this.graph)),graph.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}closeSubgraph(){var subgraph_node,graph;this._graph_stack&&0!=this._graph_stack.length&&(subgraph_node=this.graph._subgraph_node,graph=this._graph_stack.pop(),this.selected_nodes={},this.highlighted_links={},graph.attachCanvas(this),this.setDirty(!0,!0),subgraph_node&&(this.centerOnNode(subgraph_node),this.selectNodes([subgraph_node])),this.ds.offset=[0,0],this.ds.scale=1)}getCurrentGraph(){return this.graph}setCanvas(canvas,skip_events){if(canvas&&canvas.constructor===String&&!(canvas=document.getElementById(canvas)))throw new Error("Error creating Lite canvas: Canvas not found");if(canvas!==this.canvas&&(canvas||!this.canvas||skip_events||this.unbindEvents(),this.canvas=canvas,this.ds.element=canvas)){if(canvas.className+=" lgraphcanvas",canvas.data=this,canvas.tabindex="1",this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,null==canvas.getContext){if("canvas"!=canvas.localName)throw new Error("Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+canvas.localName);throw new Error("This browser doesn't support Canvas")}null==(this.ctx=canvas.getContext("2d"))&&(canvas.webgl_enabled||console.info("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),skip_events||this.bindEvents()}}_doNothing(e){return e.preventDefault(),!1}_doReturnTrue(e){return e.preventDefault(),!0}bindEvents(){var canvas,document;this._events_binded?console.warn("LGraphCanvas: events already binded"):(this._events_binded=!0,canvas=this.canvas,document=this.getCanvasWindow().document,this._mousedown_callback=this.processMouseDown.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),canvas.addEventListener("pointerdown",this._mousedown_callback,!0),canvas.addEventListener("pointermove",this._mousemove_callback),canvas.addEventListener("pointerup",this._mouseup_callback,!0),canvas.addEventListener("contextmenu",this._doNothing),canvas.addEventListener("wheel",this.processMouseWheel),canvas.addEventListener("keydown",this.processKey),document.addEventListener("keyup",this.processKey),canvas.addEventListener("dragover",this._doNothing,!1),canvas.addEventListener("dragend",this._doNothing,!1),canvas.addEventListener("drop",this.processDrop),canvas.addEventListener("dragenter",this._doReturnTrue,!1))}unbindEvents(){var canvas,document;this._events_binded?(this._events_binded=!1,canvas=this.canvas,document=this.getCanvasWindow().document,canvas.removeEventListener("pointerdown",this._mousedown_callback),canvas.removeEventListener("pointermove",this._mousemove_callback),canvas.removeEventListener("pointerup",this._mouseup_callback),canvas.removeEventListener("contextmenu",this._doNothing),canvas.removeEventListener("wheel",this.processMouseWheel),canvas.removeEventListener("keydown",this.processKey),document.removeEventListener("keyup",this.processKey),canvas.removeEventListener("dragover",this._doNothing,!1),canvas.removeEventListener("dragend",this._doNothing,!1),canvas.removeEventListener("drop",this.processDrop),canvas.removeEventListener("dragenter",this._doReturnTrue),this._mousedown_callback=null):console.warn("LGraphCanvas: no events binded")}static getFileExtension(url){var url=new URL(url).pathname,lastDotIndex=url.lastIndexOf(".");return-1===lastDotIndex?"":url.slice(lastDotIndex+1).toLowerCase()}enableWebGL(){if("undefined"==typeof GL)throw new Error("litegl.js must be included to use a WebGL canvas");if("undefined"==typeof enableWebGLCanvas)throw new Error("webglCanvas.js must be included to use this feature");this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0}setDirty(fgcanvas,bgcanvas){fgcanvas&&(this.dirty_canvas=!0),bgcanvas&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){var doc;return this.canvas?(doc=this.canvas.ownerDocument).defaultView??doc.parentWindow:window}startRendering(){function renderFrame(){this.pause_rendering||this.draw();var window=this.getCanvasWindow();this.is_rendering&&window.requestAnimationFrame(renderFrame.bind(this))}this.is_rendering||(this.is_rendering=!0,renderFrame.call(this))}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}processUserInputDown(e){if(this.pointer_is_down&&void 0!==e.isPrimary&&!e.isPrimary?this.userInput_isNotPrimary=!0:this.userInput_isNotPrimary=!1,this.userInput_type=e.pointerType||!1,this.userInput_id=e.pointerId||!1,e.pointerType)switch(e.pointerType){case"mouse":case"pen":case"touch":break;default:Lite.debug&&console.log("pointerType unknown "+ev.pointerType)}return void 0!==e.button&&(this.userInput_button=e.button,e.button),void 0!==e.buttons&&(this.userInput_button_s=e.buttons),this.userInput_touches=void 0!==e.changedTouches&&void 0!==e.changedTouches.length&&e.changedTouches,this.userInput_touches&&this.userInput_touches.length&&console.debug("check multiTouches",e.changedTouches),this.processMouseDown(e)}processMouseDown(e){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(e);var ref_window=this.getCanvasWindow(),x=(Canvas.active_canvas=this,e.clientX),y=e.clientY,x=(Lite.debug&&console.log("pointerevents: processMouseDown pointerId:"+e.pointerId+" which:"+e.which+" isPrimary:"+e.isPrimary+" :: x y "+x+" "+y,"previousClick",this.last_mouseclick,"diffTimeClick",this.last_mouseclick?Lite.getTime()-this.last_mouseclick:"notlast"),this.ds.viewport=this.viewport,!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3]);if(this.options.skip_events||(this.canvas.removeEventListener("pointermove",this._mousemove_callback),ref_window.document.addEventListener("pointermove",this._mousemove_callback,!0),ref_window.document.addEventListener("pointerup",this._mouseup_callback,!0)),x){var node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),skip_action=!1,y=Lite.getTime(),x=void 0===e.isPrimary||e.isPrimary,is_double_click=y-this.last_mouseclick<300&&x;if(this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&x?this.pointer_is_double=!0:this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),Lite.ContextMenu.closeAll(ref_window),!this.onMouse?.(e)){if(1!=e.which||this.userInput_isNotPrimary)if(2==e.which)if(Lite.middle_click_slot_add_default_node){if(node&&this.allow_interaction&&!skip_action&&!this.read_only&&!this.connecting_node&&!node.flags.collapsed&&!this.live_mode){var mClikSlot=!1,mClikSlot_index=!1,mClikSlot_isOut=!1;if(node.outputs)for(let i=0,l=node.outputs.length;i<l;++i){var output=node.outputs[i];let link_pos=node.getConnectionPos(!1,i);if(Lite.isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)){mClikSlot=output,mClikSlot_index=i,mClikSlot_isOut=!0;break}}if(node.inputs)for(let i=0,l=node.inputs.length;i<l;++i){input=node.inputs[i];let link_pos=node.getConnectionPos(!0,i);if(Lite.isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)){mClikSlot=input,mClikSlot_index=i,mClikSlot_isOut=!1;break}}mClikSlot&&!1!==mClikSlot_index&&(y=.5-(mClikSlot_index+1)/(mClikSlot_isOut?node.outputs:node.inputs).length,x=node.getBounding(),x=[mClikSlot_isOut?x[0]+x[2]:x[0],e.canvasY-80],this.createDefaultNodeForSlot({nodeFrom:mClikSlot_isOut?node:null,slotFrom:mClikSlot_isOut?mClikSlot_index:null,nodeTo:mClikSlot_isOut?null:node,slotTo:mClikSlot_isOut?null:mClikSlot_index,position:x,nodeType:"AUTO",posAdd:[mClikSlot_isOut?30:-30,130*-y],posSizeFix:[mClikSlot_isOut?0:-1,0]}))}}else!skip_action&&this.allow_dragcanvas&&(this.dragging_canvas=!0);else!(3==e.which||Lite.two_fingers_opens_menu&&this.userInput_isNotPrimary)||!this.allow_interaction||skip_action||this.read_only||(node&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[node.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[node.id]||this.selectNodes([node],!0):this.selectNodes([node])),this.processContextMenu(node,e));else{if(e.ctrlKey&&(this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,skip_action=!0),Lite.alt_drag_do_clone_nodes&&e.altKey&&node&&this.allow_interaction&&!skip_action&&!this.read_only){var original_node=node,x=node.clone();if(x){if(x.pos[0]+=5,x.pos[1]+=5,this.graph.add(x,!1,{doCalcSize:!1}),node=x,Lite.alt_shift_drag_connect_clone_with_input&&e.shiftKey&&original_node.inputs&&original_node.inputs.length)for(var input,ob_link,source_node,target_node,j=0;j<original_node.inputs.length;++j)(input=original_node.inputs[j])&&null!=input.link&&(ob_link=this.graph.links[input.link])&&ob_link.type!==Lite.EVENT&&(ob_link.origin_id&&(source_node=this.graph.getNodeById(ob_link.origin_id)),target_node=node,source_node)&&target_node&&source_node.connect(ob_link.origin_slot,target_node,ob_link.target_slot);skip_action=!0,block_drag_node||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=node),this.selected_nodes[node.id])||this.processNodeSelected(node,e)}}var link_info,block_drag_node,widget,y=!1;if(!node||!this.allow_interaction&&!node.flags.allow_interaction||skip_action||this.read_only){if(!skip_action){if(!this.read_only)for(let i=0;i<this.visible_links.length;++i){var link=this.visible_links[i],center=link._pos;if(!(!center||e.canvasX<center[0]-4||e.canvasX>center[0]+4||e.canvasY<center[1]-4||e.canvasY>center[1]+4)){this.showLinkMenu(link,e),this.over_link_center=null;break}}this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only&&(e.ctrlKey&&(this.dragging_rectangle=null),Lite.distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<10?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes()),is_double_click&&!this.read_only&&this.allow_searchbox&&(this.showSearchBox(e),e.preventDefault(),e.stopPropagation()),Lite.debug&&console.debug("DEBUG canvas click is_double_click,this.allow_searchbox",is_double_click,this.allow_searchbox),y=!0}}else{if(this.live_mode||node.flags.pinned||this.bringToFront(node),this.allow_interaction&&!this.connecting_node&&!node.flags.collapsed&&!this.live_mode)if(!skip_action&&!1!==node.resizable&&Lite.isInsideRectangle(e.canvasX,e.canvasY,node.pos[0]+node.size[0]-5,node.pos[1]+node.size[1]-5,10,10))this.graph.beforeChange(),this.resizing_node=node,this.canvas.style.cursor="se-resize",skip_action=!0;else{if(node.outputs)for(let i=0,l=node.outputs.length;i<l;++i){let output=node.outputs[i];var link_pos=node.getConnectionPos(!1,i);if(Lite.isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)){this.connecting_node=node,this.connecting_output=output,this.connecting_output.slot_index=i,this.connecting_pos=node.getConnectionPos(!1,i),this.connecting_slot=i,Lite.shift_click_do_break_link_from&&e.shiftKey&&node.disconnectOutput(i),is_double_click?node.onOutputDblClick?.(i,e):node.onOutputClick?.(i,e),skip_action=!0;break}}if(node.inputs)for(let i=0,l=node.inputs.length;i<l;++i){let input=node.inputs[i],link_pos=node.getConnectionPos(!0,i);Lite.isInsideRectangle(e.canvasX,e.canvasY,link_pos[0]-15,link_pos[1]-10,30,20)&&(is_double_click?node.onInputDblClick?.(i,e):node.onInputClick?.(i,e),null!==input.link&&(link_info=this.graph.links[input.link],Lite.click_do_break_link_to&&(node.disconnectInput(i),skip_action=this.dirty_bgcanvas=!0),e.shiftKey)&&(Lite.click_do_break_link_to||node.disconnectInput(i),this.connecting_node=this.graph._nodes_by_id[link_info.origin_id],this.connecting_slot=link_info.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),skip_action=this.dirty_bgcanvas=!0),skip_action||(this.connecting_node=node,this.connecting_input=input,this.connecting_input.slot_index=i,this.connecting_pos=node.getConnectionPos(!0,i),this.connecting_slot=i,skip_action=this.dirty_bgcanvas=!0))}}skip_action||(block_drag_node=!1,x=[e.canvasX-node.pos[0],e.canvasY-node.pos[1]],(widget=this.processNodeWidgets(node,this.graph_mouse,e))&&(block_drag_node=!0,this.node_widget=[node,widget]),this.allow_interaction&&is_double_click&&this.selected_nodes[node.id]&&(node.onDblClick?.(e,x,this),this.processNodeDblClicked(node),block_drag_node=!0),node.onMouseDown&&node.onMouseDown(e,x,this)?block_drag_node=!0:(node.subgraph&&!node.skip_subgraph_button&&!node.flags.collapsed&&x[0]>node.size[0]-Lite.NODE_TITLE_HEIGHT&&x[1]<0&&setTimeout(()=>{this.openSubgraph(node.subgraph)},10),this.live_mode&&(block_drag_node=y=!0)),block_drag_node?node.is_selected||this.processNodeSelected(node,e):(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=node),this.processNodeSelected(node,e)),this.dirty_canvas=!0)}!skip_action&&y&&this.allow_dragcanvas&&(this.dragging_canvas=!0)}return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=Lite.getTime(),this.last_mouse_dragging=!0,this.graph.change(),ref_window.document.activeElement&&("input"==ref_window.document.activeElement.nodeName.toLowerCase()||"textarea"==ref_window.document.activeElement.nodeName.toLowerCase())||e.preventDefault(),e.stopPropagation(),this.onMouseDown?.(e),!1}}}}processMouseMove(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){(Canvas.active_canvas=this).adjustMouseEvent(e);var mouse=[e.clientX,e.clientY],delta=(this.mouse[0]=mouse[0],this.mouse[1]=mouse[1],[mouse[0]-this.last_mouse[0],mouse[1]-this.last_mouse[1]]);if(this.last_mouse=mouse,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,!this.block_click){e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);var deltay,node=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle)this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only)this.selected_group_resizing?this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]]:(mouse=delta[0]/this.ds.scale,deltay=delta[1]/this.ds.scale,this.selected_group.move(mouse,deltay,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0)),this.dirty_bgcanvas=!0;else if(this.dragging_canvas)this.ds.offset[0]+=delta[0]/this.ds.scale,this.ds.offset[1]+=delta[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||node&&node.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(let i=0,l=this.graph._nodes.length;i<l;++i)this.graph._nodes[i].mouseOver&&node!=this.graph._nodes[i]&&(this.graph._nodes[i].mouseOver=!1,this.node_over&&this.node_over.onMouseLeave&&this.node_over.onMouseLeave(e),this.node_over=null,this.dirty_canvas=!0);if(node){if(node.redraw_on_mouse&&(this.dirty_canvas=!0),node.mouseOver||(node.mouseOver=!0,this.node_over=node,this.dirty_canvas=!0,node.onMouseEnter?.(e)),node.onMouseMove?.(e,[e.canvasX-node.pos[0],e.canvasY-node.pos[1]],this),this.connecting_node){let pos;if(this.connecting_output)pos=this._highlight_input||[0,0],this.isOverNodeBox(node,e.canvasX,e.canvasY)||(-1!=(mouse=this.isOverNodeInput(node,e.canvasX,e.canvasY,pos))&&node.inputs[mouse]?(deltay=node.inputs[mouse].type,Lite.isValidConnection(this.connecting_output.type,deltay)&&(this._highlight_input=pos,this._highlight_input_slot=node.inputs[mouse])):(this._highlight_input=null,this._highlight_input_slot=null));else if(this.connecting_input&&(pos=this._highlight_output||[0,0],this.isOverNodeBox(node,e.canvasX,e.canvasY))){let slot=this.isOverNodeOutput(node,e.canvasX,e.canvasY,pos);if(-1!=slot&&node.outputs[slot]){let slot_type=node.outputs[slot].type;Lite.isValidConnection(this.connecting_input.type,slot_type)&&(this._highlight_output=pos)}else this._highlight_output=null}}this.canvas&&(Lite.isInsideRectangle(e.canvasX,e.canvasY,node.pos[0]+node.size[0]-5,node.pos[1]+node.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var over_link=null;for(let i=0;i<this.visible_links.length;++i){var link=this.visible_links[i],center=link._pos;if(!(!center||e.canvasX<center[0]-4||e.canvasX>center[0]+4||e.canvasY<center[1]-4||e.canvasY>center[1]+4)){over_link=link;break}}over_link!=this.over_link_center&&(this.over_link_center=over_link,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=node&&this.node_capturing_input.onMouseMove&&this.node_capturing_input.onMouseMove(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var i in this.selected_nodes){i=this.selected_nodes[i];i.pos[0]+=delta[0]/this.ds.scale,i.pos[1]+=delta[1]/this.ds.scale,i.is_selected||this.processNodeSelected(i,e)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}this.resizing_node&&!this.live_mode&&(deltay=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],mouse=this.resizing_node.computeSize(),deltay[0]=Math.max(mouse[0],deltay[0]),deltay[1]=Math.max(mouse[1],deltay[1]),this.resizing_node.setSize(deltay),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0)}}return e.preventDefault(),!1}}processMouseUp(e){var is_primary=void 0===e.isPrimary||e.isPrimary;if(!is_primary)return!1;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var document=this.getCanvasWindow().document,document=((Canvas.active_canvas=this).options.skip_events||(document.removeEventListener("pointermove",this._mousemove_callback,!0),this.canvas.addEventListener("pointermove",this._mousemove_callback,!0),document.removeEventListener("pointerup",this._mouseup_callback,!0)),this.adjustMouseEvent(e),Lite.getTime());if(e.click_time=document-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(this.block_click=!1),1==e.which){this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group&&(document=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),diffy=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]),this.selected_group.move(document,diffy,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group=null),this.selected_group_resizing=!1;document=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var nodes=this.graph._nodes,node_bounding=new Float32Array(4),diffy=Math.abs(this.dragging_rectangle[2]),h=Math.abs(this.dragging_rectangle[3]),startx=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-diffy:this.dragging_rectangle[0],starty=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-h:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=startx,this.dragging_rectangle[1]=starty,this.dragging_rectangle[2]=diffy,this.dragging_rectangle[3]=h,!document||10<diffy&&10<h){var to_select=[];for(let i=0;i<nodes.length;++i){var nodeX=nodes[i];nodeX.getBounding(node_bounding),Lite.overlapBounding(this.dragging_rectangle,node_bounding)&&to_select.push(nodeX)}to_select.length&&this.selectNodes(to_select,e.shiftKey)}else this.selectNodes([document],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;startx=(this.connecting_output||this.connecting_input).type;if(document=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes)){let slot;this.connecting_output?-1!=(slot=this.isOverNodeInput(document,e.canvasX,e.canvasY))?this.connecting_node.connect(this.connecting_slot,document,slot):this.connecting_node.connectByType(this.connecting_slot,document,startx):this.connecting_input&&(-1!=(slot=this.isOverNodeOutput(document,e.canvasX,e.canvasY))?document.connect(slot,this.connecting_node,this.connecting_slot):this.connecting_node.connectByTypeOutput(this.connecting_slot,document,startx))}else Lite.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:e}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1}else this.resizing_node?(this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null):this.node_dragged?((document=this.node_dragged)&&e.click_time<300&&Lite.isInsideRectangle(e.canvasX,e.canvasY,document.pos[0],document.pos[1]-Lite.NODE_TITLE_HEIGHT,Lite.NODE_TITLE_HEIGHT,Lite.NODE_TITLE_HEIGHT)&&document.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.onNodeMoved?.(this.node_dragged),this.graph.onGraphChanged({action:"nodeDrag",doSave:!0}),this.graph.afterChange(this.node_dragged),this.node_dragged=null):(!(document=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes))&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.onMouseUp&&this.node_over.onMouseUp(e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.onMouseUp&&this.node_capturing_input.onMouseUp(e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]]))}else(2==e.which||3==e.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return is_primary&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),e.stopPropagation(),e.preventDefault(),!1}}processMouseWheel=e=>{if(this.graph&&this.allow_dragcanvas){var delta=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail,x=(this.adjustMouseEvent(e),e.clientX),y=e.clientY;if(!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3])return x=this.ds.scale,0<delta?x*=1.1:delta<0&&(x*=1/1.1),this.ds.changeScale(x,[e.clientX,e.clientY]),this.graph.change(),e.preventDefault(),!1}};isOverNodeBox(node,canvasx,canvasy){var title_height=Lite.NODE_TITLE_HEIGHT;return!!Lite.isInsideRectangle(canvasx,canvasy,node.pos[0]+2,node.pos[1]+2-title_height,title_height-4,title_height-4)}isOverNodeInput(node,canvasx,canvasy,slot_pos){if(node.inputs)for(let i=0,l=node.inputs.length;i<l;++i){var link_pos=node.getConnectionPos(!0,i);if(node.horizontal?Lite.isInsideRectangle(canvasx,canvasy,link_pos[0]-5,link_pos[1]-10,10,20):Lite.isInsideRectangle(canvasx,canvasy,link_pos[0]-10,link_pos[1]-5,40,10))return slot_pos&&(slot_pos[0]=link_pos[0],slot_pos[1]=link_pos[1]),i}return-1}isOverNodeOutput(node,canvasx,canvasy,slot_pos){if(node.outputs)for(let i=0,l=node.outputs.length;i<l;++i){var link_pos=node.getConnectionPos(!1,i);if(node.horizontal?Lite.isInsideRectangle(canvasx,canvasy,link_pos[0]-5,link_pos[1]-10,10,20):Lite.isInsideRectangle(canvasx,canvasy,link_pos[0]-10,link_pos[1]-5,40,10))return slot_pos&&(slot_pos[0]=link_pos[0],slot_pos[1]=link_pos[1]),i}return-1}processKey=e=>{if(this.graph){var block_default=!1;if("input"!=e.target.localName){if("keydown"==e.type){if(32==e.keyCode&&(block_default=this.dragging_canvas=!0),27==e.keyCode&&(this.node_panel&&this.node_panel.close(),this.options_panel&&this.options_panel.close(),block_default=!0),65==e.keyCode&&e.ctrlKey&&(this.selectNodes(),block_default=!0),67!==e.keyCode||!e.metaKey&&!e.ctrlKey||e.shiftKey||this.selected_nodes&&(this.copyToClipboard(),block_default=!0),86===e.keyCode&&(e.metaKey||e.ctrlKey)&&this.pasteFromClipboard(e.shiftKey),(46==e.keyCode||Lite.backspace_delete&&8==e.keyCode)&&"input"!=e.target.localName&&"textarea"!=e.target.localName&&(this.deleteSelectedNodes(),block_default=!0),Lite.actionHistory_enabled&&(89==e.keyCode&&e.ctrlKey||90==e.keyCode&&e.ctrlKey&&e.shiftKey?this.graph.actionHistoryForward():90==e.keyCode&&e.ctrlKey&&this.graph.actionHistoryBack()),Lite.debug&&console.debug("Canvas keydown "+e.keyCode),this.selected_nodes)for(var i in this.selected_nodes)this.selected_nodes[i].onKeyDown?.(e)}else if("keyup"==e.type&&(32==e.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(let i in this.selected_nodes)this.selected_nodes[i].onKeyUp?.(e);return this.graph.change(),block_default?(e.preventDefault(),e.stopImmediatePropagation(),!1):void 0}}};copyToClipboard(){var i,clipboard_info={nodes:[],links:[]},index=0,selected_nodes_array=[];for(i in this.selected_nodes){var node=this.selected_nodes[i];!1!==node.clonable&&(node._relative_id=index,selected_nodes_array.push(node),index+=1)}for(let i=0;i<selected_nodes_array.length;++i){let node=selected_nodes_array[i];if(!1!==node.clonable){var cloned=node.clone();if(cloned){if(clipboard_info.nodes.push(cloned.serialize()),node.inputs&&node.inputs.length)for(var j=0;j<node.inputs.length;++j){var target_node,input=node.inputs[j];input&&null!=input.link&&(input=this.graph.links[input.link])&&(target_node=this.graph.getNodeById(input.origin_id))&&clipboard_info.links.push([target_node._relative_id,input.origin_slot,node._relative_id,input.target_slot,target_node.id])}}else console.warn("node type not found: "+node.type)}}localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(clipboard_info))}pasteFromClipboard(isConnectUnselected=!1){if(Lite.ctrl_shift_v_paste_connect_unselected_outputs||!isConnectUnselected){var data=localStorage.getItem("litegrapheditor_clipboard");if(data){this.graph.beforeChange();var clipboard_info=JSON.parse(data),posMin=!1,posMinIndexes=!1;for(let i=0;i<clipboard_info.nodes.length;++i)posMin?(posMin[0]>clipboard_info.nodes[i].pos[0]&&(posMin[0]=clipboard_info.nodes[i].pos[0],posMinIndexes[0]=i),posMin[1]>clipboard_info.nodes[i].pos[1]&&(posMin[1]=clipboard_info.nodes[i].pos[1],posMinIndexes[1]=i)):(posMin=[clipboard_info.nodes[i].pos[0],clipboard_info.nodes[i].pos[1]],posMinIndexes=[i,i]);var nodes=[];for(let i=0;i<clipboard_info.nodes.length;++i){var node_data=clipboard_info.nodes[i],node=Lite.createNode(node_data.type);node&&(node.configure(node_data),node.pos[0]+=this.graph_mouse[0]-posMin[0],node.pos[1]+=this.graph_mouse[1]-posMin[1],this.graph.add(node,{doProcessChange:!1}),nodes.push(node))}for(let i=0;i<clipboard_info.links.length;++i){var link_info=clipboard_info.links[i],origin_node=void 0,origin_node_relative_id=link_info[0],origin_node_relative_id=(null!=origin_node_relative_id?origin_node=nodes[origin_node_relative_id]:Lite.ctrl_shift_v_paste_connect_unselected_outputs&&isConnectUnselected&&(origin_node_relative_id=link_info[4])&&(origin_node=this.graph.getNodeById(origin_node_relative_id)),nodes[link_info[2]]);origin_node&&origin_node_relative_id?origin_node.connect(link_info[1],origin_node_relative_id,link_info[3]):console.warn("Warning, nodes missing on pasting")}this.selectNodes(nodes),this.graph.onGraphChanged({action:"paste",doSave:!0}),this.graph.afterChange()}}}processDrop=e=>{e.preventDefault(),this.adjustMouseEvent(e);var x=e.clientX,y=e.clientY;if(!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3]){x=e.localX,y=e.localY;if(!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&y>=this.viewport[1]&&y<this.viewport[1]+this.viewport[3]){var x=[e.canvasX,e.canvasY],node=this.graph?this.graph.getNodeOnPos(x[0],x[1]):null;if(node){if(node.onDropFile||node.onDropData){var files=e.dataTransfer.files;if(files&&files.length)for(let i=0;i<files.length;i++){var reader,type,file=e.dataTransfer.files[0],filename=file.name;node.onDropFile&&node.onDropFile(file),node.onDropData&&((reader=new FileReader).onload=function(event){event=event.target.result;node.onDropData(event,filename,file)},"text"==(type=file.type.split("/")[0])||""==type?reader.readAsText(file):"image"==type?reader.readAsDataURL(file):reader.readAsArrayBuffer(file))}}return!(!node.onDropItem||!node.onDropItem(event))||!!this.onDropItem&&this.onDropItem(event)}y=null,(y=this.onDropItem?this.onDropItem(event):y)||this.checkDropItem(e)}}};checkDropItem(e){var file,ext;e.dataTransfer.files.length&&(file=e.dataTransfer.files[0],ext=Canvas.getFileExtension(file.name).toLowerCase(),ext=Lite.node_types_by_file_extension[ext])&&(this.graph.beforeChange(),(ext=Lite.createNode(ext.type)).pos=[e.canvasX,e.canvasY],this.graph.add(ext,!1,{doProcessChange:!1}),ext.onDropFile?.(file),this.graph.onGraphChanged({action:"fileDrop",doSave:!0}),this.graph.afterChange())}processNodeDblClicked(n){this.onShowNodePanel?this.onShowNodePanel(n):this.showShowNodePanel(n),this.onNodeDblClicked?.(n),this.setDirty(!0)}processNodeSelected(node,e){this.selectNode(node,e&&(e.shiftKey||e.ctrlKey||this.multi_select)),this.onNodeSelected?.(node)}selectNode(node,add_to_current_selection){null==node?this.deselectAllNodes():this.selectNodes([node],add_to_current_selection)}selectNodes(nodes,add_to_current_selection){add_to_current_selection||this.deselectAllNodes(),"string"==typeof(nodes=nodes||this.graph._nodes)&&(nodes=[nodes]),Object.values(nodes).forEach(node=>{node.is_selected?this.deselectNode(node):(node.is_selected=!0,(this.selected_nodes[node.id]=node).onSelected?.(),node.inputs?.forEach(input=>{this.highlighted_links[input.link]=!0}),node.outputs?.forEach(out=>{out.links?.forEach(link=>{this.highlighted_links[link]=!0})}))}),this.onSelectionChange?.(this.selected_nodes),this.setDirty(!0)}deselectNode(node){node.is_selected&&(node.onDeselected?.(),node.is_selected=!1,this.onNodeDeselected?.(node),node.inputs?.forEach(input=>{delete this.highlighted_links?.[input.link]}),node.outputs?.forEach(out=>{out.links?.forEach(link=>delete this.highlighted_links?.[link])}))}deselectAllNodes(){this.graph&&(this.graph._nodes?.forEach(node=>{node.is_selected&&(node.onDeselected?.(),node.is_selected=!1,this.onNodeDeselected?.(node))}),this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.onSelectionChange?.(this.selected_nodes),this.setDirty(!0))}deleteSelectedNodes(){for(var i in this.graph.beforeChange(),this.selected_nodes){var input_link,output_link,input_node,output_node,i=this.selected_nodes[i];i.block_delete||(i.inputs&&i.inputs.length&&i.outputs&&i.outputs.length&&Lite.isValidConnection(i.inputs[0].type,i.outputs[0].type)&&i.inputs[0].link&&i.outputs[0].links&&i.outputs[0].links.length&&(input_link=i.graph.links[i.inputs[0].link],output_link=i.graph.links[i.outputs[0].links[0]],input_node=i.getInputNode(0),output_node=i.getOutputNodes(0)[0],input_node)&&output_node&&input_node.connect(input_link.origin_slot,output_node,output_link.target_slot),this.graph.remove(i),this.onNodeDeselected&&this.onNodeDeselected(i))}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}centerOnNode(node){this.ds.offset[0]=-node.pos[0]-.5*node.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-node.pos[1]-.5*node.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)}adjustMouseEvent(e){var b,clientX_rel=0,clientY_rel=0;clientY_rel=this.canvas?(b=this.canvas.getBoundingClientRect(),clientX_rel=e.clientX-b.left,e.clientY-b.top):(clientX_rel=e.clientX,e.clientY),this.last_mouse_position[0]=clientX_rel,this.last_mouse_position[1]=clientY_rel,e.canvasX=clientX_rel/this.ds.scale-this.ds.offset[0],e.canvasY=clientY_rel/this.ds.scale-this.ds.offset[1]}setZoom(value,zooming_center){this.ds.changeScale(value,zooming_center),this.dirty_canvas=!0,this.dirty_bgcanvas=!0}convertOffsetToCanvas(pos,out){return this.ds.convertOffsetToCanvas(pos,out)}convertCanvasToOffset(pos,out){return this.ds.convertCanvasToOffset(pos,out)}convertEventToCanvasOffset(e){var rect=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-rect.left,e.clientY-rect.top])}bringToFront(node){var i=this.graph._nodes.indexOf(node);-1!=i&&(this.graph._nodes.splice(i,1),this.graph._nodes.push(node))}sendToBack(node){var i=this.graph._nodes.indexOf(node);-1!=i&&(this.graph._nodes.splice(i,1),this.graph._nodes.unshift(node))}computeVisibleNodes(nodes,out){for(var visible_nodes=out||[],i=visible_nodes.length=0,l=(nodes=nodes||this.graph._nodes).length;i<l;++i){var n=nodes[i];(!this.live_mode||n.onDrawBackground||n.onDrawForeground)&&Lite.overlapBounding(this.visible_area,n.getBounding(temp,!0))&&visible_nodes.push(n)}return visible_nodes}draw(force_canvas,force_bgcanvas){var now;this.canvas&&0!=this.canvas.width&&0!=this.canvas.height&&(now=Lite.getTime(),this.render_time=.001*(now-this.last_draw_time),this.last_draw_time=now,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||force_bgcanvas||this.always_render_background||this.graph&&this.graph._last_trigger_time&&now-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas(),(force_bgcanvas=this.dirty_canvas||force_canvas)&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1,this.ds.scale<.7?force_bgcanvas&&(now=this.low_quality_rendering_threshold,this.fps<45?(this.low_quality_rendering_counter+=45/this.fps,this.low_quality_rendering_counter=Math.min(this.low_quality_rendering_counter,2*now)):(this.low_quality_rendering_counter-=this.fps/45*.01,this.low_quality_rendering_counter=Math.max(this.low_quality_rendering_counter,0))):this.low_quality_rendering_counter=0)}drawFrontCanvas(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var ctx=this.ctx;if(ctx){var canvas=this.canvas,area=(ctx.start2D&&!this.viewport&&(ctx.start2D(),ctx.restore(),ctx.setTransform(1,0,0,1,0,0)),this.viewport||this.dirty_area);if(area&&(ctx.save(),ctx.beginPath(),ctx.rect(area[0],area[1],area[2],area[3]),ctx.clip()),this.clear_background&&(area?ctx.clearRect(area[0],area[1],area[2],area[3]):ctx.clearRect(0,0,canvas.width,canvas.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():ctx.drawImage(this.bgcanvas,0,0),this.onRender?.(canvas,ctx),this.show_info&&this.renderInfo(ctx,area?area[0]:0,area?area[1]:0),this.graph){ctx.save(),this.ds.toCanvasContext(ctx);var visible_nodes=this.computeVisibleNodes(null,this.visible_nodes);for(let i=0;i<visible_nodes.length;++i){var node=visible_nodes[i];ctx.save(),ctx.translate(node.pos[0],node.pos[1]),this.drawNode(node,ctx),ctx.restore()}if(this.render_execution_order&&this.drawExecutionOrder(ctx),!this.graph.config.links_ontop||this.live_mode||this.drawConnections(ctx),null!=this.connecting_pos){ctx.lineWidth=this.connections_width;var shape,link_color=null,canvas=this.connecting_output||this.connecting_input,connType=canvas.type,connDir=canvas.dir,canvas=(null==connDir&&(connDir=this.connecting_output?this.connecting_node.horizontal?Lite.DOWN:Lite.RIGHT:this.connecting_node.horizontal?Lite.UP:Lite.LEFT),canvas.shape);switch(connType){case Lite.EVENT:case Lite.ACTION:link_color=Lite.EVENT_LINK_COLOR;break;default:link_color=Lite.CONNECTING_LINK_COLOR}this.renderLink(ctx,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,link_color,connDir,Lite.CENTER),ctx.beginPath(),connType===Lite.EVENT||connType===Lite.ACTION||canvas===Lite.BOX_SHAPE?(ctx.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),ctx.fill(),ctx.beginPath(),ctx.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):canvas===Lite.ARROW_SHAPE?(ctx.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),ctx.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),ctx.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),ctx.closePath()):(ctx.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),ctx.fill(),ctx.fillStyle="#ffcc00",this._highlight_input&&(ctx.beginPath(),(shape=this._highlight_input_slot.shape)===Lite.ARROW_SHAPE?(ctx.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),ctx.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),ctx.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),ctx.closePath()):ctx.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),ctx.fill()),this._highlight_output&&(ctx.beginPath(),shape===Lite.ARROW_SHAPE?(ctx.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),ctx.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),ctx.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),ctx.closePath()):ctx.arc(this._highlight_output[0],this._highlight_output[1],6,0,2*Math.PI),ctx.fill())}this.dragging_rectangle&&(ctx.strokeStyle="#FFF",ctx.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(ctx,this.over_link_center):this.onDrawLinkTooltip?.(ctx,null),this.onDrawForeground?.(ctx,this.visible_rect),ctx.restore()}this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(ctx),this.onDrawOverlay?.(ctx),area&&ctx.restore(),ctx.finish2D?.()}}drawSubgraphPanel(ctx){var subnode,subgraph=this.graph;subgraph&&((subnode=subgraph._subgraph_node)?(this.drawSubgraphPanelLeft(subgraph,subnode,ctx),this.drawSubgraphPanelRight(subgraph,subnode,ctx)):console.warn("subgraph without subnode"))}drawSubgraphPanelLeft(subgraph,subnode,ctx){var num=subnode.inputs?subnode.inputs.length:0,w=200,h=Math.floor(1.6*Lite.NODE_SLOT_HEIGHT);if(ctx.fillStyle="#111",ctx.globalAlpha=.8,ctx.beginPath(),ctx.roundRect(10,10,w,(num+1)*h+50,[8]),ctx.fill(),ctx.globalAlpha=1,ctx.fillStyle="#888",ctx.font="14px Arial",ctx.textAlign="left",ctx.fillText("Graph Inputs",20,34),this.drawButton(180,20,20,20,"X","#151515"))this.closeSubgraph();else{var y=50;if(ctx.font="14px Arial",subnode.inputs)for(var i=0;i<subnode.inputs.length;++i){var type,newnode,input=subnode.inputs[i];input.not_subgraph_input||(this.drawButton(20,y+2,180,h-2)&&(type=subnode.constructor.input_node_type||"graph/input",this.graph.beforeChange(),(newnode=Lite.createNode(type))?(subgraph.add(newnode,!1,{doProcessChange:!1}),this.block_click=!1,this.last_click_position=null,this.selectNodes([newnode]),this.node_dragged=newnode,this.dragging_canvas=!1,newnode.setProperty("name",input.name),newnode.setProperty("type",input.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",type)),ctx.fillStyle="#9C9",ctx.beginPath(),ctx.arc(184,y+.5*h,5,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#AAA",ctx.fillText(input.name,30,y+.75*h),ctx.fillStyle="#777",ctx.fillText(input.type,130,y+.75*h),y+=h)}this.drawButton(20,y+2,180,h-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(subnode)}}drawSubgraphPanelRight(subgraph,subnode,ctx){var num=subnode.outputs?subnode.outputs.length:0,canvas_w=this.bgcanvas.width,w=200,h=Math.floor(1.6*Lite.NODE_SLOT_HEIGHT),num=(ctx.fillStyle="#111",ctx.globalAlpha=.8,ctx.beginPath(),ctx.roundRect(canvas_w-w-10,10,w,(num+1)*h+50,[8]),ctx.fill(),ctx.globalAlpha=1,ctx.fillStyle="#888",ctx.font="14px Arial",ctx.textAlign="left",ctx.measureText("Graph Outputs").width);if(ctx.fillText("Graph Outputs",canvas_w-num-20,34),this.drawButton(canvas_w-w,20,20,20,"X","#151515"))this.closeSubgraph();else{var y=50;if(ctx.font="14px Arial",subnode.outputs)for(var i=0;i<subnode.outputs.length;++i){var type,newnode,output=subnode.outputs[i];output.not_subgraph_input||(this.drawButton(canvas_w-w,y+2,180,h-2)&&(type=subnode.constructor.output_node_type||"graph/output",this.graph.beforeChange(),(newnode=Lite.createNode(type))?(subgraph.add(newnode,!1,{doProcessChange:!1}),this.block_click=!1,this.last_click_position=null,this.selectNodes([newnode]),this.node_dragged=newnode,this.dragging_canvas=!1,newnode.setProperty("name",output.name),newnode.setProperty("type",output.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):console.error("graph input node not found:",type)),ctx.fillStyle="#9C9",ctx.beginPath(),ctx.arc(canvas_w-w+16,y+.5*h,5,0,2*Math.PI),ctx.fill(),ctx.fillStyle="#AAA",ctx.fillText(output.name,canvas_w-w+30,y+.75*h),ctx.fillStyle="#777",ctx.fillText(output.type,canvas_w-w+130,y+.75*h),y+=h)}this.drawButton(canvas_w-w,y+2,180,h-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(subnode)}}drawButton(x,y,w,h,text,bgcolor,hovercolor,textcolor){var ctx=this.ctx,pos=(bgcolor=bgcolor||Lite.NODE_DEFAULT_COLOR,hovercolor=hovercolor||"#555",textcolor=textcolor||Lite.NODE_TEXT_COLOR,this.ds.convertOffsetToCanvas(this.graph_mouse)),hover=Lite.isInsideRectangle(pos[0],pos[1],x,y,w,h),rect=((pos=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null)&&(rect=this.canvas.getBoundingClientRect(),pos[0]-=rect.left,pos[1]-=rect.top),pos&&Lite.isInsideRectangle(pos[0],pos[1],x,y,w,h)),pos=(ctx.fillStyle=hover?hovercolor:bgcolor,rect&&(ctx.fillStyle="#AAA"),ctx.beginPath(),ctx.roundRect(x,y,w,h,[4]),ctx.fill(),null!=text&&text.constructor==String&&(ctx.fillStyle=textcolor,ctx.textAlign="center",ctx.font=(.65*h|0)+"px Arial",ctx.fillText(text,x+.5*w,y+.75*h),ctx.textAlign="left"),rect&&!this.block_click);return rect&&this.blockClick(),pos}isAreaClicked(x,y,w,h,hold_click){var pos=this.last_click_position,pos=pos&&Lite.isInsideRectangle(pos[0],pos[1],x,y,w,h),x=pos&&!this.block_click;return pos&&hold_click&&this.blockClick(),x}renderInfo(ctx,x,y){x=x||10,y=y||this.canvas.height-80,ctx.save(),ctx.translate(x,y),ctx.font="10px Arial",ctx.fillStyle="#888",ctx.textAlign="left",this.graph?(ctx.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),ctx.fillText("I: "+this.graph.iteration,5,26),ctx.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),ctx.fillText("V: "+this.graph._version,5,52),ctx.fillText("FPS:"+this.fps.toFixed(2),5,65)):ctx.fillText("No graph selected",5,13),ctx.restore()}drawBackCanvas(){var canvas=this.bgcanvas,ctx=(this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d")),this.bgctx),viewport=(ctx.start&&ctx.start(),this.viewport||[0,0,ctx.canvas.width,ctx.canvas.height]);if(this.clear_background&&ctx.clearRect(viewport[0],viewport[1],viewport[2],viewport[3]),this._graph_stack&&this._graph_stack.length){ctx.save();viewport=this.graph._subgraph_node;ctx.strokeStyle=viewport.bgcolor,ctx.lineWidth=10,ctx.strokeRect(1,1,canvas.width-2,canvas.height-2),ctx.lineWidth=1,ctx.font="40px Arial",ctx.textAlign="center",ctx.fillStyle=viewport.bgcolor||"#AAA";let title="";this._graph_stack.slice(1).forEach((item,index)=>{title+=item._subgraph_node.getTitle()+" "+(index<this._graph_stack.length-2?">> ":"")}),ctx.fillText(title+viewport.getTitle(),.5*canvas.width,40),ctx.restore()}var that,viewport=!1;this.onRenderBackground&&(viewport=this.onRenderBackground(canvas,ctx)),this.viewport||(ctx.restore(),ctx.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph&&(ctx.save(),this.ds.toCanvasContext(ctx),this.ds.scale<1.5&&!viewport&&this.clear_background_color&&(ctx.fillStyle=this.clear_background_color,ctx.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&.5<this.ds.scale&&!viewport&&(this.zoom_modify_alpha?ctx.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:ctx.globalAlpha=this.editor_alpha,ctx.imageSmoothingEnabled=ctx.imageSmoothingEnabled=!1,this._bg_img&&this._bg_img.name==this.background_image||(this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image,(that=this)._bg_img.onload=function(){that.draw(!0,!0)}),(viewport=null)==this._pattern&&0<this._bg_img.width?(viewport=ctx.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=viewport):viewport=this._pattern,viewport&&(ctx.fillStyle=viewport,ctx.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),ctx.fillStyle="transparent"),ctx.globalAlpha=1,ctx.imageSmoothingEnabled=ctx.imageSmoothingEnabled=!0),this.graph._groups.length&&!this.live_mode&&this.drawGroups(canvas,ctx),this.onDrawBackground?.(ctx,this.visible_area),this.onBackgroundRender&&(console.error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(ctx.strokeStyle="#235",ctx.strokeRect(0,0,canvas.width,canvas.height)),this.render_connections_shadows?(ctx.shadowColor="#000",ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.shadowBlur=6):ctx.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(ctx),ctx.shadowColor="rgba(0,0,0,0)",ctx.restore()),ctx.finish?.(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(node,ctx){var color=(this.current_node=node).color||node.constructor.color||Lite.NODE_DEFAULT_COLOR,bgcolor=node.bgcolor||node.constructor.bgcolor||Lite.NODE_DEFAULT_BGCOLOR,low_quality=this.ds.scale<.6;if(this.live_mode)node.flags.collapsed||(ctx.shadowColor="transparent",node.onDrawForeground?.(ctx,this,this.canvas));else{var editor_alpha=this.editor_alpha;if(ctx.globalAlpha=editor_alpha,this.render_shadows&&!low_quality?(ctx.shadowColor=Lite.DEFAULT_SHADOW_COLOR,ctx.shadowOffsetX=2*this.ds.scale,ctx.shadowOffsetY=2*this.ds.scale,ctx.shadowBlur=3*this.ds.scale):ctx.shadowColor="transparent",!node.flags.collapsed||!node.onDrawCollapsed?.(ctx,this)){var doStroke,title,shape=node._shape||Lite.BOX_SHAPE,size=temp_vec2,horizontal=(temp_vec2.set(node.size),node.horizontal),render_text=(node.flags.collapsed&&(ctx.font=this.inner_text_font,null!=(title=node.getTitle?node.getTitle():node.title))&&(node._collapsed_width=Math.min(node.size[0],ctx.measureText(title).width+2*Lite.NODE_TITLE_HEIGHT),size[0]=node._collapsed_width,size[1]=0),(node.clip_area||this.clip_all_nodes)&&(ctx.save(),ctx.beginPath(),shape==Lite.BOX_SHAPE?ctx.rect(0,0,size[0],size[1]):shape==Lite.ROUND_SHAPE?ctx.roundRect(0,0,size[0],size[1],[10]):shape==Lite.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0],0,2*Math.PI),ctx.clip()),node.has_errors&&(bgcolor="red"),this.drawNodeShape(node,ctx,size,color,bgcolor,node.is_selected,node.mouseOver),ctx.shadowColor="transparent",node.onDrawForeground?.(ctx,this,this.canvas),Lite.show_node_tooltip&&node.mouseOver&&node.is_selected&&(!this.selected_nodes||Object.keys(this.selected_nodes).length<=1)&&this.drawNodeTooltip(ctx,node),ctx.textAlign=horizontal?"center":"left",ctx.font=this.inner_text_font,!this.lowQualityRenderingRequired(.6)),out_slot=this.connecting_output,in_slot=this.connecting_input,max_y=(ctx.lineWidth=1,0),slot_pos=new Float32Array(2);if(node.flags.collapsed){if(this.render_collapsed_slots){var input_slot=null,output_slot=null;if(node.inputs)for(let i=0;i<node.inputs.length;i++){var slot=node.inputs[i];if(null!=slot.link){input_slot=slot;break}}if(node.outputs)for(let i=0;i<node.outputs.length;i++)(slot=node.outputs[i]).links&&slot.links.length&&(output_slot=slot);if(input_slot){let x=0,y=-.5*Lite.NODE_TITLE_HEIGHT;horizontal&&(x=.5*node._collapsed_width,y=-Lite.NODE_TITLE_HEIGHT),ctx.fillStyle="#686",ctx.beginPath(),slot.type===Lite.EVENT||slot.type===Lite.ACTION||slot.shape===Lite.BOX_SHAPE?ctx.rect(x-7+.5,y-4,14,8):slot.shape===Lite.ARROW_SHAPE?(ctx.moveTo(x+8,y),ctx.lineTo(x+-4,y-4),ctx.lineTo(x+-4,y+4),ctx.closePath()):ctx.arc(x,y,4,0,2*Math.PI),ctx.fill()}if(output_slot){let x=node._collapsed_width,y=-.5*Lite.NODE_TITLE_HEIGHT;horizontal&&(x=.5*node._collapsed_width,y=0),ctx.fillStyle="#686",ctx.strokeStyle="black",ctx.beginPath(),slot.type===Lite.EVENT||slot.type===Lite.ACTION||slot.shape===Lite.BOX_SHAPE?ctx.rect(x-7+.5,y-4,14,8):slot.shape===Lite.ARROW_SHAPE?(ctx.moveTo(x+6,y),ctx.lineTo(x-6,y-4),ctx.lineTo(x-6,y+4),ctx.closePath()):ctx.arc(x,y,4,0,2*Math.PI),ctx.fill()}}}else{if(node.inputs)for(let i=0;i<node.inputs.length;i++){let slot=node.inputs[i];var slot_type=slot.type;let slot_shape=slot.shape;ctx.globalAlpha=editor_alpha,this.connecting_output&&!Lite.isValidConnection(slot.type,out_slot.type)&&(ctx.globalAlpha=.4*editor_alpha),ctx.fillStyle=null!=slot.link?slot.color_on||this.default_connection_color_byType[slot_type]||this.default_connection_color.input_on:slot.color_off||this.default_connection_color_byTypeOff[slot_type]||this.default_connection_color_byType[slot_type]||this.default_connection_color.input_off;var pos=node.getConnectionPos(!0,i,slot_pos);pos[0]-=node.pos[0],pos[1]-=node.pos[1],max_y<pos[1]+.5*Lite.NODE_SLOT_HEIGHT&&(max_y=pos[1]+.5*Lite.NODE_SLOT_HEIGHT),ctx.beginPath(),"array"==slot_type?slot_shape=Lite.GRID_SHAPE:"onTrigger"==slot.name||"onExecuted"==slot.name?slot_shape=Lite.ARROW_SHAPE:slot_type!==Lite.EVENT&&slot_type!==Lite.ACTION||(slot_shape=Lite.BOX_SHAPE),doStroke=!0,slot_shape===Lite.BOX_SHAPE?horizontal?ctx.rect(pos[0]-5+.5,pos[1]-8+.5,10,14):ctx.rect(pos[0]-6+.5,pos[1]-5+.5,14,10):slot_shape===Lite.ARROW_SHAPE?(ctx.moveTo(pos[0]+8,pos[1]+.5),ctx.lineTo(pos[0]-4,pos[1]+6+.5),ctx.lineTo(pos[0]-4,pos[1]-6+.5),ctx.closePath()):slot_shape===Lite.GRID_SHAPE?(ctx.rect(pos[0]-4,pos[1]-4,2,2),ctx.rect(pos[0]-1,pos[1]-4,2,2),ctx.rect(pos[0]+2,pos[1]-4,2,2),ctx.rect(pos[0]-4,pos[1]-1,2,2),ctx.rect(pos[0]-1,pos[1]-1,2,2),ctx.rect(pos[0]+2,pos[1]-1,2,2),ctx.rect(pos[0]-4,pos[1]+2,2,2),ctx.rect(pos[0]-1,pos[1]+2,2,2),ctx.rect(pos[0]+2,pos[1]+2,2,2),doStroke=!1):low_quality?ctx.rect(pos[0]-4,pos[1]-4,8,8):ctx.arc(pos[0],pos[1],4,0,2*Math.PI),ctx.fill(),render_text&&"onTrigger"!=slot.name&&"onExecuted"!=slot.name&&(slot_type=null!=slot.label?slot.label:slot.name)&&(ctx.fillStyle=Lite.NODE_TEXT_COLOR,horizontal||slot.dir==Lite.UP?ctx.fillText(slot_type,pos[0],pos[1]-10):ctx.fillText(slot_type,pos[0]+10,pos[1]+5))}if(ctx.textAlign=horizontal?"center":"right",ctx.strokeStyle="black",node.outputs)for(let i=0;i<node.outputs.length;i++){let slot=node.outputs[i],slot_type=slot.type,slot_shape=slot.shape,pos=(this.connecting_input&&!Lite.isValidConnection(slot_type,in_slot.type)&&(ctx.globalAlpha=.4*editor_alpha),node.getConnectionPos(!1,i,slot_pos));if(pos[0]-=node.pos[0],pos[1]-=node.pos[1],max_y<pos[1]+.5*Lite.NODE_SLOT_HEIGHT&&(max_y=pos[1]+.5*Lite.NODE_SLOT_HEIGHT),ctx.fillStyle=slot.links&&slot.links.length?slot.color_on||this.default_connection_color_byType[slot_type]||this.default_connection_color.output_on:slot.color_off||this.default_connection_color_byTypeOff[slot_type]||this.default_connection_color_byType[slot_type]||this.default_connection_color.output_off,ctx.beginPath(),"array"==slot_type?slot_shape=Lite.GRID_SHAPE:"onTrigger"==slot.name||"onExecuted"==slot.name?slot_shape=Lite.ARROW_SHAPE:slot_type!==Lite.EVENT&&slot_type!==Lite.ACTION||(slot_shape=Lite.BOX_SHAPE),doStroke=!0,slot_shape===Lite.BOX_SHAPE?horizontal?ctx.rect(pos[0]-5+.5,pos[1]-8+.5,10,14):ctx.rect(pos[0]-6+.5,pos[1]-5+.5,14,10):slot_shape===Lite.ARROW_SHAPE?(ctx.moveTo(pos[0]+8,pos[1]+.5),ctx.lineTo(pos[0]-4,pos[1]+6+.5),ctx.lineTo(pos[0]-4,pos[1]-6+.5),ctx.closePath()):slot_shape===Lite.GRID_SHAPE?(ctx.rect(pos[0]-4,pos[1]-4,2,2),ctx.rect(pos[0]-1,pos[1]-4,2,2),ctx.rect(pos[0]+2,pos[1]-4,2,2),ctx.rect(pos[0]-4,pos[1]-1,2,2),ctx.rect(pos[0]-1,pos[1]-1,2,2),ctx.rect(pos[0]+2,pos[1]-1,2,2),ctx.rect(pos[0]-4,pos[1]+2,2,2),ctx.rect(pos[0]-1,pos[1]+2,2,2),ctx.rect(pos[0]+2,pos[1]+2,2,2),doStroke=!1):low_quality?ctx.rect(pos[0]-4,pos[1]-4,8,8):ctx.arc(pos[0],pos[1],4,0,2*Math.PI),ctx.fill(),!low_quality&&doStroke&&ctx.stroke(),render_text&&"onTrigger"!=slot.name&&"onExecuted"!=slot.name){let text=null!=slot.label?slot.label:slot.name;text&&(ctx.fillStyle=Lite.NODE_TEXT_COLOR,horizontal||slot.dir==Lite.DOWN?ctx.fillText(text,pos[0],pos[1]-8):ctx.fillText(text,pos[0]-10,pos[1]+5))}}ctx.textAlign="left",ctx.globalAlpha=1,node.widgets&&(title=max_y,(horizontal||node.widgets_up)&&(title=2),null!=node.widgets_start_y&&(title=node.widgets_start_y),this.drawNodeWidgets(node,title,ctx,this.node_widget&&this.node_widget[0]==node?this.node_widget[1]:null))}(node.clip_area||this.clip_all_nodes)&&ctx.restore(),ctx.globalAlpha=1}}}drawNodeTooltip(ctx,node){var pos,size,w,h,text;node&&ctx?((text=null!=node.properties.tooltip?node.properties.tooltip:"")&&""!=text||Lite.show_node_tooltip_use_descr_property&&node.constructor.desc&&(text=node.constructor.desc),(text=(text+"").trim())&&""!=text?(pos=[0,-Lite.NODE_TITLE_HEIGHT],size=node.flags.collapsed?[Lite.NODE_COLLAPSED_WIDTH,Lite.NODE_TITLE_HEIGHT]:node.size,ctx.font="14px Courier New",ctx.measureText(text),w=Math.max(node.size[0],160)+20,h=node.ttip_oTMultiRet?node.ttip_oTMultiRet.height+15:21,ctx.globalAlpha=.7*this.editor_alpha,ctx.shadowColor=node.ttip_oTMultiRet?"black":"transparent",ctx.shadowOffsetX=2,ctx.shadowOffsetY=2,ctx.shadowBlur=3,ctx.fillStyle=node.ttip_oTMultiRet?"#454":"transparent",ctx.beginPath(),ctx.roundRect(pos[0]-.5*w+size[0]/2,pos[1]-15-h,w,h,[3]),ctx.moveTo(pos[0]-10+size[0]/2,pos[1]-15),ctx.lineTo(pos[0]+10+size[0]/2,pos[1]-15),ctx.lineTo(pos[0]+size[0]/2,pos[1]-5),ctx.fill(),ctx.shadowColor="transparent",ctx.textAlign="center",ctx.fillStyle=node.ttip_oTMultiRet?"#CEC":"transparent",ctx.globalAlpha=this.editor_alpha,text=Lite.canvasFillTextMultiline(ctx,text,pos[0]+size[0]/2,pos[1]-h,w,14),node.ttip_oTMultiRet=text,ctx.closePath()):Lite.debug):Lite.debug&&console.warn("drawNodeTooltip: invalid node or ctx",node,ctx)}drawLinkTooltip(ctx,link){var text,pos=link._pos;ctx.fillStyle="black",ctx.beginPath(),ctx.arc(pos[0],pos[1],3,0,2*Math.PI),ctx.fill(),null==link.data||this.onDrawLinkTooltip?.(ctx,link,this)||(text=null)!=(text=(link=link.data).constructor===Number?link.toFixed(2):link.constructor===String?'"'+link+'"':link.constructor===Boolean?String(link):link.toToolTip?link.toToolTip():"["+link.constructor.name+"]")&&(text=text.substr(0,30),ctx.font="14px Courier New",link=ctx.measureText(text).width+20,ctx.shadowColor="black",ctx.shadowOffsetX=2,ctx.shadowOffsetY=2,ctx.shadowBlur=3,ctx.fillStyle="#454",ctx.beginPath(),ctx.roundRect(pos[0]-.5*link,pos[1]-15-24,link,24,[3]),ctx.moveTo(pos[0]-10,pos[1]-15),ctx.lineTo(pos[0]+10,pos[1]-15),ctx.lineTo(pos[0],pos[1]-5),ctx.fill(),ctx.shadowColor="transparent",ctx.textAlign="center",ctx.fillStyle="#CEC",ctx.fillText(text,pos[0],pos[1]-15-24*.3))}drawNodeShape(node,ctx,size,fgcolor,bgcolor,selected,mouse_over){ctx.strokeStyle=fgcolor,ctx.fillStyle=bgcolor;var bgcolor=Lite.NODE_TITLE_HEIGHT,low_quality=this.lowQualityRenderingRequired(.5),shape=node._shape||node.constructor.shape||Lite.ROUND_SHAPE,title_mode=node.constructor.title_mode,render_title=!0,mouse_over=(title_mode==Lite.TRANSPARENT_TITLE||title_mode==Lite.NO_TITLE?render_title=!1:title_mode==Lite.AUTOHIDE_TITLE&&mouse_over&&(render_title=!0),tmp_area),old_alpha=(mouse_over[0]=0,mouse_over[1]=render_title?-bgcolor:0,mouse_over[2]=size[0]+1,mouse_over[3]=render_title?size[1]+bgcolor:size[1],ctx.globalAlpha);if(ctx.beginPath(),shape==Lite.BOX_SHAPE||low_quality?ctx.fillRect(mouse_over[0],mouse_over[1],mouse_over[2],mouse_over[3]):shape==Lite.ROUND_SHAPE||shape==Lite.CARD_SHAPE?ctx.roundRect(mouse_over[0],mouse_over[1],mouse_over[2],mouse_over[3],shape==Lite.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):shape==Lite.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0],0,2*Math.PI),ctx.fill(),!node.flags.collapsed&&render_title&&(ctx.shadowColor="transparent",ctx.fillStyle="rgba(0,0,0,0.2)",ctx.fillRect(0,-1,mouse_over[2],2)),ctx.shadowColor="transparent",node.onDrawBackground?.(ctx,this,this.canvas,this.graph_mouse),render_title||title_mode==Lite.TRANSPARENT_TITLE){node.onDrawTitleBar?node.onDrawTitleBar(ctx,bgcolor,size,this.ds.scale,fgcolor):title_mode!=Lite.TRANSPARENT_TITLE&&(node.constructor.title_color||this.render_title_colored)&&(render_title=node.constructor.title_color||fgcolor,node.flags.collapsed&&(ctx.shadowColor=Lite.DEFAULT_SHADOW_COLOR),this.use_gradients?((grad=Canvas.gradients[render_title])||((grad=Canvas.gradients[render_title]=ctx.createLinearGradient(0,0,400,0)).addColorStop(0,render_title),grad.addColorStop(1,"#000")),ctx.fillStyle=grad):ctx.fillStyle=render_title,ctx.beginPath(),shape==Lite.BOX_SHAPE||low_quality?ctx.rect(0,-bgcolor,size[0]+1,bgcolor):shape!=Lite.ROUND_SHAPE&&shape!=Lite.CARD_SHAPE||ctx.roundRect(0,-bgcolor,size[0]+1,bgcolor,node.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),ctx.fill(),ctx.shadowColor="transparent");let colState=!1;Lite.node_box_coloured_by_mode&&Lite.NODE_MODES_COLORS[node.mode]&&(colState=Lite.NODE_MODES_COLORS[node.mode]),Lite.node_box_coloured_when_on&&(colState=node.action_triggered?"#FFF":node.execute_triggered?"#AAA":colState);var grad;node.onDrawTitleBox?node.onDrawTitleBox(ctx,bgcolor,size,this.ds.scale):shape==Lite.ROUND_SHAPE||shape==Lite.CIRCLE_SHAPE||shape==Lite.CARD_SHAPE?(low_quality&&(ctx.fillStyle="black",ctx.beginPath(),ctx.arc(.5*bgcolor,-.5*bgcolor,6,0,2*Math.PI),ctx.fill()),ctx.fillStyle=node.boxcolor||colState||Lite.NODE_DEFAULT_BOXCOLOR,low_quality?ctx.fillRect(.5*bgcolor-5,-.5*bgcolor-5,10,10):(ctx.beginPath(),ctx.arc(.5*bgcolor,-.5*bgcolor,5,0,2*Math.PI),ctx.fill())):(low_quality&&(ctx.fillStyle="black",ctx.fillRect(.5*(bgcolor-10)-1,-.5*(bgcolor+10)-1,12,12)),ctx.fillStyle=node.boxcolor||colState||Lite.NODE_DEFAULT_BOXCOLOR,ctx.fillRect(.5*(bgcolor-10),-.5*(bgcolor+10),10,10)),ctx.globalAlpha=old_alpha,node.onDrawTitleText&&node.onDrawTitleText(ctx,bgcolor,size,this.ds.scale,this.title_text_font,selected),!low_quality&&(ctx.font=this.title_text_font,grad=String(node.getTitle()))&&(ctx.fillStyle=selected?Lite.NODE_SELECTED_TITLE_COLOR:node.constructor.title_text_color||this.node_title_color,node.flags.collapsed?(ctx.textAlign="left",ctx.fillText(grad.substr(0,20),bgcolor,Lite.NODE_TITLE_TEXT_Y-bgcolor),ctx.textAlign="left"):(ctx.textAlign="left",ctx.fillText(grad,bgcolor,Lite.NODE_TITLE_TEXT_Y-bgcolor))),node.flags.collapsed||!node.subgraph||node.skip_subgraph_button||(render_title=Lite.NODE_TITLE_HEIGHT,old_alpha=node.size[0]-render_title,grad=Lite.isInsideRectangle(this.graph_mouse[0]-node.pos[0],this.graph_mouse[1]-node.pos[1],2+old_alpha,2-render_title,render_title-4,render_title-4),ctx.fillStyle=grad?"#888":"#555",shape==Lite.BOX_SHAPE||low_quality?ctx.fillRect(2+old_alpha,2-render_title,render_title-4,render_title-4):(ctx.beginPath(),ctx.roundRect(2+old_alpha,2-render_title,render_title-4,render_title-4,[4]),ctx.fill()),ctx.fillStyle="#333",ctx.beginPath(),ctx.moveTo(old_alpha+.2*render_title,.6*-render_title),ctx.lineTo(old_alpha+.8*render_title,.6*-render_title),ctx.lineTo(old_alpha+.5*render_title,.3*-render_title),ctx.fill()),node.onDrawTitle&&node.onDrawTitle(ctx)}selected&&(node.onBounding&&node.onBounding(mouse_over),title_mode==Lite.TRANSPARENT_TITLE&&(mouse_over[1]-=bgcolor,mouse_over[3]+=bgcolor),ctx.lineWidth=1,ctx.globalAlpha=.8,ctx.beginPath(),shape==Lite.BOX_SHAPE?ctx.rect(-6+mouse_over[0],-6+mouse_over[1],12+mouse_over[2],12+mouse_over[3]):shape==Lite.ROUND_SHAPE||shape==Lite.CARD_SHAPE&&node.flags.collapsed?ctx.roundRect(-6+mouse_over[0],-6+mouse_over[1],12+mouse_over[2],12+mouse_over[3],[2*this.round_radius]):shape==Lite.CARD_SHAPE?ctx.roundRect(-6+mouse_over[0],-6+mouse_over[1],12+mouse_over[2],12+mouse_over[3],[2*this.round_radius,2,2*this.round_radius,2]):shape==Lite.CIRCLE_SHAPE&&ctx.arc(.5*size[0],.5*size[1],.5*size[0]+6,0,2*Math.PI),ctx.strokeStyle=Lite.NODE_BOX_OUTLINE_COLOR,ctx.stroke(),ctx.strokeStyle=fgcolor,ctx.globalAlpha=1),0<node.execute_triggered&&node.execute_triggered--,0<node.action_triggered&&node.action_triggered--}drawConnections(ctx){for(var now=Lite.getTime(),visible_area=this.visible_area,nodes=(margin_area[0]=visible_area[0]-20,margin_area[1]=visible_area[1]-20,margin_area[2]=visible_area[2]+40,margin_area[3]=visible_area[3]+40,ctx.lineWidth=this.connections_width,ctx.fillStyle="#AAA",ctx.strokeStyle="#AAA",ctx.globalAlpha=this.editor_alpha,this.graph._nodes),n=0,l=nodes.length;n<l;++n){var node=nodes[n];if(node.inputs&&node.inputs.length)for(let i=0;i<node.inputs.length;++i){var start_node_slotpos,end_node_slotpos,start_node_slot,start_node,end_slot,tmp,input=node.inputs[i];input&&null!=input.link&&(input=input.link,input=this.graph.links[input])&&null!=(start_node=this.graph.getNodeById(input.origin_id))&&(start_node_slotpos=null,start_node_slotpos=-1==(start_node_slot=input.origin_slot)?[start_node.pos[0]+10,start_node.pos[1]+10]:start_node.getConnectionPos(!1,start_node_slot,tempA),end_node_slotpos=node.getConnectionPos(!0,i,tempB),link_bounding[0]=start_node_slotpos[0],link_bounding[1]=start_node_slotpos[1],link_bounding[2]=end_node_slotpos[0]-start_node_slotpos[0],link_bounding[3]=end_node_slotpos[1]-start_node_slotpos[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),Lite.overlapBounding(link_bounding,margin_area))&&(start_node_slot=start_node.outputs[start_node_slot],end_slot=node.inputs[i],start_node_slot)&&end_slot&&(start_node_slot=start_node_slot.dir||(start_node.horizontal?Lite.DOWN:Lite.RIGHT),start_node=end_slot.dir||(node.horizontal?Lite.UP:Lite.LEFT),this.renderLink(ctx,start_node_slotpos,end_node_slotpos,input,!1,0,null,start_node_slot,start_node),input)&&input._last_time&&now-input._last_time<1e3&&(end_slot=2-.002*(now-input._last_time),tmp=ctx.globalAlpha,ctx.globalAlpha=tmp*end_slot,this.renderLink(ctx,start_node_slotpos,end_node_slotpos,input,!0,end_slot,"white",start_node_slot,start_node),ctx.globalAlpha=tmp)}}ctx.globalAlpha=1}renderLink(ctx,a,b,link,skip_border,flow,color,start_dir,end_dir,num_sublines){link&&this.visible_links.push(link),color=(color=!color&&link?link.color||Canvas.link_type_colors[link.type]:color)||this.default_link_color,null!=link&&this.highlighted_links[link.id]&&(color="#FFF"),start_dir=start_dir||Lite.RIGHT,end_dir=end_dir||Lite.LEFT;var dist=Lite.distance(a,b);this.render_connections_border&&.6<this.ds.scale&&(ctx.lineWidth=this.connections_width+4),ctx.lineJoin="round",1<(num_sublines=num_sublines||1)&&(ctx.lineWidth=.5),ctx.beginPath();for(let i=0;i<num_sublines;i+=1){var offsety=5*(i-.5*(num_sublines-1));if(this.links_render_mode==Lite.SPLINE_LINK){ctx.moveTo(a[0],a[1]+offsety);let start_offset_x=0,start_offset_y=0,end_offset_x=0,end_offset_y=0;switch(start_dir){case Lite.LEFT:start_offset_x=-.25*dist;break;case Lite.RIGHT:start_offset_x=.25*dist;break;case Lite.UP:start_offset_y=-.25*dist;break;case Lite.DOWN:start_offset_y=.25*dist}switch(end_dir){case Lite.LEFT:end_offset_x=-.25*dist;break;case Lite.RIGHT:end_offset_x=.25*dist;break;case Lite.UP:end_offset_y=-.25*dist;break;case Lite.DOWN:end_offset_y=.25*dist}ctx.bezierCurveTo(a[0]+start_offset_x,a[1]+start_offset_y+offsety,b[0]+end_offset_x,b[1]+end_offset_y+offsety,b[0],b[1]+offsety)}else if(this.links_render_mode==Lite.LINEAR_LINK){ctx.moveTo(a[0],a[1]+offsety);let start_offset_x=0,start_offset_y=0,end_offset_x=0,end_offset_y=0;switch(start_dir){case Lite.LEFT:start_offset_x=-1;break;case Lite.RIGHT:start_offset_x=1;break;case Lite.UP:start_offset_y=-1;break;case Lite.DOWN:start_offset_y=1}switch(end_dir){case Lite.LEFT:end_offset_x=-1;break;case Lite.RIGHT:end_offset_x=1;break;case Lite.UP:end_offset_y=-1;break;case Lite.DOWN:end_offset_y=1}ctx.lineTo(a[0]+15*start_offset_x,a[1]+15*start_offset_y+offsety),ctx.lineTo(b[0]+15*end_offset_x,b[1]+15*end_offset_y+offsety),ctx.lineTo(b[0],b[1]+offsety)}else{if(this.links_render_mode!=Lite.STRAIGHT_LINK)return;ctx.moveTo(a[0],a[1]);var offsety=a[0],start_y=a[1],end_x=b[0],end_y=b[1];start_dir==Lite.RIGHT?offsety+=10:start_y+=10,end_dir==Lite.LEFT?end_x-=10:end_y-=10,ctx.lineTo(offsety,start_y),ctx.lineTo(.5*(offsety+end_x),start_y),ctx.lineTo(.5*(offsety+end_x),end_y),ctx.lineTo(end_x,end_y),ctx.lineTo(b[0],b[1])}}this.render_connections_border&&.6<this.ds.scale&&!skip_border&&(ctx.strokeStyle="rgba(0,0,0,0.5)",ctx.stroke()),ctx.lineWidth=this.connections_width,ctx.fillStyle=ctx.strokeStyle=color,ctx.stroke();var posC,posD,angleA,angleB,pos=this.computeConnectionPoint(a,b,.5,start_dir,end_dir);if(link&&link._pos&&(link._pos[0]=pos[0],link._pos[1]=pos[1]),.6<=this.ds.scale&&this.highquality_render&&end_dir!=Lite.CENTER&&(this.render_connection_arrows&&(skip_border=this.computeConnectionPoint(a,b,.25,start_dir,end_dir),link=this.computeConnectionPoint(a,b,.26,start_dir,end_dir),posC=this.computeConnectionPoint(a,b,.75,start_dir,end_dir),posD=this.computeConnectionPoint(a,b,.76,start_dir,end_dir),angleB=angleA=0,angleB=this.render_curved_connections?(angleA=-Math.atan2(link[0]-skip_border[0],link[1]-skip_border[1]),-Math.atan2(posD[0]-posC[0],posD[1]-posC[1])):angleA=b[1]>a[1]?0:Math.PI,ctx.save(),ctx.translate(skip_border[0],skip_border[1]),ctx.rotate(angleA),ctx.beginPath(),ctx.moveTo(-5,-3),ctx.lineTo(0,7),ctx.lineTo(5,-3),ctx.fill(),ctx.restore(),ctx.save(),ctx.translate(posC[0],posC[1]),ctx.rotate(angleB),ctx.beginPath(),ctx.moveTo(-5,-3),ctx.lineTo(0,7),ctx.lineTo(5,-3),ctx.fill(),ctx.restore()),ctx.beginPath(),ctx.arc(pos[0],pos[1],5,0,2*Math.PI),ctx.fill()),flow){ctx.fillStyle=color;for(let i=0;i<5;++i){var f=(.001*Lite.getTime()+.2*i)%1,pos=this.computeConnectionPoint(a,b,f,start_dir,end_dir);ctx.beginPath(),ctx.arc(pos[0],pos[1],5,0,2*Math.PI),ctx.fill()}}}computeConnectionPoint(a,b,t,start_dir,end_dir){start_dir=start_dir||Lite.RIGHT,end_dir=end_dir||Lite.LEFT;var dist=Lite.distance(a,b),p0=a,p1=[a[0],a[1]],p2=[b[0],b[1]],a=b;switch(start_dir){case Lite.LEFT:p1[0]+=-.25*dist;break;case Lite.RIGHT:p1[0]+=.25*dist;break;case Lite.UP:p1[1]+=-.25*dist;break;case Lite.DOWN:p1[1]+=.25*dist}switch(end_dir){case Lite.LEFT:p2[0]+=-.25*dist;break;case Lite.RIGHT:p2[0]+=.25*dist;break;case Lite.UP:p2[1]+=-.25*dist;break;case Lite.DOWN:p2[1]+=.25*dist}b=(1-t)*(1-t)*(1-t),start_dir=(1-t)*(1-t)*3*t,end_dir=3*(1-t)*(t*t),t*=t*t;return[b*p0[0]+start_dir*p1[0]+end_dir*p2[0]+t*a[0],b*p0[1]+start_dir*p1[1]+end_dir*p2[1]+t*a[1]]}drawExecutionOrder(ctx){ctx.shadowColor="transparent",ctx.globalAlpha=.25,ctx.textAlign="center",ctx.strokeStyle="white",ctx.globalAlpha=.75;var visible_nodes=this.visible_nodes;for(let i=0;i<visible_nodes.length;++i){var node=visible_nodes[i];ctx.fillStyle="black",ctx.fillRect(node.pos[0]-Lite.NODE_TITLE_HEIGHT,node.pos[1]-Lite.NODE_TITLE_HEIGHT,Lite.NODE_TITLE_HEIGHT,Lite.NODE_TITLE_HEIGHT),0==node.order&&ctx.strokeRect(node.pos[0]-Lite.NODE_TITLE_HEIGHT+.5,node.pos[1]-Lite.NODE_TITLE_HEIGHT+.5,Lite.NODE_TITLE_HEIGHT,Lite.NODE_TITLE_HEIGHT),ctx.fillStyle="#FFF",ctx.fillText(node.order,node.pos[0]+-.5*Lite.NODE_TITLE_HEIGHT,node.pos[1]-6)}ctx.globalAlpha=1}drawNodeWidgets(node,posY,ctx,active_widget){if(!node.widgets||!node.widgets.length)return 0;var width=node.size[0],widgets=node.widgets,H=(posY+=2,Lite.NODE_WIDGET_HEIGHT),show_text=!this.lowQualityRenderingRequired(.5),outline_color=(ctx.save(),ctx.globalAlpha=this.editor_alpha,Lite.WIDGET_OUTLINE_COLOR),background_color=Lite.WIDGET_BGCOLOR,text_color=Lite.WIDGET_TEXT_COLOR,secondary_text_color=Lite.WIDGET_SECONDARY_TEXT_COLOR;for(let i=0;i<widgets.length;++i){var values,w=widgets[i],y=posY,widget_width=(w.y&&(y=w.y),w.last_y=y,ctx.strokeStyle=outline_color,ctx.fillStyle="#222",ctx.textAlign="left",w.disabled&&(ctx.globalAlpha*=.5),w.width||width);switch(w.type){case"button":w.clicked&&(ctx.fillStyle="#AAA",w.clicked=!1,this.dirty_canvas=!0),ctx.fillRect(15,y,widget_width-30,H),show_text&&!w.disabled&&ctx.strokeRect(15,y,widget_width-30,H),show_text&&(ctx.textAlign="center",ctx.fillStyle=text_color,ctx.fillText(w.label||w.name,.5*widget_width,y+.7*H));break;case"toggle":ctx.textAlign="left",ctx.strokeStyle=outline_color,ctx.fillStyle=background_color,ctx.beginPath(),show_text?ctx.roundRect(15,y,widget_width-30,H,[.5*H]):ctx.rect(15,y,widget_width-30,H),ctx.fill(),show_text&&!w.disabled&&ctx.stroke(),ctx.fillStyle=w.value?"#89A":"#333",ctx.beginPath(),ctx.arc(widget_width-30,y+.5*H,.36*H,0,2*Math.PI),ctx.fill(),show_text&&(ctx.fillStyle=secondary_text_color,null!=(label=w.label||w.name)&&ctx.fillText(label,30,y+.7*H),ctx.fillStyle=w.value?text_color:secondary_text_color,ctx.textAlign="right",ctx.fillText(w.value?w.options.on||"true":w.options.off||"false",widget_width-40,y+.7*H));break;case"slider":ctx.fillStyle=background_color,ctx.fillRect(15,y,widget_width-30,H);var label=w.options.max-w.options.min,nvalue=(w.value-w.options.min)/label;1<(nvalue=nvalue<0?0:nvalue)&&(nvalue=1),ctx.fillStyle=w.options.hasOwnProperty("slider_color")?w.options.slider_color:active_widget==w?"#89A":"#678",ctx.fillRect(15,y,nvalue*(widget_width-30),H),show_text&&!w.disabled&&ctx.strokeRect(15,y,widget_width-30,H),w.marker&&(1<(nvalue=(nvalue=(w.marker-w.options.min)/label)<0?0:nvalue)&&(nvalue=1),ctx.fillStyle=w.options.hasOwnProperty("marker_color")?w.options.marker_color:"#AA9",ctx.fillRect(15+nvalue*(widget_width-30),y,2,H)),show_text&&(ctx.textAlign="center",ctx.fillStyle=text_color,ctx.fillText(w.label||w.name+"  "+Number(w.value).toFixed(null!=w.options.precision?w.options.precision:3),.5*widget_width,y+.7*H));break;case"number":case"combo":ctx.textAlign="left",ctx.strokeStyle=outline_color,ctx.fillStyle=background_color,ctx.beginPath(),show_text?ctx.roundRect(15,y,widget_width-30,H,[.5*H]):ctx.rect(15,y,widget_width-30,H),ctx.fill(),show_text&&(w.disabled||ctx.stroke(),ctx.fillStyle=text_color,w.disabled||(ctx.beginPath(),ctx.moveTo(31,y+5),ctx.lineTo(21,y+.5*H),ctx.lineTo(31,y+H-5),ctx.fill(),ctx.beginPath(),ctx.moveTo(widget_width-15-16,y+5),ctx.lineTo(widget_width-15-6,y+.5*H),ctx.lineTo(widget_width-15-16,y+H-5),ctx.fill()),ctx.fillStyle=secondary_text_color,ctx.fillText(w.label||w.name,35,y+.7*H),ctx.fillStyle=text_color,ctx.textAlign="right","number"==w.type?ctx.fillText(Number(w.value).toFixed(void 0!==w.options.precision?w.options.precision:3),widget_width-30-20,y+.7*H):(nvalue=w.value,w.options.values&&(values=(values=w.options.values).constructor===Function?values():values)&&values.constructor!==Array&&(nvalue=values[w.value]),ctx.fillText(nvalue,widget_width-30-20,y+.7*H)));break;case"string":case"text":if(ctx.textAlign="left",ctx.strokeStyle=outline_color,ctx.fillStyle=background_color,ctx.beginPath(),show_text?ctx.roundRect(15,y,widget_width-30,H,[.5*H]):ctx.rect(15,y,widget_width-30,H),ctx.fill(),show_text){w.disabled||ctx.stroke(),ctx.save(),ctx.beginPath(),ctx.rect(15,y,widget_width-30,H),ctx.clip(),ctx.fillStyle=secondary_text_color;const label=w.label||w.name;null!=label&&ctx.fillText(label,30,y+.7*H),ctx.fillStyle=text_color,ctx.textAlign="right",ctx.fillText(String(w.value).substr(0,30),widget_width-30,y+.7*H),ctx.restore()}break;default:w.draw&&w.draw(ctx,node,widget_width,y,H)}posY+=(w.computeSize?w.computeSize(widget_width)[1]:H)+4,ctx.globalAlpha=this.editor_alpha}ctx.restore(),ctx.textAlign="left"}processNodeWidgets(node,pos,event,active_widget){if(node.widgets&&node.widgets.length&&(this.allow_interaction||node.flags.allow_interaction)){var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],deltaX=event.deltaX||event.deltax||0,that=this,ref_window=this.getCanvasWindow();for(let i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w&&!w.disabled){var widget_height=w.computeSize?w.computeSize(width)[1]:Lite.NODE_WIDGET_HEIGHT,widget_width=w.width||width;if(w==active_widget||!(x<6||widget_width-12<x||y<w.last_y||y>w.last_y+widget_height||void 0===w.last_y)){var old_value=w.value;switch(w.type){case"button":"pointerdown"===event.type&&(w.callback&&setTimeout(function(){w.callback(w,that,node,pos,event)},20),w.clicked=!0,this.dirty_canvas=!0);break;case"slider":var nvalue=Lite.clamp((x-15)/(widget_width-30),0,1);w.options.read_only||(w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout(function(){inner_value_change(w,w.value,old_value)},20),this.dirty_canvas=!0);break;case"number":case"combo":case"enum":if("pointermove"==event.type&&"number"==w.type)deltaX&&(w.value+=.1*deltaX*(w.options.step||1)),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if("pointerdown"==event.type){var values=w.options.values,values_list=(values&&values.constructor===Function&&(values=w.options.values(w,node)),null),index,text_values;"number"!=w.type&&(values_list=values.constructor===Array?values:Object.keys(values));let delta=x<40?-1:widget_width-40<x?1:0;function inner_clicked(v){return values!=values_list&&(v=text_values.indexOf(v)),this.value=v,inner_value_change(this,v,old_value),!(that.dirty_canvas=!0)}"number"==w.type?(w.value+=.1*delta*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max)):delta?(index=-1,this.last_mouseclick=0,index=values.constructor===Object?values_list.indexOf(String(w.value))+delta:values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:w.value=index):(text_values=values!=values_list?Object.values(values):values,new Lite.ContextMenu(text_values,{scale:Math.max(1,this.ds.scale),event:event,className:"dark",callback:inner_clicked.bind(w)},ref_window))}else if("pointerup"==event.type&&"number"==w.type){let delta=x<40?-1:widget_width-40<x?1:0;event.click_time<200&&0==delta&&this.prompt("Value",w.value,function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(error){console.warn(error)}this.value=Number(v),inner_value_change(this,this.value,old_value)}.bind(w),event)}old_value!=w.value&&setTimeout(function(){inner_value_change(this,this.value,old_value)}.bind(w),20),this.dirty_canvas=!0;break;case"toggle":"pointerdown"==event.type&&(w.value=!w.value,setTimeout(function(){inner_value_change(w,w.value)},20));break;case"string":case"text":"pointerdown"==event.type&&this.prompt("Value",w.value,function(v){inner_value_change(this,v)}.bind(w),event,!!w.options&&w.options.multiline);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node))}return w}}}}return null;function inner_value_change(widget,value,old_value){Lite.debug&&console.debug("inner_value_change for processNodeWidgets",widget,value),old_value!=w.value&&(node.onWidgetChanged&&node.onWidgetChanged(w.name,w.value,old_value,w),node.graph.onGraphChanged({action:"widgetChanged",doSave:!0})),"number"==widget.type&&(value=Number(value)),widget.value=value,widget.options&&widget.options.property&&void 0!==node.properties[widget.options.property]&&node.setProperty(widget.options.property,value),widget.callback&&widget.callback(widget.value,that,node,pos,event)}}drawGroups(canvas,ctx){if(this.graph){var groups=this.graph._groups;ctx.save(),ctx.globalAlpha=.5*this.editor_alpha;for(let i=0;i<groups.length;++i){var pos,size,group=groups[i];Lite.overlapBounding(this.visible_area,group._bounding)&&(ctx.fillStyle=group.color||"#335",ctx.strokeStyle=group.color||"#335",pos=group._pos,size=group._size,ctx.globalAlpha=.25*this.editor_alpha,ctx.beginPath(),ctx.rect(pos[0]+.5,pos[1]+.5,size[0],size[1]),ctx.fill(),ctx.globalAlpha=this.editor_alpha,ctx.stroke(),ctx.beginPath(),ctx.moveTo(pos[0]+size[0],pos[1]+size[1]),ctx.lineTo(pos[0]+size[0]-10,pos[1]+size[1]),ctx.lineTo(pos[0]+size[0],pos[1]+size[1]-10),ctx.fill(),size=group.font_size||Lite.DEFAULT_GROUP_FONT_SIZE,ctx.font=size+"px Arial",ctx.textAlign="left",ctx.fillText(group.title,pos[0]+4,pos[1]+size))}ctx.restore()}}adjustNodesSize(){var nodes=this.graph._nodes;for(let i=0;i<nodes.length;++i)nodes[i].size=nodes[i].computeSize();this.setDirty(!0,!0)}resize(width,height){var parent;width||height||(width=(parent=this.canvas.parentNode).offsetWidth,height=parent.offsetHeight),this.canvas.width==width&&this.canvas.height==height||(this.canvas.width=width,this.canvas.height=height,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}switchLiveMode(transition){var self,delta,t;transition?(delta=(self=this).live_mode?1.1:.9,this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1),t=setInterval(function(){self.editor_alpha*=delta,self.dirty_canvas=!0,self.dirty_bgcanvas=!0,delta<1&&self.editor_alpha<.01&&(clearInterval(t),delta<1)&&(self.live_mode=!0),1<delta&&.99<self.editor_alpha&&(clearInterval(t),self.editor_alpha=1)},1)):(this.live_mode=!this.live_mode,this.dirty_canvas=!0,this.dirty_bgcanvas=!0)}static onGroupAdd(info,entry,mouse_event){var canvas=Canvas.active_canvas,group=new Lite.Group;group.pos=canvas.convertEventToCanvasOffset(mouse_event),canvas.graph.add(group)}static getBoundaryNodes(nodes){let top=null,right=null,bottom=null,left=null;for(const nID in nodes){var node=nodes[nID],[x,y]=node.pos,[width,height]=node.size;(null===top||y<top.pos[1])&&(top=node),(null===right||x+width>right.pos[0]+right.size[0])&&(right=node),(null===bottom||y+height>bottom.pos[1]+bottom.size[1])&&(bottom=node),(null===left||x<left.pos[0])&&(left=node)}return{top:top,right:right,bottom:bottom,left:left}}boundaryNodesForSelection(){return Canvas.getBoundaryNodes(Object.values(this.selected_nodes))}static alignNodes(nodes,direction,align_to){if(nodes){var _,node,canvas=Canvas.active_canvas;let boundaryNodes=[];boundaryNodes=void 0===align_to?Canvas.getBoundaryNodes(nodes):{top:align_to,right:align_to,bottom:align_to,left:align_to};for([_,node]of Object.entries(canvas.selected_nodes))switch(direction){case"right":node.pos[0]=boundaryNodes.right.pos[0]+boundaryNodes.right.size[0]-node.size[0];break;case"left":node.pos[0]=boundaryNodes.left.pos[0];break;case"top":node.pos[1]=boundaryNodes.top.pos[1];break;case"bottom":node.pos[1]=boundaryNodes.bottom.pos[1]+boundaryNodes.bottom.size[1]-node.size[1]}canvas.dirty_canvas=!0,canvas.dirty_bgcanvas=!0}}static onNodeAlign(value,options,event,prev_menu,node){new Lite.ContextMenu(["Top","Bottom","Left","Right"],{event:event,callback:function(value){Canvas.alignNodes(Canvas.active_canvas.selected_nodes,value.toLowerCase(),node)},parentMenu:prev_menu})}static onGroupAlign(value,options,event,prev_menu){new Lite.ContextMenu(["Top","Bottom","Left","Right"],{event:event,callback:function(value){Canvas.alignNodes(Canvas.active_canvas.selected_nodes,value.toLowerCase())},parentMenu:prev_menu})}static onMenuAdd(node,options,e,prev_menu,callback){var canvas=Canvas.active_canvas,ref_window=canvas.getCanvasWindow(),graph=canvas.graph;if(graph)return function inner_onMenuAdded(base_category,prev_menu){var categories=Lite.getNodeTypesCategories(canvas.filter||graph.filter).filter(function(category){return category.startsWith(base_category)}),entries=[];categories.map(function(category){var category_path,base_category_regex;category&&(base_category_regex=new RegExp("^("+base_category+")"),category=category.replace(base_category_regex,"").split("/")[0],category_path=""===base_category?category+"/":base_category+category+"/",-1!=(base_category_regex=category).indexOf("::")&&(base_category_regex=base_category_regex.split("::")[1]),-1===entries.findIndex(function(entry){return entry.value===category_path}))&&entries.push({value:category_path,content:base_category_regex,has_submenu:!0,callback:function(value,event,mouseEvent,contextMenu){inner_onMenuAdded(value.value,contextMenu)}})}),Lite.getNodeTypesInCategory(base_category.slice(0,-1),canvas.filter||graph.filter).map(function(node){node.skip_list||(node={value:node.type,content:node.title,has_submenu:!1,callback:function(value,event,mouseEvent,contextMenu){contextMenu=contextMenu.getFirstEvent(),canvas.graph.beforeChange(),(value=Lite.createNode(value.value))&&(value.pos=canvas.convertEventToCanvasOffset(contextMenu),canvas.graph.add(value)),callback&&callback(value),canvas.graph.afterChange()}},entries.push(node))}),new Lite.ContextMenu(entries,{event:e,parentMenu:prev_menu},ref_window)}("",prev_menu),!1}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalInputs(v,options,e,prev_menu,node){if(node){var retEntries,that=this,ref_window=Canvas.active_canvas.getCanvasWindow(),entries=(options=node.optional_inputs,[]);if(options=node.onGetInputs?node.onGetInputs():options)for(let i=0;i<options.length;i++){var label,entry=options[i];entry?(label=entry[0],label=(entry[2]||(entry[2]={}),entry[2].label&&(label=entry[2].label),entry[2].removable=!0,{content:label,value:entry}),entry[1]==Lite.ACTION&&(label.className="event"),entries.push(label)):entries.push(null)}if(node.onMenuNodeInputs&&(retEntries=node.onMenuNodeInputs(entries))&&(entries=retEntries),Lite.do_add_triggers_slots&&-1==node.findInputSlot("onTrigger")&&entries.push({content:"On Trigger",value:["onTrigger",Lite.EVENT,{nameLocked:!0,removable:!0}],className:"event"}),entries.length)return new Lite.ContextMenu(entries,{event:e,callback:function(v,e,prev){node&&(v.callback&&v.callback.call(that,node,v,e,prev),v.value)&&(node.graph.beforeChange(),e={},v.value[2]&&(e=Object.assign(e,v.value[2])),node.addInput(v.value[0],v.value[1],e),node.onNodeInputAdd?.(v.value),node.setDirtyCanvas(!0,!0),node.graph.afterChange())},parentMenu:prev_menu,node:node},ref_window),!1;Lite.debug&&console.log("no input entries")}}static showMenuNodeOptionalOutputs(v,options,e,prev_menu,node){if(node){var retEntries,that=this,ref_window=Canvas.active_canvas.getCanvasWindow(),entries=(options=node.optional_outputs,[]);if(options=node.onGetOutputs?node.onGetOutputs():options)for(let i=0;i<options.length;i++){var label,entry=options[i];entry?node.flags&&node.flags.skip_repeated_outputs&&-1!=node.findOutputSlot(entry[0])||(label=entry[0],entry[2]||(entry[2]={}),entry[2].label&&(label=entry[2].label),entry[2].removable=!0,label={content:label,value:entry},entry[1]==Lite.EVENT&&(label.className="event"),entries.push(label)):entries.push(null)}if(this.onMenuNodeOutputs&&(entries=this.onMenuNodeOutputs(entries)),Lite.do_add_triggers_slots&&-1==node.findOutputSlot("onExecuted")&&entries.push({content:"On Executed",value:["onExecuted",Lite.EVENT,{nameLocked:!0,removable:!0}],className:"event"}),(entries=node.onMenuNodeOutputs&&(retEntries=node.onMenuNodeOutputs(entries))?retEntries:entries).length)return new Lite.ContextMenu(entries,{event:e,callback:function inner_clicked(v,e,prev){if(!node)return;v.callback&&v.callback.call(that,node,v,e,prev);if(!v.value)return;var value=v.value[1];{if(value&&(value.constructor===Object||value.constructor===Array)){var i,entries=[];for(i in value)entries.push({content:i,value:value[i]});return new Lite.ContextMenu(entries,{event:e,callback:inner_clicked,parentMenu:prev_menu,node:node}),!1}node.graph.beforeChange();prev={};v.value[2]&&(prev=Object.assign(prev,v.value[2])),node.addOutput(v.value[0],v.value[1],prev),node.onNodeOutputAdd?.(v.value),node.setDirtyCanvas(!0,!0),node.graph.afterChange()}},parentMenu:prev_menu,node:node},ref_window),!1}}static onShowMenuNodeProperties(value,options,e,prev_menu,node){if(node&&node.properties){var i,canvas=Canvas.active_canvas,ref_window=canvas.getCanvasWindow(),entries=[];for(i in node.properties){"object"==typeof(value=void 0!==node.properties[i]?node.properties[i]:" ")&&(value=JSON.stringify(value));var info=node.getPropertyInfo(i);"enum"!=info.type&&"combo"!=info.type||(value=Canvas.getPropertyPrintableValue(value,info.values)),value=Canvas.decodeHTML(value),entries.push({content:"<span class='property_name'>"+(info.label||i)+"</span><span class='property_value'>"+value+"</span>",value:i})}if(entries.length)return new Lite.ContextMenu(entries,{event:e,callback:function(v){var rect;node&&(rect=this.getBoundingClientRect(),canvas.showEditPropertyValue(node,v.value,{position:[rect.left,rect.top]}))},parentMenu:prev_menu,allow_html:!0,node:node},ref_window),!1}}static decodeHTML(str){var e=document.createElement("div");return e.innerText=str,e.innerHTML}static onMenuResizeNode(value,options,e,menu,node){if(node){var fApplyMultiNode=node=>{node.size=node.computeSize(),node.onResize&&node.onResize(node.size)},graphcanvas=Canvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);node.setDirtyCanvas(!0,!0)}}showLinkMenu(link,e){var that=this,node_left=that.graph.getNodeById(link.origin_id),node_right=that.graph.getNodeById(link.target_id),fromType=!1,destType=(node_left&&node_left.outputs&&node_left.outputs[link.origin_slot]&&(fromType=node_left.outputs[link.origin_slot].type),!1),menu=(node_right&&node_right.outputs&&node_right.outputs[link.target_slot]&&(destType=node_right.inputs[link.target_slot].type),new Lite.ContextMenu(["Add Node",null,"Delete",null],{event:e,title:null!=link.data?link.data.constructor.name:null,callback:function(v,options,e){switch(v){case"Add Node":Canvas.onMenuAdd(null,null,e,menu,function(node){Lite.debug&&console.debug("node autoconnect"),node.inputs&&node.inputs.length&&node.outputs&&node.outputs.length&&node_left.connectByType(link.origin_slot,node,fromType)&&(node.connectByType(link.target_slot,node_right,destType),node.pos[0]-=.5*node.size[0])});break;case"Delete":that.graph.removeLink(link.id)}}}));return!1}createDefaultNodeForSlot(optPass={}){var opts=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},optPass),isFrom=opts.nodeFrom&&null!==opts.slotFrom,optPass=!isFrom&&opts.nodeTo&&null!==opts.slotTo;if(isFrom||optPass)if(opts.nodeType){var nodeX=isFrom?opts.nodeFrom:opts.nodeTo,slotX=isFrom?opts.slotFrom:opts.slotTo,iSlotConn=!1;switch(typeof slotX){case"string":iSlotConn=isFrom?nodeX.findOutputSlot(slotX,!1):nodeX.findInputSlot(slotX,!1),slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;case"object":iSlotConn=isFrom?nodeX.findOutputSlot(slotX.name):nodeX.findInputSlot(slotX.name);break;case"number":iSlotConn=slotX,slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;default:return console.warn("Cant get slot information "+slotX),!1}!1!==slotX&&!1!==iSlotConn||console.warn("createDefaultNodeForSlot bad slotX "+slotX+" "+iSlotConn);var fromSlotType=slotX.type==Lite.EVENT?"_event_":slotX.type,slotTypesDefault=isFrom?Lite.slot_types_default_out:Lite.slot_types_default_in;if(slotTypesDefault&&slotTypesDefault[fromSlotType]){slotX.link;var nodeNewType=!1;if("object"==typeof slotTypesDefault[fromSlotType]){for(var typeX in slotTypesDefault[fromSlotType])if(opts.nodeType==slotTypesDefault[fromSlotType][typeX]||"AUTO"==opts.nodeType){nodeNewType=slotTypesDefault[fromSlotType][typeX];break}}else opts.nodeType!=slotTypesDefault[fromSlotType]&&"AUTO"!=opts.nodeType||(nodeNewType=slotTypesDefault[fromSlotType]);if(nodeNewType){var optPass=!1,newNode=("object"==typeof nodeNewType&&nodeNewType.node&&(nodeNewType=(optPass=nodeNewType).node),Lite.createNode(nodeNewType));if(newNode){if(optPass){if(optPass.properties)for(var[key,value]of Object.entries(optPass.properties))newNode.addProperty(key,value);optPass.inputs&&(newNode.inputs=[],Object.values(optPass.inputs).forEach(value=>{newNode.addOutput(value[0],value[1])})),optPass.outputs&&(newNode.outputs=[],Object.values(optPass.outputs).forEach(value=>{newNode.addOutput(value[0],value[1])})),optPass.title&&(newNode.title=optPass.title),optPass.json&&newNode.configure(optPass.json)}return this.graph.add(newNode),newNode.pos=[opts.position[0]+opts.posAdd[0]+(opts.posSizeFix[0]?opts.posSizeFix[0]*newNode.size[0]:0),opts.position[1]+opts.posAdd[1]+(opts.posSizeFix[1]?opts.posSizeFix[1]*newNode.size[1]:0)],isFrom?opts.nodeFrom.connectByType(iSlotConn,newNode,fromSlotType):opts.nodeTo.connectByTypeOutput(iSlotConn,newNode,fromSlotType),!0}console.warn("failed creating "+nodeNewType)}}}else console.warn("No type to createDefaultNodeForSlot");else console.warn("No data passed to createDefaultNodeForSlot "+opts.nodeFrom+" "+opts.slotFrom+" "+opts.nodeTo+" "+opts.slotTo);return!1}showConnectionMenu(optPass={}){var opts=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null},optPass),that=this,isFrom=opts.nodeFrom&&opts.slotFrom,optPass=!isFrom&&opts.nodeTo&&opts.slotTo;if(isFrom||optPass){var nodeX=isFrom?opts.nodeFrom:opts.nodeTo,slotX=isFrom?opts.slotFrom:opts.slotTo,iSlotConn=!1;switch(typeof slotX){case"string":iSlotConn=isFrom?nodeX.findOutputSlot(slotX,!1):nodeX.findInputSlot(slotX,!1),slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;case"object":iSlotConn=isFrom?nodeX.findOutputSlot(slotX.name):nodeX.findInputSlot(slotX.name);break;case"number":iSlotConn=slotX,slotX=(isFrom?nodeX.outputs:nodeX.inputs)[slotX];break;default:return console.warn("Cant get slot information "+slotX),!1}var options=["Add Node",null];that.allow_searchbox&&(options.push("Search"),options.push(null));const fromSlotType=slotX.type===Lite.EVENT?"_event_":slotX.type;var optPass=isFrom?Lite.slot_types_default_out:Lite.slot_types_default_in,menu=(optPass&&optPass[fromSlotType]&&(optPass=optPass[fromSlotType],Array.isArray(optPass)||"object"==typeof optPass?Object.values(optPass).forEach(typeX=>{options.push(typeX)}):options.push(optPass)),new Lite.ContextMenu(options,{event:opts.e,title:(slotX&&""!=slotX.name?slotX.name+(fromSlotType?" | ":""):"")+(slotX&&fromSlotType?fromSlotType:""),callback:(v,options,e)=>{var cases={"Add Node":()=>{Canvas.onMenuAdd(null,null,e,menu,node=>{isFrom?opts.nodeFrom.connectByType(iSlotConn,node,fromSlotType):opts.nodeTo.connectByTypeOutput(iSlotConn,node,fromSlotType)})},Search:()=>{isFrom?that.showSearchBox(e,{node_from:opts.nodeFrom,slot_from:slotX,type_filter_in:fromSlotType}):that.showSearchBox(e,{node_to:opts.nodeTo,slot_from:slotX,type_filter_out:fromSlotType})},default:()=>{that.createDefaultNodeForSlot(Object.assign(opts,{position:[opts.e.canvasX,opts.e.canvasY],nodeType:v}))}};(cases[v]||cases.default)()}}))}else console.warn("No data passed to showConnectionMenu");return!1}static onShowPropertyEditor(item,options,e,menu,node){var property=item.property||"title",value=node[property],dialog=document.createElement("div");dialog.is_modified=!1,dialog.className="graphdialog",dialog.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",dialog.close=()=>{dialog.parentNode?.removeChild(dialog)};dialog.querySelector(".name").innerText=property;var input=dialog.querySelector(".value");const inner=()=>{input&&setValue(input.value)};input&&(input.value=value,input.addEventListener("blur",function(_event){this.focus()}),input.addEventListener("keydown",function(e){if(dialog.is_modified=!0,27==e.keyCode)dialog.close();else if(13==e.keyCode)inner();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()}));var value=Canvas.active_canvas.canvas,rect=value.getBoundingClientRect(),offsetx=-20,offsety=-20;rect&&(offsetx-=rect.left,offsety-=rect.top),event?(dialog.style.left=event.clientX+offsetx+"px",dialog.style.top=event.clientY+offsety+"px"):(dialog.style.left=.5*value.width+offsetx+"px",dialog.style.top=.5*value.height+offsety+"px"),dialog.querySelector("button").addEventListener("click",inner),value.parentNode.appendChild(dialog),input&&input.focus();let dialogCloseTimer=null;dialog.addEventListener("pointerleave",_event=>{Lite.dialog_close_on_mouse_leave&&!dialog.is_modified&&(dialogCloseTimer=setTimeout(dialog.close,Lite.dialog_close_on_mouse_leave_delay))}),dialog.addEventListener("pointerenter",_event=>{Lite.dialog_close_on_mouse_leave&&dialogCloseTimer&&clearTimeout(dialogCloseTimer)});const setValue=value=>{switch(item.type){case"Number":value=Number(value);break;case"Boolean":value=Boolean(value)}node[property]=value,dialog.parentNode?.removeChild(dialog),node.setDirtyCanvas(!0,!0)}}prompt(title="",value,callback,event,multiline){var dialog=document.createElement("div");dialog.is_modified=!1,dialog.className="graphdialog rounded",dialog.innerHTML=multiline?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",dialog.close=()=>{this.prompt_box=null,dialog.parentNode?.removeChild(dialog)};var multiline=Canvas.active_canvas.canvas,dialogCloseTimer=(multiline.parentNode.appendChild(dialog),1<this.ds.scale&&(dialog.style.transform=`scale(${this.ds.scale})`),null),selInDia=(dialog.addEventListener("pointerleave",_event=>{Lite.dialog_close_on_mouse_leave&&!dialog.is_modified&&Lite.dialog_close_on_mouse_leave&&(dialogCloseTimer=setTimeout(dialog.close,Lite.dialog_close_on_mouse_leave_delay))}),dialog.addEventListener("pointerenter",_event=>{Lite.dialog_close_on_mouse_leave&&dialogCloseTimer&&clearTimeout(dialogCloseTimer)}),dialog.querySelectorAll("select"));if(selInDia){let prevent_timeout=0;selInDia.forEach(selIn=>{selIn.addEventListener("click",_event=>{prevent_timeout++}),selIn.addEventListener("blur",_event=>{prevent_timeout=0}),selIn.addEventListener("change",_event=>{prevent_timeout=-1})})}this.prompt_box?.close();(this.prompt_box=dialog).querySelector(".name").innerText=title;selInDia=dialog.querySelector(".value");selInDia.value=value;const input=selInDia;input.addEventListener("keydown",e=>{switch(dialog.is_modified=!0,e.keyCode){case 27:dialog.close();break;case 13:"textarea"!==e.target.localName&&"function"==typeof callback&&(callback(input.value),this.setDirty(!0)),Lite.debug&&console.debug("prompt v2 ENTER",input.value,e.target.localName,callback),dialog.close();break;default:return}e.preventDefault(),e.stopPropagation()});dialog.querySelector("button").addEventListener("click",_event=>{"function"==typeof callback&&(callback(input.value),this.setDirty(!0)),Lite.debug&&console.debug("prompt v2 OK",input.value,callback),dialog.close()});title=multiline.getBoundingClientRect(),value=-20,selInDia=-20;return title&&(value-=title.left,selInDia-=title.top),event?(dialog.style.left=event.clientX+value+"px",dialog.style.top=event.clientY+selInDia+"px"):(dialog.style.left=.5*multiline.width+value+"px",dialog.style.top=.5*multiline.height+selInDia+"px"),setTimeout(function(){input.focus()},10),dialog}showSearchBox(event,options){var selIn,selOut,prevent_timeout,timeout_close,def_options={slot_from:null,node_from:null,node_to:null,do_type_filter:Lite.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:Lite.search_hide_on_mouse_leave,show_all_if_empty:!0,show_all_on_open:Lite.search_show_all_on_open},that=(options=Object.assign(def_options,options||{}),this),graphcanvas=Canvas.active_canvas,canvas=graphcanvas.canvas,root_document=canvas.ownerDocument||document,dialog=document.createElement("div"),helper=(dialog.className="litegraph litesearchbox graphdialog rounded",dialog.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",options.do_type_filter&&(dialog.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",dialog.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),options.show_close_button&&(dialog.innerHTML+="<button class='close_searchbox close'>X</button>"),dialog.innerHTML+="<div class='helper'></div>",root_document.fullscreenElement?root_document.fullscreenElement.appendChild(dialog):(root_document.body.appendChild(dialog),root_document.body.style.overflow="hidden"),options.do_type_filter&&(selIn=dialog.querySelector(".slot_in_type_filter"),selOut=dialog.querySelector(".slot_out_type_filter")),dialog.close=function(){that.search_box=null,this.blur(),canvas.focus(),root_document.body.style.overflow="",setTimeout(function(){that.canvas.focus()},20),dialog.parentNode&&dialog.parentNode.removeChild(dialog)},1<this.ds.scale&&(dialog.style.transform=`scale(${this.ds.scale})`),options.hide_on_mouse_leave&&(prevent_timeout=!1,timeout_close=null,dialog.addEventListener("pointerenter",function(_event){timeout_close&&(clearTimeout(timeout_close),timeout_close=null)}),dialog.addEventListener("pointerleave",function(_event){prevent_timeout||(timeout_close=setTimeout(function(){dialog.close()},500))}),options.do_type_filter)&&(selIn.addEventListener("click",function(_event){prevent_timeout++}),selIn.addEventListener("blur",function(_event){prevent_timeout=0}),selIn.addEventListener("change",function(_event){prevent_timeout=-1}),selOut.addEventListener("click",function(_event){prevent_timeout++}),selOut.addEventListener("blur",function(_event){prevent_timeout=0}),selOut.addEventListener("change",function(_event){prevent_timeout=-1})),that.search_box&&that.search_box.close(),(that.search_box=dialog).querySelector(".helper")),first=null,timeout=null,selected=null,input=dialog.querySelector("input");if(input&&(input.addEventListener("blur",function(_event){that.search_box&&this.focus()}),input.addEventListener("keydown",function(e){if(38==e.keyCode)changeSelection(!1);else if(40==e.keyCode)changeSelection(!0);else if(27==e.keyCode)dialog.close();else{if(13!=e.keyCode)return timeout&&clearInterval(timeout),void(timeout=setTimeout(refreshHelper,250));refreshHelper(),selected?select(selected.innerHTML):first?select(first):dialog.close()}return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!0})),options.do_type_filter){if(selIn){var aSlots=Lite.slot_types_in,nSlots=aSlots.length;options.type_filter_in!=Lite.EVENT&&options.type_filter_in!=Lite.ACTION||(options.type_filter_in="_event_");for(let iK=0;iK<nSlots;iK++){var opt=document.createElement("option");opt.value=aSlots[iK],opt.innerHTML=aSlots[iK],selIn.appendChild(opt),!1!==options.type_filter_in&&(options.type_filter_in+"").toLowerCase()==(aSlots[iK]+"").toLowerCase()&&(opt.selected=!0)}selIn.addEventListener("change",function(){refreshHelper()})}if(selOut){let aSlots=Lite.slot_types_out,nSlots=aSlots.length;options.type_filter_out!=Lite.EVENT&&options.type_filter_out!=Lite.ACTION||(options.type_filter_out="_event_");for(let iK=0;iK<nSlots;iK++){let opt=document.createElement("option");opt.value=aSlots[iK],opt.innerHTML=aSlots[iK],selOut.appendChild(opt),!1!==options.type_filter_out&&(options.type_filter_out+"").toLowerCase()==(aSlots[iK]+"").toLowerCase()&&(opt.selected=!0)}selOut.addEventListener("change",function(){refreshHelper()})}}options.show_close_button&&dialog.querySelector(".close").addEventListener("click",dialog.close);var def_options=canvas.getBoundingClientRect(),left=(event?event.clientX:def_options.left+.5*def_options.width)-80,top=(event?event.clientY:def_options.top+.5*def_options.height)-20;function select(name){if(name)if(that.onSearchBoxSelection)that.onSearchBoxSelection(name,event,graphcanvas);else{var extra=Lite.searchbox_extras[name.toLowerCase()],node=(extra&&(name=extra.type),graphcanvas.graph.beforeChange(),Lite.createNode(name));if(node&&(node.pos=graphcanvas.convertEventToCanvasOffset(event),graphcanvas.graph.add(node,!1,{doProcessChange:!1})),extra&&extra.data){if(extra.data.properties)for(var i in extra.data.properties)node.addProperty(i,extra.data.properties[i]);if(extra.data.inputs){node.inputs=[];for(let i in extra.data.inputs)node.addOutput(extra.data.inputs[i][0],extra.data.inputs[i][1])}if(extra.data.outputs){node.outputs=[];for(let i in extra.data.outputs)node.addOutput(extra.data.outputs[i][0],extra.data.outputs[i][1])}extra.data.title&&(node.title=extra.data.title),extra.data.json&&node.configure(extra.data.json)}let iS;if(options.node_from){switch(iS=!1,typeof options.slot_from){case"string":iS=options.node_from.findOutputSlot(options.slot_from);break;case"object":-1==(iS=options.slot_from.name?options.node_from.findOutputSlot(options.slot_from.name):-1)&&void 0!==options.slot_from.slot_index&&(iS=options.slot_from.slot_index);break;case"number":iS=options.slot_from;break;default:iS=0}void 0!==options.node_from.outputs[iS]&&!1!==iS&&-1<iS&&options.node_from.connectByType(iS,node,options.node_from.outputs[iS].type)}if(options.node_to){switch(iS=!1,typeof options.slot_from){case"string":iS=options.node_to.findInputSlot(options.slot_from);break;case"object":-1==(iS=options.slot_from.name?options.node_to.findInputSlot(options.slot_from.name):-1)&&void 0!==options.slot_from.slot_index&&(iS=options.slot_from.slot_index);break;case"number":iS=options.slot_from;break;default:iS=0}void 0!==options.node_to.inputs[iS]&&!1!==iS&&-1<iS&&options.node_to.connectByTypeOutput(iS,node,options.node_to.inputs[iS].type)}graphcanvas.graph.afterChange()}dialog.close()}function changeSelection(forward){var prev=selected;selected&&selected.classList.remove("selected"),(selected=selected?(selected=forward?selected.nextSibling:selected.previousSibling)||prev:forward?helper.childNodes[0]:helper.childNodes[helper.childNodes.length])&&(selected.classList.add("selected"),selected.scrollIntoView({block:"end",behavior:"smooth"}))}function refreshHelper(){timeout=null;var str=input.value;if(first=null,helper.innerHTML="",str||options.show_all_if_empty)if(that.onSearchBox){var list=that.onSearchBox(helper,str,graphcanvas);if(list)for(let i=0;i<list.length;++i)addResult(list[i])}else{var i,c=0,str=str.toLowerCase(),filter=graphcanvas.filter||graphcanvas.graph.filter;let sIn,sOut;for(i in sOut=options.do_type_filter&&that.search_box?(sIn=that.search_box.querySelector(".slot_in_type_filter"),that.search_box.querySelector(".slot_out_type_filter")):sIn=!1,Lite.searchbox_extras){var extra=Lite.searchbox_extras[i];if(options.show_all_if_empty&&!str||-1!==extra.desc.toLowerCase().indexOf(str)){var ctor=Lite.registered_node_types[extra.type];if((!ctor||ctor.filter==filter)&&inner_test_filter(extra.type)&&(addResult(extra.desc,"searchbox_extra"),-1!==Canvas.search_limit)&&c++>Canvas.search_limit)break}}var filtered=null;if(Array.prototype.filter)filtered=Object.keys(Lite.registered_node_types).filter(inner_test_filter);else{filtered=[];for(let i in Lite.registered_node_types)inner_test_filter(i)&&filtered.push(i)}for(let i=0;i<filtered.length&&(addResult(filtered[i]),!(-1!==Canvas.search_limit&&c++>Canvas.search_limit));i++);if(options.show_general_after_typefiltered&&(sIn.value||sOut.value)){filtered_extra=[];for(let i in Lite.registered_node_types)inner_test_filter(i,{inTypeOverride:!(!sIn||!sIn.value)&&"*",outTypeOverride:!(!sOut||!sOut.value)&&"*"})&&filtered_extra.push(i);for(let i=0;i<filtered_extra.length&&(addResult(filtered_extra[i],"generic_type"),!(-1!==Canvas.search_limit&&c++>Canvas.search_limit));i++);}if((sIn.value||sOut.value)&&0==helper.childNodes.length&&options.show_general_if_none_on_typefilter){filtered_extra=[];for(let i in Lite.registered_node_types)inner_test_filter(i,{skipFilter:!0})&&filtered_extra.push(i);for(let i=0;i<filtered_extra.length&&(addResult(filtered_extra[i],"not_in_filter"),!(-1!==Canvas.search_limit&&c++>Canvas.search_limit));i++);}function inner_test_filter(type,optsIn={}){var optsIn=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},optsIn),ctor=Lite.registered_node_types[type];if(filter&&ctor.filter!=filter)return!1;if((!options.show_all_if_empty||str)&&-1===type.toLowerCase().indexOf(str))return!1;if(options.do_type_filter&&!optsIn.skipFilter){ctor=type;let doesInc;type=sIn.value;if(!1!==optsIn.inTypeOverride&&(type=optsIn.inTypeOverride),sIn&&type&&Lite.registered_slot_in_types[type]&&Lite.registered_slot_in_types[type].nodes&&!1===(doesInc=Lite.registered_slot_in_types[type].nodes.includes(ctor)))return!1;if(type=sOut.value,!1!==optsIn.outTypeOverride&&(type=optsIn.outTypeOverride),sOut&&type&&Lite.registered_slot_out_types[type]&&Lite.registered_slot_out_types[type].nodes&&!1===(doesInc=Lite.registered_slot_out_types[type].nodes.includes(ctor)))return!1}return!0}}function addResult(type,className){var help=document.createElement("div");first=first||type,help.innerText=type,help.dataset.type=escape(type),help.className="litegraph lite-search-item",className&&(help.className+=" "+className),help.addEventListener("click",function(_event){select(unescape(this.dataset.type))}),helper.appendChild(help)}}return def_options.width-left<470&&(left=def_options.width-470),def_options.height-top<220&&(top=def_options.height-220),left<def_options.left+20&&(left=def_options.left+20),top<def_options.top+20&&(top=def_options.top+20),dialog.style.left=left+"px",dialog.style.top=top+"px",input.focus(),options.show_all_on_open&&refreshHelper(),dialog}showEditPropertyValue(node,property,options){if(node&&void 0!==node.properties[property]){options=options||{};var info=node.getPropertyInfo(property),type=info.type;let input_html;if("string"==type||"number"==type||"array"==type||"object"==type)input_html="<input autofocus type='text' class='value'/>";else if("enum"!=type&&"combo"!=type||!info.values){if("boolean"!=type&&"toggle"!=type)return void console.warn("unknown type: "+type);input_html="<input autofocus type='checkbox' class='value' "+(node.properties[property]?"checked":"")+"/>"}else{for(var i in Lite.debug&&console.debug("CREATING showEditPropertyValue ENUM COMBO",input,type,dialog),input_html="<select autofocus type='text' class='value'>",info.values){var v=i;info.values.constructor===Array&&(v=info.values[i]),input_html+="<option value='"+v+"' "+(v==node.properties[property]?"selected":"")+">"+info.values[i]+"</option>"}input_html+="</select>"}var dialog=this.createDialog("<span class='name'>"+(info.label||property)+"</span>"+input_html+"<button>OK</button>",options),input=!1;return"enum"!=type&&"combo"!=type||!info.values?"boolean"==type||"toggle"==type?(Lite.debug&&console.debug("showEditPropertyValue TOGGLE",input,type,dialog),(input=dialog.querySelector("input"))&&input.addEventListener("click",function(_event){dialog.modified(),setValue(!!input.checked)})):(input=dialog.querySelector("input"),Lite.debug&&console.debug("showEditPropertyValue",input,type,dialog),input&&(input.addEventListener("blur",function(_event){this.focus()}),v=void 0!==node.properties[property]?node.properties[property]:"","string"!==type&&(v=JSON.stringify(v)),input.value=v,input.addEventListener("keydown",function(e){if(27==e.keyCode)dialog.close();else if(13==e.keyCode)inner();else if(13!=e.keyCode)return void dialog.modified();e.preventDefault(),e.stopPropagation()}))):(Lite.debug&&console.debug("showEditPropertyValue ENUM COMBO",input,type,dialog),(input=dialog.querySelector("select")).addEventListener("change",function(e){dialog.modified(),Lite.debug&&console.debug("Enum change",input,info,e.target),setValue(e.target.value)})),input&&input.focus(),dialog.querySelector("button").addEventListener("click",inner),dialog;function inner(){setValue(input.value)}function setValue(value){info&&info.values&&info.values.constructor===Object&&null!=info.values[value]&&(value=info.values[value]),"number"==typeof node.properties[property]&&(value=Number(value)),"array"!=type&&"object"!=type||(value=JSON.parse(value)),node.properties[property]=value,node.graph?.onGraphChanged({action:"propertyChanged",doSave:!0}),node.onPropertyChanged&&node.onPropertyChanged(property,value),options.onclose&&options.onclose(),dialog.close(),node.setDirtyCanvas(!0,!0)}}}createDialog(html,options){options=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},options||{});var dialog=document.createElement("div"),html=(dialog.className="graphdialog",dialog.innerHTML=html,dialog.is_modified=!1,this.canvas.getBoundingClientRect()),offsetx=-20,offsety=-20,dialogCloseTimer=(html&&(offsetx-=html.left,offsety-=html.top),options.position?(offsetx+=options.position[0],offsety+=options.position[1]):options.event?(offsetx+=options.event.clientX,offsety+=options.event.clientY):(offsetx+=.5*this.canvas.width,offsety+=.5*this.canvas.height),dialog.style.left=offsetx+"px",dialog.style.top=offsety+"px",this.canvas.parentNode.appendChild(dialog),options.checkForInput&&(html=[],html=dialog.querySelectorAll("input"))&&html.forEach(function(iX){iX.addEventListener("keydown",function(e){if(dialog.modified(),27==e.keyCode)dialog.close();else if(13!=e.keyCode)return;e.preventDefault(),e.stopPropagation()}),iX.focus()}),dialog.modified=function(){dialog.is_modified=!0},dialog.close=function(){dialog.parentNode&&dialog.parentNode.removeChild(dialog)},null),prevent_timeout=!1,offsetx=(dialog.addEventListener("pointerleave",function(_event){prevent_timeout||(options.closeOnLeave||Lite.dialog_close_on_mouse_leave)&&!dialog.is_modified&&Lite.dialog_close_on_mouse_leave&&(dialogCloseTimer=setTimeout(dialog.close,Lite.dialog_close_on_mouse_leave_delay))}),dialog.addEventListener("pointerenter",function(_event){(options.closeOnLeave||Lite.dialog_close_on_mouse_leave)&&dialogCloseTimer&&clearTimeout(dialogCloseTimer)}),dialog.querySelectorAll("select"));return offsetx&&offsetx.forEach(function(selIn){selIn.addEventListener("click",function(_event){prevent_timeout++}),selIn.addEventListener("blur",function(_event){prevent_timeout=0}),selIn.addEventListener("change",function(_event){prevent_timeout=-1})}),dialog}createPanel(title,options){var ref_window=(options=options||{}).window||window,root=document.createElement("div");return root.className="litegraph dialog",root.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",root.header=root.querySelector(".dialog-header"),options.width&&(root.style.width=options.width+(options.width.constructor===Number?"px":"")),options.height&&(root.style.height=options.height+(options.height.constructor===Number?"px":"")),options.closable&&((options=document.createElement("span")).innerHTML="&#10005;",options.classList.add("close"),options.addEventListener("click",function(){root.close()}),root.header.appendChild(options)),root.title_element=root.querySelector(".dialog-title"),root.title_element.innerText=title,root.content=root.querySelector(".dialog-content"),root.alt_content=root.querySelector(".dialog-alt-content"),root.footer=root.querySelector(".dialog-footer"),root.close=function(){root.onClose&&"function"==typeof root.onClose&&root.onClose(),root.parentNode&&root.parentNode.removeChild(root),this.parentNode&&this.parentNode.removeChild(this)},root.toggleAltContent=function(force){let vTo,vAlt;vAlt=void 0!==force?(vTo=force?"block":"none",force?"none":"block"):(vTo="block"!=root.alt_content.style.display?"block":"none","block"!=root.alt_content.style.display?"none":"block"),root.alt_content.style.display=vTo,root.content.style.display=vAlt},root.toggleFooterVisibility=function(force){let vTo;vTo=void 0!==force?force?"block":"none":"block"!=root.footer.style.display?"block":"none",root.footer.style.display=vTo},root.clear=function(){this.content.innerHTML=""},root.addHTML=function(code,classname,on_footer){var elem=document.createElement("div");return classname&&(elem.className=classname),elem.innerHTML=code,(on_footer?root.footer:root.content).appendChild(elem),elem},root.addButton=function(name,callback,options){var elem=document.createElement("button");return elem.innerText=name,elem.options=options,elem.classList.add("btn"),elem.addEventListener("click",callback),root.footer.appendChild(elem),elem},root.addSeparator=function(){var elem=document.createElement("div");elem.className="separator",root.content.appendChild(elem)},root.addWidget=function(type,name,value,options,callback){options=options||{};var str_value=String(value),elem=("number"==(type=type.toLowerCase())&&(str_value=value.toFixed(3)),document.createElement("div")),value_element=(elem.className="property",elem.innerHTML="<span class='property_name'></span><span class='property_value'></span>",elem.querySelector(".property_name").innerText=options.label||name,elem.querySelector(".property_value"));function innerChange(name,value){Lite.debug&&console.debug("widgetInnerChange",name,value,options),options.callback&&options.callback(name,value,options),callback&&callback(name,value,options)}return value_element.innerText=str_value,elem.dataset.property=name,elem.dataset.type=options.type||type,elem.options=options,elem.value=value,Lite.debug&&console.debug("addWidget",type,value,value_element,options),"code"==type?elem.addEventListener("click",function(_event){root.inner_showCodePad(this.dataset.property)}):"boolean"==type?(elem.classList.add("boolean"),value&&elem.classList.add("bool-on"),elem.addEventListener("click",function(){var propname=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"true":"false",innerChange(propname,this.value)})):"string"==type||"number"==type?(value_element.setAttribute("contenteditable",!0),value_element.addEventListener("keydown",function(e){"Enter"!=e.code||"string"==type&&e.shiftKey||(e.preventDefault(),this.blur())}),value_element.addEventListener("blur",function(){var v=this.innerText;innerChange(this.parentNode.dataset.property,v="number"==this.parentNode.dataset.type?Number(v):v)})):"enum"!=type&&"combo"!=type||(str_value=Canvas.getPropertyPrintableValue(value,options.values),value_element.innerText=str_value,Lite.debug&&console.debug("addWidget ENUM COMBO",type,str_value,value_element,options),value_element.addEventListener("click",function(event){var values=options.values||[],propname=this.parentNode.dataset.property,elem_that=this;new Lite.ContextMenu(values,{event:event,className:"dark",callback:function(v){return elem_that.innerText=v,innerChange(propname,v),!1}},ref_window)})),root.content.appendChild(elem),elem},root.onOpen&&"function"==typeof root.onOpen&&root.onOpen(),root}static getPropertyPrintableValue(value,values){if(!values)return String(value);if(values.constructor===Array)return String(value);if(values.constructor===Object){var k,desc_value="";for(k in values)if(values[k]==value){desc_value=k;break}return String(value)+" ("+desc_value+")"}}closePanels(){var panel=document.querySelector("#node-panel");panel&&panel.close(),(panel=document.querySelector("#option-panel"))&&panel.close()}showShowGraphOptionsPanel(refOpts,obEv){let graphcanvas;if(this.constructor&&"HTMLDivElement"==this.constructor.name){if(!obEv?.event?.target?.lgraphcanvas)return console.warn("References not found to add optionPanel",refOpts,obEv),void(Lite.debug&&console.debug("!obEv || !obEv.event || !obEv.event.target || !obEv.event.target.lgraphcanvas",obEv,obEv.event,obEv.event.target,obEv.event.target.lgraphcanvas));graphcanvas=obEv.event.target.lgraphcanvas}else graphcanvas=this;graphcanvas.closePanels();refOpts=graphcanvas.getCanvasWindow();panel=graphcanvas.createPanel("Options",{closable:!0,window:refOpts,onOpen:function(){graphcanvas.OPTIONPANEL_IS_OPEN=!0},onClose:function(){graphcanvas.OPTIONPANEL_IS_OPEN=!1,graphcanvas.options_panel=null}}),(graphcanvas.options_panel=panel).id="option-panel",panel.classList.add("settings"),panel.content.innerHTML="";var pI,fUpdate=(name,value,options)=>{options&&options.key&&(name=options.key),options.values&&(value=Object.values(options.values).indexOf(value)),graphcanvas[name]=value},aProps=Lite.availableCanvasOptions;for(pI in aProps.sort(),aProps){var pX=aProps[pI];panel.addWidget("boolean",pX,graphcanvas[pX],{key:pX,on:"True",off:"False"},fUpdate)}panel.addWidget("combo","Render mode",Lite.LINK_RENDER_MODES[graphcanvas.links_render_mode],{key:"links_render_mode",values:Lite.LINK_RENDER_MODES},fUpdate),panel.addSeparator(),panel.footer.innerHTML="",graphcanvas.canvas.parentNode.appendChild(panel)}showShowNodePanel(node){this.SELECTED_NODE=node,this.closePanels();var ref_window=this.getCanvasWindow(),graphcanvas=this,panel=this.createPanel(node.title||"",{closable:!0,window:ref_window,onOpen:function(){graphcanvas.NODEPANEL_IS_OPEN=!0},onClose:function(){graphcanvas.NODEPANEL_IS_OPEN=!1,graphcanvas.node_panel=null}});function inner_refresh(){panel.content.innerHTML="",panel.addHTML("<span class='node_type'>"+node.type+"</span><span class='node_desc'>"+(node.constructor.desc||"")+"</span><span class='separator'></span>"),panel.addHTML("<h3>Properties</h3>");var pName,fUpdate=(name,value)=>{switch(graphcanvas.graph.beforeChange(node),name){case"Title":node.title=value;break;case"Mode":var kV=Object.values(Lite.NODE_MODES).indexOf(value);0<=kV&&Lite.NODE_MODES[kV]?node.changeMode(kV):console.warn("unexpected mode: "+value);break;case"Color":Canvas.node_colors[value]?(node.color=Canvas.node_colors[value].color,node.bgcolor=Canvas.node_colors[value].bgcolor):console.warn("unexpected color: "+value);break;default:node.setProperty(name,value)}graphcanvas.graph.afterChange(),graphcanvas.dirty_canvas=!0},nodeCol=(panel.addWidget("string","Title",node.title,{},fUpdate),panel.addWidget("combo","Mode",Lite.NODE_MODES[node.mode],{values:Lite.NODE_MODES},fUpdate),"");for(pName in void 0!==node.color&&(nodeCol=Object.keys(Canvas.node_colors).filter(function(nK){return Canvas.node_colors[nK].color==node.color})),panel.addWidget("combo","Color",nodeCol,{values:Object.keys(Canvas.node_colors)},fUpdate),node.properties){var value=node.properties[pName],info=node.getPropertyInfo(pName);node.onAddPropertyToPanel&&node.onAddPropertyToPanel(pName,panel,value,info,fUpdate)||panel.addWidget(info.widget||info.type,pName,value,info,fUpdate)}panel.addSeparator(),node.onShowCustomPanelInfo&&node.onShowCustomPanelInfo(panel),panel.footer.innerHTML="",panel.addButton("Delete",function(){node.block_delete||(node.graph.remove(node),panel.close())}).classList.add("delete")}(graphcanvas.node_panel=panel).id="node-panel",panel.node=node,panel.classList.add("settings"),panel.inner_showCodePad=function(propname){panel.classList.remove("settings"),panel.classList.add("centered"),panel.alt_content.innerHTML="<textarea class='code'></textarea>";var textarea=panel.alt_content.querySelector("textarea"),fDoneWith=()=>{panel.toggleAltContent(!1),panel.toggleFooterVisibility(!0),textarea.parentNode.removeChild(textarea),panel.classList.add("settings"),panel.classList.remove("centered"),inner_refresh()},assign=(textarea.value=node.properties[propname],textarea.addEventListener("keydown",function(e){"Enter"==e.code&&e.ctrlKey&&(node.setProperty(propname,textarea.value),fDoneWith())}),panel.toggleAltContent(!0),panel.toggleFooterVisibility(!1),textarea.style.height="calc(100% - 40px)",panel.addButton("Assign",function(){node.setProperty(propname,textarea.value),fDoneWith()})),assign=(panel.alt_content.appendChild(assign),panel.addButton("Close",fDoneWith));assign.style.float="right",panel.alt_content.appendChild(assign)},inner_refresh(),this.canvas.parentNode.appendChild(panel)}showSubgraphPropertiesDialog(node){Lite.debug&&console.log("showing subgraph properties dialog");var old_panel=this.canvas.parentNode.querySelector(".subgraph_dialog"),panel=(old_panel&&old_panel.close(),this.createPanel("Subgraph Inputs",{closable:!0,width:500}));function inner_refresh(){if(panel.clear(),node.inputs)for(let i=0;i<node.inputs.length;++i){var elem,input=node.inputs[i];input.not_subgraph_input||((elem=panel.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=input.name,elem.dataset.slot=i,elem.querySelector(".name").innerText=input.name,elem.querySelector(".type").innerText=input.type,elem.querySelector("button").addEventListener("click",function(_event){node.removeInput(Number(this.parentNode.dataset.slot)),inner_refresh()}))}}panel.node=node,panel.classList.add("subgraph_dialog");return panel.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",function(_event){var elem=this.parentNode,name=elem.querySelector(".name").value,type=elem.querySelector(".type").value;name&&-1==node.findInputSlot(name)&&(node.addInput(name,type),elem.querySelector(".name").value="",elem.querySelector(".type").value="",inner_refresh())}),inner_refresh(),this.canvas.parentNode.appendChild(panel),panel}showSubgraphPropertiesDialogRight(node){var old_panel=this.canvas.parentNode.querySelector(".subgraph_dialog"),panel=(old_panel&&old_panel.close(),this.createPanel("Subgraph Outputs",{closable:!0,width:500}));function inner_refresh(){if(panel.clear(),node.outputs)for(let i=0;i<node.outputs.length;++i){var elem,input=node.outputs[i];input.not_subgraph_output||((elem=panel.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property")).dataset.name=input.name,elem.dataset.slot=i,elem.querySelector(".name").innerText=input.name,elem.querySelector(".type").innerText=input.type,elem.querySelector("button").addEventListener("click",function(_event){node.removeOutput(Number(this.parentNode.dataset.slot)),inner_refresh()}))}}panel.node=node,panel.classList.add("subgraph_dialog");old_panel=panel.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);function addOutput(){var elem=this.parentNode,name=elem.querySelector(".name").value,type=elem.querySelector(".type").value;name&&-1==node.findOutputSlot(name)&&(node.addOutput(name,type),elem.querySelector(".name").value="",elem.querySelector(".type").value="",inner_refresh())}return old_panel.querySelector(".name").addEventListener("keydown",function(_event){13==e.keyCode&&addOutput.apply(this)}),old_panel.querySelector("button").addEventListener("click",function(_event){addOutput.apply(this)}),inner_refresh(),this.canvas.parentNode.appendChild(panel),panel}checkPanels(){if(this.canvas){var panels=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(let i=0;i<panels.length;++i){var panel=panels[i];!panel.node||panel.node.graph&&panel.graph==this.graph||panel.close()}}}static onMenuNodeCollapse(value,options,e,menu,node){node.graph.beforeChange();var graphcanvas=Canvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)node.collapse();else for(var i in graphcanvas.selected_nodes)graphcanvas.selected_nodes[i].collapse();node.graph.afterChange()}static onMenuNodePin(value,options,e,menu,node){node.pin()}static onMenuNodeMode(value,options,e,menu,node){return new Lite.ContextMenu(Lite.NODE_MODES,{event:e,callback:function(v){if(node){var kV=Object.values(Lite.NODE_MODES).indexOf(v),fApplyMultiNode=node=>{0<=kV&&Lite.NODE_MODES[kV]?node.changeMode(kV):(console.warn("unexpected mode: "+v),node.changeMode(Lite.ALWAYS))},graphcanvas=Canvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i])}},parentMenu:menu,node:node}),!1}static onMenuNodeColors(value,options,e,menu,node){if(!node)throw new Error("no node for color");var i,values=[];for(i in values.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),Canvas.node_colors){var color=Canvas.node_colors[i];value={value:i,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+color.color+"; background-color:"+color.bgcolor+"'>"+i+"</span>"},values.push(value)}return new Lite.ContextMenu(values,{event:e,callback:function(v){if(node){let color=v.value?Canvas.node_colors[v.value]:null;var fApplyColor=node=>{color?node.constructor===Lite.Group?node.color=color.groupcolor:(node.color=color.color,node.bgcolor=color.bgcolor):(delete node.color,delete node.bgcolor)},graphcanvas=Canvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyColor(node);else for(var i in graphcanvas.selected_nodes)fApplyColor(graphcanvas.selected_nodes[i]);node.setDirtyCanvas(!0,!0)}},parentMenu:menu,node:node}),!1}static onMenuNodeShapes(value,options,e,menu,node){if(node)return new Lite.ContextMenu(Lite.VALID_SHAPES,{event:e,callback:function(v){if(node){node.graph.beforeChange();var fApplyMultiNode=node=>{node.shape=v},graphcanvas=Canvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);node.graph.afterChange(),node.setDirtyCanvas(!0)}},parentMenu:menu,node:node}),!1;throw new Error("no node passed")}static onMenuNodeRemove(value,options,e,menu,node){if(!node)throw new Error("no node passed");var graph=node.graph,fApplyMultiNode=(graph.beforeChange(),node=>{!1!==node.removable&&graph.remove(node)}),graphcanvas=Canvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);graph.afterChange(),node.setDirtyCanvas(!0,!0)}static onMenuNodeToSubgraph(value,options,e,menu,node){var nodes_list,subgraph_node,graph=node.graph,graphcanvas=Canvas.active_canvas;graphcanvas&&((nodes_list=Object.values(graphcanvas.selected_nodes||{})).length||(nodes_list=[node]),(subgraph_node=Lite.createNode("graph/subgraph")).pos=node.pos.concat(),graph.add(subgraph_node),subgraph_node.buildFromNodes(nodes_list),graphcanvas.deselectAllNodes(),node.setDirtyCanvas(!0,!0))}static onMenuNodeClone(value,options,e,menu,node){node.graph.beforeChange();var newSelected={},fApplyMultiNode=node=>{var newnode;!1!==node.clonable&&(newnode=node.clone())&&(newnode.pos=[node.pos[0]+5,node.pos[1]+5],node.graph.add(newnode),newSelected[newnode.id]=newnode)},graphcanvas=Canvas.active_canvas;if(!graphcanvas.selected_nodes||Object.keys(graphcanvas.selected_nodes).length<=1)fApplyMultiNode(node);else for(var i in graphcanvas.selected_nodes)fApplyMultiNode(graphcanvas.selected_nodes[i]);Object.keys(newSelected).length&&graphcanvas.selectNodes(newSelected),node.graph.afterChange(),node.setDirtyCanvas(!0,!0)}getCanvasMenuOptions(){var extra,options=null;return this.getMenuOptions?options=this.getMenuOptions():(options=[{content:"Add Node",has_submenu:!0,callback:Canvas.onMenuAdd},{content:"Add Group",callback:Canvas.onGroupAdd}],Lite.showCanvasOptions&&options.push({content:"Options",callback:this.showShowGraphOptionsPanel}),1<Object.keys(this.selected_nodes).length&&options.push({content:"Align",has_submenu:!0,callback:Canvas.onGroupAlign}),this._graph_stack&&0<this._graph_stack.length&&options.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),options=this.getExtraMenuOptions&&(extra=this.getExtraMenuOptions(this,options))?options.concat(extra):options}getNodeMenuOptions(node){var inputs,options=null;return node.getMenuOptions?options=node.getMenuOptions(this):(!(options=[{content:"Inputs",has_submenu:!0,disabled:!0,callback:Canvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,disabled:!0,callback:Canvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:Canvas.onShowMenuNodeProperties},null,{content:"Title",callback:Canvas.onShowPropertyEditor},{content:"Mode",has_submenu:!0,callback:Canvas.onMenuNodeMode}])!==node.resizable&&options.push({content:"Resize",callback:Canvas.onMenuResizeNode}),options.push({content:"Collapse",callback:Canvas.onMenuNodeCollapse},{content:"Pin",callback:Canvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:Canvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:Canvas.onMenuNodeShapes},null)),node.onGetInputs&&(inputs=node.onGetInputs())&&inputs.length&&(options[0].disabled=!1),node.onGetOutputs&&(inputs=node.onGetOutputs())&&inputs.length&&(options[1].disabled=!1),Lite.do_add_triggers_slots&&(options[1].disabled=!1),node.getExtraMenuOptions&&(inputs=node.getExtraMenuOptions(this,options))&&(inputs.push(null),options=inputs.concat(options)),!1!==node.clonable&&options.push({content:"Clone",callback:Canvas.onMenuNodeClone}),1<Object.keys(this.selected_nodes).length&&options.push({content:"Align Selected To",has_submenu:!0,callback:Canvas.onNodeAlign}),options.push(null,{content:"Remove",disabled:!(!1!==node.removable&&!node.block_delete),callback:Canvas.onMenuNodeRemove}),node.graph&&node.graph.onGetNodeMenuOptions&&node.graph.onGetNodeMenuOptions(options,node),options}getGroupMenuOptions(){return[{content:"Title",callback:Canvas.onShowPropertyEditor},{content:"Color",has_submenu:!0,callback:Canvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:Canvas.onShowPropertyEditor},null,{content:"Remove",callback:Canvas.onMenuNodeRemove}]}processContextMenu(node,event){var _slot,that=this,ref_window=Canvas.active_canvas.getCanvasWindow(),menu_info=null,options={event:event,callback:function(v,options){if(v){let info;var slot_info,dialog,input,inner;"Remove Slot"==v.content?(info=v.slot,node.graph.beforeChange(),info.input?node.removeInput(info.slot):info.output&&node.removeOutput(info.slot),node.graph.afterChange()):"Disconnect Links"==v.content?(info=v.slot,node.graph.beforeChange(),info.output?node.disconnectOutput(info.slot):info.input&&node.disconnectInput(info.slot),node.graph.afterChange()):"Rename Slot"==v.content&&(slot_info=(info=v.slot).input?node.getInputInfo(info.slot):node.getOutputInfo(info.slot),dialog=that.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",options),(input=dialog.querySelector("input"))&&slot_info&&(input.value=slot_info.label||""),inner=function(){node.graph.beforeChange(),input.value&&(slot_info&&(slot_info.label=input.value),that.setDirty(!0)),dialog.close(),node.graph.afterChange()},dialog.querySelector("button").addEventListener("click",inner),input.addEventListener("keydown",function(e){if(dialog.is_modified=!0,27==e.keyCode)dialog.close();else if(13==e.keyCode)inner();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()}),input.focus())}},extra:node},slot=(node&&(options.title=node.type),null);node&&(slot=node.getSlotInPosition(event.canvasX,event.canvasY),Canvas.active_node=node),slot?(menu_info=[],node.getSlotMenuOptions?menu_info=node.getSlotMenuOptions(slot):((slot?.output?.links?.length||slot.input?.link)&&menu_info.push({content:"Disconnect Links",slot:slot}),(_slot=slot.input||slot.output).removable&&Lite.canRemoveSlots&&menu_info.push(_slot.locked?"Cannot remove":{content:"Remove Slot",slot:slot}),!_slot.nameLocked&&Lite.canRenameSlots&&menu_info.push({content:"Rename Slot",slot:slot})),_slot=slot.input||slot.output,options.title=_slot.type||"*",_slot.type==Lite.ACTION?options.title="Action":_slot.type==Lite.EVENT&&(options.title="Event")):node?menu_info=this.getNodeMenuOptions(node):(menu_info=this.getCanvasMenuOptions(),(slot=this.graph.getGroupOnPos(event.canvasX,event.canvasY))&&menu_info.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:slot,options:this.getGroupMenuOptions(slot)}})),menu_info&&new Lite.ContextMenu(menu_info,options,ref_window)}static DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=";static link_type_colors={"-1":"#A86",number:"#AAA",node:"#DCA",string:"#77F",boolean:"#F77"};static gradients={};static search_limit=-1;static node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}};lowQualityRenderingRequired(activation_scale){return this.ds.scale<activation_scale&&this.low_quality_rendering_counter>this.low_quality_rendering_threshold}}var temp=new Float32Array(4),temp_vec2=new Float32Array(2),tmp_area=new Float32Array(4),margin_area=new Float32Array(4),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);export{Canvas};

import{Lite}from"./Lite.js";class DragAndScale{constructor(element,skip_events){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),element&&(this.element=element,skip_events||this.bindEvents(element))}bindEvents(element){this.last_mouse=new Float32Array(2),element.addEventListener("pointerdown",this.onMouseDown),element.addEventListener("wheel",this.onWheel)}onMouseDown=event=>{var x,rect;this.enabled&&(rect=this.element.getBoundingClientRect(),x=event.clientX-rect.left,rect=event.clientY-rect.top,event.canvasx=x,event.canvasy=rect,event.dragging=this.dragging,(!this.viewport||this.viewport&&x>=this.viewport[0]&&x<this.viewport[0]+this.viewport[2]&&rect>=this.viewport[1]&&rect<this.viewport[1]+this.viewport[3])&&(this.dragging=!0,this.abortController=new AbortController,document.addEventListener("pointermove",this.onMouseMove,{signal:this.abortController.signal}),document.addEventListener("pointerup",this.onMouseUp,{signal:this.abortController.signal})),this.last_mouse[0]=x,this.last_mouse[1]=rect)};onMouseMove=event=>{var x,rect,deltay;this.enabled&&(rect=this.element.getBoundingClientRect(),x=event.clientX-rect.left,rect=event.clientY-rect.top,event.canvasx=x,event.canvasy=rect,event.dragging=this.dragging,event=x-this.last_mouse[0],deltay=rect-this.last_mouse[1],this.dragging&&this.mouseDrag(event,deltay),this.last_mouse[0]=x,this.last_mouse[1]=rect)};onMouseUp=_event=>{this.dragging=!1,this.abortController?.abort()};onWheel=event=>{event.wheel=-event.deltaY,event.delta=event.wheelDelta?event.wheelDelta/40:event.deltaY?-event.deltaY/3:0,this.changeDeltaScale(1+.05*event.delta)};computeVisibleArea(viewport){if(this.element){let width=this.element.width,height=this.element.height,startx=-this.offset[0],starty=-this.offset[1];viewport&&(startx+=viewport[0]/this.scale,starty+=viewport[1]/this.scale,[viewport,vpHeight]=viewport.slice(2),width=viewport,height=vpHeight);var viewport=startx+width/this.scale,vpHeight=starty+height/this.scale;this.visible_area.set([startx,starty,viewport-startx,vpHeight-starty])}else this.visible_area.set([0,0,0,0])}toCanvasContext(ctx){ctx.scale(this.scale,this.scale),ctx.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(pos){return[(pos[0]+this.offset[0])*this.scale,(pos[1]+this.offset[1])*this.scale]}convertCanvasToOffset(pos,out=[0,0]){return out[0]=pos[0]/this.scale-this.offset[0],out[1]=pos[1]/this.scale-this.offset[1],out}mouseDrag(x,y){this.offset[0]+=x/this.scale,this.offset[1]+=y/this.scale,this.onredraw?.(this)}changeScale(value,zooming_center){var rect;(value=Lite.clamp(value,this.min_scale,this.max_scale))!=this.scale&&this.element&&(rect=this.element.getBoundingClientRect())&&(zooming_center=zooming_center||[.5*rect.width,.5*rect.height],rect=this.convertCanvasToOffset(zooming_center),this.scale=value,Math.abs(this.scale-1)<.01&&(this.scale=1),zooming_center=[(value=this.convertCanvasToOffset(zooming_center))[0]-rect[0],value[1]-rect[1]],this.offset[0]+=zooming_center[0],this.offset[1]+=zooming_center[1],this.onredraw?.(this))}changeDeltaScale(value,zooming_center){this.changeScale(this.scale*value,zooming_center)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}export{DragAndScale};

import{Lite}from"./Lite.js";class Node{constructor(title="Unnamed"){this.title=title,this.size=[Lite.NODE_WIDTH,60],this.graph=null,this._pos=new Float32Array(10,10),Lite.use_uuids?this.id=Lite.uuidv4():this.id=-1,this.type=null,this.inputs=[],this.outputs=[],this.connections=[],this.properties={},this.properties_info=[],this.flags={}}set pos(v){!v||v.length<2||(this._pos??=new Float32Array(10,10),this._pos[0]=v[0],this._pos[1]=v[1])}get pos(){return this._pos}configure(info){Object.entries(info).forEach(([key,value])=>{if("properties"===key)for(var k in value)this.properties[k]=value[k],this.onPropertyChanged?.(k,value[k]);else null!==value&&("object"==typeof value?this[key]&&this[key].configure?this[key].configure(value):this[key]=Lite.cloneObject(value,this[key]):this[key]=value)}),info.title||(this.title=this.constructor.title),this.inputs?.forEach((input,i)=>{var link_info;input.link&&(link_info=this.graph?this.graph.links[input.link]:null,this.onConnectionsChange?.(Lite.INPUT,i,!0,link_info,input),this.onInputAdded?.(input))}),this.outputs?.forEach((output,i)=>{output.links&&(output.links.forEach(link=>{var link_info=this.graph;this.onConnectionsChange?.(Lite.OUTPUT,i,!0,link_info,output)}),this.onOutputAdded?.(output))}),this.widgets&&(this.widgets.forEach(w=>{w&&w.options&&w.options.property&&void 0!==this.properties[w.options.property]&&(w.value=JSON.parse(JSON.stringify(this.properties[w.options.property])))}),info.widgets_values?.forEach((value,i)=>{this.widgets[i]&&(this.widgets[i].value=value)})),this.onConfigure?.(info),this.graph?.onGraphChanged({action:"nodeConfigure",doSave:!1})}serialize(){var o={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:Lite.cloneObject(this.flags),order:this.order,mode:this.mode};return this.constructor===Node&&this.last_serialization?this.last_serialization:(this.inputs&&(o.inputs=Lite.cloneObject(this.inputs)),this.outputs&&(this.outputs.forEach(output=>{delete output._data}),o.outputs=Lite.cloneObject(this.outputs)),this.title&&this.title!=this.constructor.title&&(o.title=this.title),this.properties&&(o.properties=Lite.cloneObject(this.properties)),this.widgets&&this.serialize_widgets&&(o.widgets_values=this.widgets.map(widget=>widget?.value??null)),o.type??=this.constructor.type,this.color&&(o.color=this.color),this.bgcolor&&(o.bgcolor=this.bgcolor),this.boxcolor&&(o.boxcolor=this.boxcolor),this.shape&&(o.shape=this.shape),this.onSerialize?.(o)&&console.warn("node onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),o)}clone(){var data,node=Lite.createNode(this.type);return node?((data=Lite.cloneObject(this.serialize())).inputs?.forEach(input=>{input.link=null}),data.outputs?.forEach(output=>{output.links&&(output.links.length=0)}),delete data.id,Lite.use_uuids&&(data.id=Lite.uuidv4()),node.configure(data),node):null}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title??this.constructor.title}setProperty(name,value){var prevValue;this.properties||={},value!==this.properties[name]&&(prevValue=this.properties[name],this.properties[name]=value,!1===this.onPropertyChanged?.(name,value,prevValue)&&(this.properties[name]=prevValue),prevValue=this.widgets?.find(widget=>widget&&widget.options?.property===name))&&(prevValue.value=value)}setOutputData(slot,data){if(this.outputs){if(slot?.constructor===String)slot=this.findOutputSlot(slot);else if(-1==slot||slot>=this.outputs.length)return;var output_info=this.outputs[slot];output_info&&(output_info._data=data,this.outputs[slot].links?.forEach(link_id=>{link_id=this.graph.links[link_id];link_id&&(link_id.data=data)}))}}setOutputDataType(slot,type){var output_info;!this.outputs||-1==slot||slot>=this.outputs.length||(output_info=this.outputs[slot])&&(output_info.type=type,this.outputs[slot]?.links?.forEach(link_id=>{this.graph.links[link_id]&&(this.graph.links[link_id].type=type)}))}getInputData(slot,force_update,refresh_tree){if(this.inputs&&!(slot>=this.inputs.length||null==this.inputs[slot].link))return slot=this.inputs[slot].link,(slot=this.graph.links[slot])?(force_update&&(force_update=this.graph.getNodeById(slot.origin_id))&&(refresh_tree&&(refresh_tree=this.id+"_getInputData_forced_"+Math.floor(9999*Math.random()),this.refreshAncestors({action:refresh_tree,options:{action_call:refresh_tree}})),force_update.updateOutputData?force_update.updateOutputData(slot.origin_slot):force_update.doExecute?.()),slot.data):null}getInputDataType(slot){var node;return this.inputs&&!(slot>=this.inputs.length||null==this.inputs[slot].link)&&(slot=this.inputs[slot].link,slot=this.graph.links[slot])?(node=this.graph.getNodeById(slot.origin_id))?(node=node.outputs[slot.origin_slot])?node.type:null:slot.type:null}getInputDataByName(slot_name,force_update){slot_name=this.findInputSlot(slot_name);return-1==slot_name?null:this.getInputData(slot_name,force_update)}isInputConnected(slot){return!!this.inputs&&slot<this.inputs.length&&null!=this.inputs[slot].link}getInputInfo(slot){return this.inputs&&slot<this.inputs.length?this.inputs[slot]:null}getInputLink(slot){return this.inputs&&slot<this.inputs.length?(slot=this.inputs[slot],this.graph.links[slot.link]):null}getInputNode(slot){return this.inputs&&!(slot>=this.inputs.length)&&(slot=this.inputs[slot])&&null!==slot.link&&(slot=this.graph.links[slot.link])?this.graph.getNodeById(slot.origin_id):null}getInputOrProperty(name){if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i){var input_info=this.inputs[i];if(name==input_info.name&&null!=input_info.link){input_info=this.graph.links[input_info.link];if(input_info)return input_info.data}}return this.properties?this.properties[name]:null}getOutputData(slot){return!this.outputs||slot>=this.outputs.length?null:this.outputs[slot]._data}getOutputInfo(slot){return this.outputs&&slot<this.outputs.length?this.outputs[slot]:null}isOutputConnected(slot){return!!this.outputs&&slot<this.outputs.length&&this.outputs[slot].links&&this.outputs[slot].links.length}isAnyOutputConnected(){return!!this.outputs&&this.outputs.some(output=>output.links&&output.links.length)}getOutputNodes(slot){return this.outputs&&!(slot>=this.outputs.length)&&(slot=this.outputs[slot]).links&&0!==slot.links.length?slot.links.map(link_id=>this.graph.links[link_id]).filter(link=>link).map(link=>this.graph.getNodeById(link.target_id)).filter(target_node=>target_node):null}addOnTriggerInput(){var trigS=this.findInputSlot("onTrigger");return-1==trigS?(this.addInput("onTrigger",Lite.EVENT,{removable:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):trigS}addOnExecutedOutput(){var trigS=this.findOutputSlot("onExecuted");return-1==trigS?(this.addOutput("onExecuted",Lite.ACTION,{removable:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):trigS}onAfterExecuteNode(param,options){var trigS=this.findOutputSlot("onExecuted");-1!=trigS&&(Lite.debug&&(console.debug(this.id+":"+this.order+" triggering slot onAfterExecute"),console.debug(param),console.debug(options)),this.triggerSlot(trigS,param,null,options))}changeMode(modeTo){switch(modeTo){case Lite.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case Lite.ON_EVENT:case Lite.NEVER:case Lite.ALWAYS:case Lite.ON_REQUEST:break;default:return!1}return this.mode=modeTo,!0}executePendingActions(){this._waiting_actions&&this._waiting_actions.length&&(this._waiting_actions.forEach(p=>{this.onAction(p[0],p[1],p[2],p[3],p[4])}),this._waiting_actions.length=0)}doExecute(param,options={}){if(this.onExecute){if(options.action_call??=this.id+"_exec_"+Math.floor(9999*Math.random()),this.graph.nodes_executing&&this.graph.nodes_executing[this.id])return void(Lite.debug&&console.debug("NODE already executing! Prevent! "+this.id+":"+this.order));if(Lite.ensureNodeSingleExecution&&this.exec_version&&this.exec_version>=this.graph.iteration&&void 0!==this.exec_version)return void(Lite.debug&&console.debug("!! NODE already EXECUTED THIS STEP !! "+this.exec_version));if(Lite.ensureUniqueExecutionAndActionCall&&this.graph.nodes_executedAction[this.id]&&options&&options.action_call&&this.graph.nodes_executedAction[this.id]==options.action_call)return void(Lite.debug&&console.debug("!! NODE already ACTION THIS STEP !! "+options.action_call));this.graph.nodes_executing[this.id]=!0,this.onExecute(param,options),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,options&&options.action_call&&(this.action_call=options.action_call,this.graph.nodes_executedAction[this.id]=options.action_call)}this.execute_triggered=2,this.onAfterExecuteNode?.(param,options)}execute(param,options={}){return this.doExecute(param,options)}actionDo(action,param,options={},action_slot){if(this.onAction){if(options.action_call??=this.id+`_${action||"action"}_`+Math.floor(9999*Math.random()),Lite.ensureNodeSingleAction&&this.graph.nodes_actioning&&this.graph.nodes_actioning[this.id]==options.action_call)return;if(Lite.debug&&console.debug("CheckActioned ? "+this.id+":"+this.order+" :: "+this.action_call),Lite.ensureUniqueExecutionAndActionCall&&this.graph.nodes_executedAction[this.id]&&options&&options.action_call&&this.graph.nodes_executedAction[this.id]==options.action_call)return void(Lite.debug&&(console.debug("!! NODE already ACTION THIS STEP !! "+options.action_call),ç));this.graph.nodes_actioning[this.id]=action||"actioning",this.onAction(action,param,options,action_slot),this.graph.nodes_actioning[this.id]=!1,options&&options.action_call&&(this.action_call=options.action_call,this.graph.nodes_executedAction[this.id]=options.action_call)}this.action_triggered=2,this.onAfterExecuteNode?.(param,options)}trigger(action,param,options){this.outputs&&0!==this.outputs.length&&(this.graph&&(this.graph._last_trigger_time=Lite.getTime()),this.outputs.forEach((output,i)=>{!output||output.type!==Lite.EVENT||action&&output.name!==action||this.triggerSlot(i,param,null,options)}))}triggerSlot(slot,param,link_id,options={}){if(this.outputs)if(null==slot)console.error("slot must be a number");else{slot.constructor!==Number&&console.warn("slot must be a number, use node.trigger('name') if you want to use a string");slot=this.outputs[slot];if(slot){var links=slot.links;if(links&&links.length&&(!this.graph||!this.graph.ancestorsCall)){this.graph&&(this.graph._last_trigger_time=Lite.getTime());for(var k=0;k<links.length;++k){var node,target_connection,id=links[k];null!=link_id&&link_id!=id||(id=this.graph.links[links[k]])&&(id._last_time=Lite.getTime(),node=this.graph.getNodeById(id.target_id))&&(node.mode===Lite.ON_TRIGGER?(options.action_call||(options.action_call=this.id+"_trigg_"+Math.floor(9999*Math.random())),Lite.refreshAncestorsOnTriggers&&node.refreshAncestors({action:"trigger",param:param,options:options}),node.onExecute&&node.doExecute(param,options)):node.onAction&&(options.action_call||(options.action_call=this.id+"_act_"+Math.floor(9999*Math.random())),target_connection=node.inputs[id.target_slot],Lite.debug&&console.debug("will call onACTION: "+this.id+":"+this.order+" :: "+target_connection.name),Lite.refreshAncestorsOnActions&&node.refreshAncestors({action:target_connection.name,param:param,options:options}),Lite.use_deferred_actions&&node.onExecute?(node._waiting_actions??=[],node._waiting_actions.push([target_connection.name,param,options,id.target_slot])):node.actionDo(target_connection.name,param,options,id.target_slot)))}}}}}clearTriggeredSlot(slot,link_id){this.outputs&&this.outputs[slot]&&this.outputs[slot].links&&this.outputs[slot].links.forEach(id=>{null!==link_id&&link_id!==id||(id=this.graph.links[id])&&(id._last_time=0)})}setSize(size){this.size=size,this.onResize?.(this.size)}addProperty(name,default_value,type,extra_info){type={name:name,type:type,default_value:default_value,...extra_info};return this.properties_info=this.properties_info??[],this.properties_info.push(type),this.properties=this.properties??{},this.properties[name]=default_value,type}addInput(name,type,extra_info){return this.addSlot(name,type,extra_info,!0)}addOutput(name,type,extra_info){return this.addSlot(name,type,extra_info,!1)}addSlot(name,type,extra_info,isInput){name=isInput?{name:name,type:type,link:null,...extra_info}:{name:name,type:type,links:null,...extra_info};return isInput?(this.inputs=this.inputs??[],this.inputs.push(name),this.onInputAdded?.(name),Lite.registerNodeAndSlotType(this,type)):(this.outputs=this.outputs??[],this.outputs.push(name),this.onOutputAdded?.(name),Lite.auto_load_slot_types&&Lite.registerNodeAndSlotType(this,type,!0)),this.setSize(this.computeSize()),this.setDirtyCanvas(!0,!0),name}addInputs(array){this.addSlots(array,!0)}addOutputs(array){this.addSlots(array,!1)}addSlots(array,isInput){(array="string"==typeof array?[array]:array).forEach(info=>{var slot=isInput?{name:info[0],type:info[1],link:null,...info[2]??{}}:{name:info[0],type:info[1],links:null,...info[2]??{}};isInput?(this.inputs=this.inputs??[],this.inputs.push(slot),this.onInputAdded?.(slot),Lite.registerNodeAndSlotType(this,info[1])):(this.outputs=this.outputs??[],this.outputs.push(slot),this.onOutputAdded?.(slot),Lite.auto_load_slot_types&&Lite.registerNodeAndSlotType(this,info[1],!0))}),this.setSize(this.computeSize()),this.setDirtyCanvas?.(!0,!0)}removeInput(slot){this.disconnectInput(slot);var removedInput=this.inputs.splice(slot,1)[0];this.inputs.slice(slot).filter(input=>!!input).forEach(input=>{input=this.graph.links[input.link];input?.target_slot&&input.target_slot--}),this.setSize(this.computeSize()),this.onInputRemoved?.(slot,removedInput),this.setDirtyCanvas(!0,!0)}removeOutput(slot){this.disconnectOutput(slot),this.outputs=this.outputs.filter((_,index)=>index!==slot),this.outputs.slice(slot).forEach(output=>{output&&output.links&&output.links.forEach(linkId=>{linkId=this.graph.links[linkId];linkId&&--linkId.origin_slot})}),this.setSize(this.computeSize()),this.onOutputRemoved?.(slot),this.setDirtyCanvas(!0,!0)}addConnection(name,type,pos,direction){name={name:name,type:type,pos:pos,direction:direction,links:null};return this.connections.push(name),name}computeSize(out){if(this.constructor.size)return this.constructor.size.concat();var size=out||new Float32Array([0,0]),font_size=Lite.NODE_TEXT_SIZE;const get_text_width=text=>text?font_size*text.length*.6:0;var out=get_text_width(this.title),input_width=0,output_width=0,input_width=(this.inputs&&(input_width=this.inputs.reduce((maxWidth,input)=>{input=input.label||input.name||"",input=get_text_width(input);return Math.max(maxWidth,input)},0)),this.outputs&&(output_width=this.outputs.reduce((maxWidth,output)=>{output=output.label||output.name||"",output=get_text_width(output);return Math.max(maxWidth,output)},0)),size[0]=Math.max(input_width+output_width+10,out),size[0]=Math.max(size[0],Lite.NODE_WIDTH),this.widgets&&this.widgets.length&&(size[0]=Math.max(size[0],1.5*Lite.NODE_WIDTH)),Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1,1)*Lite.NODE_SLOT_HEIGHT);size[1]=input_width+(this.constructor.slot_start_y||0);let widgetsHeight=0;if(this.widgets&&this.widgets.length){for(var i=0,l=this.widgets.length;i<l;++i)this.widgets[i].computeSize?widgetsHeight+=this.widgets[i].computeSize(size[0])[1]+4:widgetsHeight+=Lite.NODE_WIDGET_HEIGHT+4;widgetsHeight+=8}return this.widgets_up?size[1]=Math.max(size[1],widgetsHeight):null!=this.widgets_start_y?size[1]=Math.max(size[1],widgetsHeight+this.widgets_start_y):size[1]+=widgetsHeight,this.constructor.min_height&&size[1]<this.constructor.min_height&&(size[1]=this.constructor.min_height),size[1]+=6,size}getPropertyInfo(property){var info=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==property){info=this.properties_info[i];break}return this.constructor["@"+property]&&(info=this.constructor["@"+property]),(info=(info=!(info=this.constructor.widgets_info&&this.constructor.widgets_info[property]?this.constructor.widgets_info[property]:info)&&this.onGetPropertyInfo?this.onGetPropertyInfo(property):info)||{}).type||(info.type=typeof this.properties[property]),"combo"==info.widget&&(info.type="enum"),info}addWidget(type,name,value,callback,options){this.widgets??=[],!options&&callback&&callback.constructor===Object&&(options=callback,callback=null),options&&options.constructor===String&&(options={property:options}),callback&&callback.constructor===String&&((options??={}).property=callback,callback=null),callback&&callback.constructor!==Function&&(console.warn("addWidget: callback must be a function"),callback=null);name={type:type.toLowerCase(),name:name,value:value,callback:callback,options:options||{}};if(void 0!==name.options.y&&(name.y=name.options.y),callback||name.options.callback||name.options.property||console.warn("Lite addWidget(...) without a callback or property assigned"),"combo"!=type||name.options.values)return this.widgets.push(name),this.setSize(this.computeSize()),name;throw Error("Lite addWidget('combo',...) requires to pass values in options: { values:['red','blue'] }")}addCustomWidget(custom_widget){return this.widgets??=[],this.widgets.push(custom_widget),custom_widget}getBounding(out=new Float32Array(4),compute_outer){var nodePos=this.pos,isCollapsed=this.flags.collapsed,nodeSize=this.size;let left_offset=0,right_offset=1,top_offset=0,bottom_offset=0;return compute_outer&&(left_offset=4,right_offset=6+left_offset,top_offset=4,bottom_offset=5+top_offset),out[0]=nodePos[0]-left_offset,out[1]=nodePos[1]-Lite.NODE_TITLE_HEIGHT-top_offset,out[2]=isCollapsed?(this._collapsed_width||Lite.NODE_COLLAPSED_WIDTH)+right_offset:nodeSize[0]+right_offset,out[3]=isCollapsed?Lite.NODE_TITLE_HEIGHT+bottom_offset:nodeSize[1]+Lite.NODE_TITLE_HEIGHT+bottom_offset,this.onBounding&&this.onBounding(out),out}isPointInside(x,y,margin=0,skip_title){var margin_top=this.graph&&this.graph.isLive()?0:Lite.NODE_TITLE_HEIGHT;if(skip_title&&(margin_top=0),this.flags&&this.flags.collapsed){if(Lite.isInsideRectangle(x,y,this.pos[0]-margin,this.pos[1]-Lite.NODE_TITLE_HEIGHT-margin,(this._collapsed_width||Lite.NODE_COLLAPSED_WIDTH)+2*margin,Lite.NODE_TITLE_HEIGHT+2*margin))return!0}else if(this.pos[0]-4-margin<x&&this.pos[0]+this.size[0]+4+margin>x&&this.pos[1]-margin_top-margin<y&&this.pos[1]+this.size[1]+margin>y)return!0;return!1}getSlotInPosition(x,y){var link_pos=new Float32Array(2);if(this.inputs)for(let i=0,l=this.inputs.length;i<l;++i){var input=this.inputs[i];if(this.getConnectionPos(!0,i,link_pos),Lite.isInsideRectangle(x,y,link_pos[0]-10,link_pos[1]-5,20,10))return{input:input,slot:i,link_pos:link_pos}}if(this.outputs)for(let i=0,l=this.outputs.length;i<l;++i){var output=this.outputs[i];if(this.getConnectionPos(!1,i,link_pos),Lite.isInsideRectangle(x,y,link_pos[0]-10,link_pos[1]-5,20,10))return{output:output,slot:i,link_pos:link_pos}}return null}findInputSlot(name,returnObj){if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i)if(name==this.inputs[i].name)return returnObj?this.inputs[i]:i;return-1}findOutputSlot(name,returnObj=!1){if(this.outputs)for(var i=0,l=this.outputs.length;i<l;++i)if(name==this.outputs[i].name)return returnObj?this.outputs[i]:i;return-1}findInputSlotFree(optsIn={}){var opts=Object.assign({returnObj:!1,typesNotAccepted:[]},optsIn);if(this.inputs)for(var i=0,l=this.inputs.length;i<l;++i)if(!(this.inputs[i].link&&null!=this.inputs[i].link||opts.typesNotAccepted&&opts.typesNotAccepted.includes&&opts.typesNotAccepted.includes(this.inputs[i].type)))return opts.returnObj?this.inputs[i]:i;return-1}findOutputSlotFree(optsIn={}){var opts=Object.assign({returnObj:!1,typesNotAccepted:[]},optsIn);if(this.outputs)for(let i=0,l=this.outputs.length;i<l;++i)if(!(this.outputs[i].links&&null!=this.outputs[i].links||opts.typesNotAccepted&&opts.typesNotAccepted.includes&&opts.typesNotAccepted.includes(this.outputs[i].type)))return opts.returnObj?this.outputs[i]:i;return-1}findInputSlotByType(type,returnObj,preferFreeSlot,doNotUseOccupied){return this.findSlotByType(!0,type,returnObj,preferFreeSlot,doNotUseOccupied)}findOutputSlotByType(type,returnObj,preferFreeSlot,doNotUseOccupied){return this.findSlotByType(!1,type,returnObj,preferFreeSlot,doNotUseOccupied)}findSlotByType(input=!1,type,returnObj=!1,preferFreeSlot=!1,doNotUseOccupied=!1){var aSlots=input?this.inputs:this.outputs;if(aSlots){""!=type&&"*"!=type||(type=0);for(let i=0,l=aSlots.length;i<l;++i){var aSource=(type+"").toLowerCase().split(","),aDest=((aDest="0"==aSlots[i].type||"*"==aSlots[i].type?"0":aSlots[i].type)+"").toLowerCase().split(",");for(let sI=0;sI<aSource.length;sI++)for(let dI=0;dI<aDest.length;dI++)if("_event_"==aSource[sI]&&(aSource[sI]=Lite.EVENT),"_event_"==aDest[sI]&&(aDest[sI]=Lite.EVENT),"*"==aSource[sI]&&(aSource[sI]=0),"*"==aDest[sI]&&(aDest[sI]=0),!(aSource[sI]!=aDest[dI]||preferFreeSlot&&aSlots[i].links&&null!==aSlots[i].links))return returnObj?aSlots[i]:i}if(preferFreeSlot&&!doNotUseOccupied)for(let i=0,l=aSlots.length;i<l;++i){let aSource=(type+"").toLowerCase().split(","),aDest="0"==aSlots[i].type||"*"==aSlots[i].type?"0":aSlots[i].type;aDest=(aDest+"").toLowerCase().split(",");for(let sI=0;sI<aSource.length;sI++)for(let dI=0;dI<aDest.length;dI++)if("*"==aSource[sI]&&(aSource[sI]=0),"*"==aDest[sI]&&(aDest[sI]=0),aSource[sI]==aDest[dI])return returnObj?aSlots[i]:i}}return-1}connectByType(slot,target_node,target_slotType="*",optsIn={}){var optsIn=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0},optsIn),target_slot=(target_node=target_node&&target_node.constructor===Number?this.graph.getNodeById(target_node):target_node).findInputSlotByType(target_slotType,!1,!0);return 0<=target_slot&&null!==target_slot?(Lite.debug&&console.debug("CONNbyTYPE type "+target_slotType+" for "+target_slot),this.connect(slot,target_node,target_slot)):optsIn.createEventInCase&&target_slotType==Lite.EVENT?(Lite.debug&&console.debug("connect WILL CREATE THE onTrigger "+target_slotType+" to "+target_node),this.connect(slot,target_node,-1)):optsIn.generalTypeInCase&&(target_slot=target_node.findInputSlotByType(0,!1,!0,!0),Lite.debug&&console.debug("connect TO a general type (*, 0), if not found the specific type ",target_slotType," to ",target_node,"RES_SLOT:",target_slot),0<=target_slot)||optsIn.firstFreeIfOutputGeneralInCase&&(0==target_slotType||"*"==target_slotType||""==target_slotType)&&(target_slot=target_node.findInputSlotFree({typesNotAccepted:[Lite.EVENT]}),Lite.debug&&console.debug("connect TO TheFirstFREE ",target_slotType," to ",target_node,"RES_SLOT:",target_slot),0<=target_slot)?this.connect(slot,target_node,target_slot):(Lite.debug&&console.debug("no way to connect type: ",target_slotType," to targetNODE ",target_node),null)}connectByTypeOutput(slot,source_node,source_slotType="*",optsIn={}){var optsIn=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},optsIn),source_slot=(source_node=source_node&&source_node.constructor===Number?this.graph.getNodeById(source_node):source_node).findOutputSlotByType(source_slotType,!1,!0);return 0<=source_slot&&null!==source_slot?(Lite.debug&&console.debug("CONNbyTYPE OUT! type "+source_slotType+" for "+source_slot),source_node.connect(source_slot,this,slot)):optsIn.generalTypeInCase&&0<=(source_slot=source_node.findOutputSlotByType(0,!1,!0,!0))?source_node.connect(source_slot,this,slot):optsIn.createEventInCase&&source_slotType==Lite.EVENT&&Lite.do_add_triggers_slots?(source_slot=source_node.addOnExecutedOutput(),source_node.connect(source_slot,this,slot)):optsIn.firstFreeIfInputGeneralInCase&&(0==source_slotType||"*"==source_slotType||""==source_slotType||"undefined"==source_slotType)&&0<=(source_slot=source_node.findOutputSlotFree({typesNotAccepted:[Lite.EVENT]}))?source_node.connect(source_slot,this,slot):(console.debug("no way to connect byOUT type: ",source_slotType," to sourceNODE ",source_node),Lite.debug&&console.log("type OUT! "+source_slotType+" not found or not free?"),null)}connect(slot,target_node,target_slot=0){if(!this.graph)return console.log("Connect: Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them."),null;if(slot.constructor===String){if(-1==(slot=this.findOutputSlot(slot)))return Lite.debug&&console.log("Connect: Error, no slot of name "+slot),null}else if(!this.outputs||slot>=this.outputs.length)return Lite.debug&&console.log("Connect: Error, slot number not found"),null;if(!(target_node=target_node&&target_node.constructor===Number?this.graph.getNodeById(target_node):target_node))throw new Error("target node is null");if(target_node==this)return null;if(target_slot.constructor===String){if(-1==(target_slot=target_node.findInputSlot(target_slot)))return Lite.debug&&console.log("Connect: Error, no slot of name "+target_slot),null}else if(target_slot===Lite.EVENT){if(!Lite.do_add_triggers_slots)return null;target_node.changeMode(Lite.ON_TRIGGER),target_slot=target_node.findInputSlot("onTrigger")}else if(!target_node.inputs||target_slot>=target_node.inputs.length)return Lite.debug&&console.log("Connect: Error, slot number not found"),null;var nextId,changed=!1,input=target_node.inputs[target_slot],output=this.outputs[slot];return!this.outputs[slot]||(target_node.onBeforeConnectInput&&(target_slot=target_node.onBeforeConnectInput(target_node)),!1===this.onConnectOutput?.(slot,input.type,input,target_node,target_slot))?null:!1!==target_slot&&null!==target_slot&&Lite.isValidConnection(output.type,input.type)?(Lite.debug&&console.debug("DBG targetSlot",target_slot),!1===target_node.onConnectInput?.(target_slot,output.type,output,this,slot)||!1===this.onConnectOutput?.(slot,input.type,input,target_node,target_slot)?null:(target_node.inputs[target_slot]&&null!=target_node.inputs[target_slot].link&&(this.graph.beforeChange(),target_node.disconnectInput(target_slot,{doProcessChange:!1}),changed=!0),output.links?.length&&output.type===Lite.EVENT&&!Lite.allow_multi_output_for_events&&(this.graph.beforeChange(),this.disconnectOutput(slot,!1,{doProcessChange:!1}),changed=!0),nextId=Lite.use_uuids?Lite.uuidv4():++this.graph.last_link_id,nextId=new Lite.Link(nextId,input.type||output.type,this.id,slot,target_node.id,target_slot),this.graph.links[nextId.id]=nextId,null==output.links&&(output.links=[]),output.links.push(nextId.id),void 0===target_node.inputs[target_slot]&&console.warn("FIXME error, target_slot does not exists on target_node",target_node,target_slot),target_node.inputs[target_slot].link=nextId.id,this.onConnectionsChange?.(Lite.OUTPUT,slot,!0,nextId,output),target_node.onConnectionsChange?.(Lite.INPUT,target_slot,!0,nextId,input),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(Lite.INPUT,target_node,target_slot,this,slot),this.graph.onNodeConnectionChange(Lite.OUTPUT,this,slot,target_node,target_slot)),this.graph.onGraphChanged({action:"connect"}),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,nextId),nextId)):(this.setDirtyCanvas(!1,!0),changed&&this.graph.connectionChange(this,null),null)}disconnectOutput(slot,target_node,optsIn={}){var opts=Object.assign({doProcessChange:!0},optsIn);if(slot.constructor===String){if(-1==(slot=this.findOutputSlot(slot)))return Lite.debug&&console.log("Connect: Error, no slot of name "+slot),!1}else if(!this.outputs||slot>=this.outputs.length)return Lite.debug&&console.log("Connect: Error, slot number not found"),!1;var output=this.outputs[slot];if(!output||!output.links||0==output.links.length)return!1;if(target_node){if(!(target_node=target_node.constructor===Number?this.graph.getNodeById(target_node):target_node))throw new Error("Target Node not found");for(let i=0,l=output.links.length;i<l;i++){var link_id=output.links[i],link_info=this.graph.links[link_id];if(link_info.target_id==target_node.id){output.links.splice(i,1);var input=target_node.inputs[link_info.target_slot];input.link=null,delete this.graph.links[link_id],this.graph?.onGraphChanged({action:"disconnectOutput",doSave:opts.doProcessChange}),target_node.onConnectionsChange?.(Lite.INPUT,link_info.target_slot,!1,link_info,input),this.onConnectionsChange?.(Lite.OUTPUT,slot,!1,link_info,output),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(Lite.OUTPUT,this,slot),this.graph.onNodeConnectionChange(Lite.OUTPUT,this,slot),this.graph.onNodeConnectionChange(Lite.INPUT,target_node,link_info.target_slot));break}}}else{for(let i=0,l=output.links.length;i<l;i++){let link_id=output.links[i],link_info=this.graph.links[link_id];link_info&&(target_node=this.graph.getNodeById(link_info.target_id),input=null,this.graph?.onGraphChanged({action:"disconnectOutput",doSave:opts.doProcessChange}),target_node&&((input=target_node.inputs[link_info.target_slot]).link=null,target_node.onConnectionsChange&&target_node.onConnectionsChange(Lite.INPUT,link_info.target_slot,!1,link_info,input),this.graph)&&this.graph.onNodeConnectionChange&&this.graph.onNodeConnectionChange(Lite.INPUT,target_node,link_info.target_slot),delete this.graph.links[link_id],this.onConnectionsChange&&this.onConnectionsChange(Lite.OUTPUT,slot,!1,link_info,output),this.graph)&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(Lite.OUTPUT,this,slot),this.graph.onNodeConnectionChange(Lite.INPUT,target_node,link_info.target_slot))}output.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}disconnectInput(slot,optsIn={}){optsIn=Object.assign({doProcessChange:!0},optsIn);if(slot.constructor===String){if(-1==(slot=this.findInputSlot(slot)))return Lite.debug&&console.log("Connect: Error, no slot of name "+slot),!1}else if(!this.inputs||slot>=this.inputs.length)return Lite.debug&&console.log("Connect: Error, slot number not found"),!1;var input=this.inputs[slot];if(!input)return!1;var link_id=this.inputs[slot].link;if(null!=link_id){this.inputs[slot].link=null;var link_info=this.graph.links[link_id];if(link_info){var target_node=this.graph.getNodeById(link_info.origin_id);if(!target_node)return!1;var output=target_node.outputs[link_info.origin_slot];if(!output||!output.links||0==output.links.length)return!1;for(var i=0,l=output.links.length;i<l;i++)if(output.links[i]==link_id){output.links.splice(i,1);break}delete this.graph.links[link_id],this.graph?.onGraphChanged({action:"disconnectInput",doSave:optsIn.doProcessChange}),this.onConnectionsChange&&this.onConnectionsChange(Lite.INPUT,slot,!1,link_info,input),target_node.onConnectionsChange&&target_node.onConnectionsChange(Lite.OUTPUT,i,!1,link_info,output),this.graph&&this.graph.onNodeConnectionChange&&(this.graph.onNodeConnectionChange(Lite.OUTPUT,target_node,i),this.graph.onNodeConnectionChange(Lite.INPUT,this,slot))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}getConnectionPos(is_input,slot_number,out=new Float32Array(2)){var w,num_slots=0,offset=(is_input&&this.inputs&&(num_slots=this.inputs.length),!is_input&&this.outputs&&(num_slots=this.outputs.length),.5*Lite.NODE_SLOT_HEIGHT);return this.flags.collapsed?(w=this._collapsed_width||Lite.NODE_COLLAPSED_WIDTH,this.horizontal?(out[0]=this.pos[0]+.5*w,out[1]=is_input?this.pos[1]-Lite.NODE_TITLE_HEIGHT:this.pos[1]):(out[0]=is_input?this.pos[0]:this.pos[0]+w,out[1]=this.pos[1]-.5*Lite.NODE_TITLE_HEIGHT)):is_input&&-1==slot_number?(out[0]=this.pos[0]+.5*Lite.NODE_TITLE_HEIGHT,out[1]=this.pos[1]+.5*Lite.NODE_TITLE_HEIGHT):is_input&&slot_number<num_slots&&this.inputs[slot_number].pos?(out[0]=this.pos[0]+this.inputs[slot_number].pos[0],out[1]=this.pos[1]+this.inputs[slot_number].pos[1]):!is_input&&slot_number<num_slots&&this.outputs[slot_number].pos?(out[0]=this.pos[0]+this.outputs[slot_number].pos[0],out[1]=this.pos[1]+this.outputs[slot_number].pos[1]):this.horizontal?(out[0]=this.pos[0]+(slot_number+.5)*(this.size[0]/num_slots),out[1]=is_input?this.pos[1]-Lite.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1]):(out[0]=is_input?this.pos[0]+offset:this.pos[0]+this.size[0]+1-offset,out[1]=this.pos[1]+(slot_number+.7)*Lite.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0)),out}alignToGrid(){this.pos[0]=Lite.CANVAS_GRID_SIZE*Math.round(this.pos[0]/Lite.CANVAS_GRID_SIZE),this.pos[1]=Lite.CANVAS_GRID_SIZE*Math.round(this.pos[1]/Lite.CANVAS_GRID_SIZE)}trace(msg){this.console||(this.console=[]),this.console.push(msg),this.console.length>Node.MAX_CONSOLE&&this.console.shift(),this.graph.onNodeTrace&&this.graph.onNodeTrace(this,msg)}setDirtyCanvas(dirty_foreground,dirty_background){this.graph&&this.graph.sendActionToCanvas("setDirty",[dirty_foreground,dirty_background])}loadImage(url){var img=new Image,that=(img.src=Lite.node_images_path+url,img.ready=!1,this);return img.onload=function(){this.ready=!0,that.setDirtyCanvas(!0)},img}captureInput(v){if(this.graph&&this.graph.list_of_graphcanvas)for(var list=this.graph.list_of_graphcanvas,i=0;i<list.length;++i){var c=list[i];!v&&c.node_capturing_input!=this||(c.node_capturing_input=v?this:null)}}collapse(force){this.graph.onGraphChanged({action:"collapse"}),!1===this.constructor.collapsable&&!force||(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))}pin(v){this.graph.onGraphChanged({action:"pin"}),this.flags.pinned=void 0===v?!this.flags.pinned:v}localToScreen(x,y,graphcanvas){return[(x+this.pos[0])*graphcanvas.scale+graphcanvas.offset[0],(y+this.pos[1])*graphcanvas.scale+graphcanvas.offset[1]]}refreshAncestors(optsIn={}){var opts=Object.assign({action:"",param:null,options:null,passParam:!0},optsIn);if(this.inputs&&!(Lite.preventAncestorRecalculation&&this.graph.node_ancestorsCalculated&&this.graph.node_ancestorsCalculated[this.id])){opts.action&&""!=opts.action||(opts.action=this.id+"_ancestors"),opts.param&&""!=opts.param||(opts.param=this.id+"_ancestors"),opts.options||(opts.options={}),opts.options=Object.assign({action_call:opts.action},opts.options),this.graph.ancestorsCall=!0;var optsIn={modesSkip:[Lite.NEVER,Lite.ON_EVENT,Lite.ON_TRIGGER],modesOnly:[Lite.ALWAYS,Lite.ON_REQUEST],typesSkip:[Lite.ACTION],typesOnly:[]},aAncestors=this.graph.getAncestors(this,optsIn);for(iN in aAncestors)aAncestors[iN].doExecute(opts.param,opts.options),this.graph.node_ancestorsCalculated[aAncestors[iN].id]=!0;return this.graph.ancestorsCall=!1,this.graph.node_ancestorsCalculated[this.id]=!0}}}export{Node};

import{Lite}from"./Lite.js";import{Canvas}from"./renderers/canvas.js";class Group{constructor(title="Group"){this.title=title,this.font_size=24,this.color=Canvas.node_colors.pale_blue?.groupcolor??"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this.graph=null}set pos(v){!v||v.length<2||(this._pos[0]=v[0],this._pos[1]=v[1])}get pos(){return this._pos}set size(v){!v||v.length<2||(this._size[0]=Math.max(140,v[0]),this._size[1]=Math.max(80,v[1]))}get size(){return this._size}configure(o){this.title=o.title,this._bounding.set(o.bounding),this.color=o.color,o.font_size&&(this.font_size=o.font_size)}serialize(){var b=this._bounding;return{title:this.title,bounding:b.map(value=>Math.round(value)),color:this.color,font_size:this.font_size}}move(deltax,deltay,ignore_nodes){isNaN(deltax)&&console.error("Lite.Group.move() deltax NaN"),isNaN(deltay)&&console.error("Lite.Group.move() deltay NaN"),this._pos[0]+=deltax,this._pos[1]+=deltay,ignore_nodes||this._nodes.forEach(node=>{node.pos[0]+=deltax,node.pos[1]+=deltay})}recomputeInsideNodes(){this._nodes.length=0;var nodes=this.graph._nodes,node_bounding=new Float32Array(4);this._nodes=nodes.filter(node=>(node.getBounding(node_bounding),Lite.overlapBounding(this._bounding,node_bounding)))}isPointInside=Lite.Node.prototype.isPointInside;setDirtyCanvas=Lite.Node.prototype.setDirtyCanvas}export{Group};

import{Lite}from"./Lite.js";import{Canvas}from"./renderers/canvas.js";class Graph{static supported_types=["number","string","boolean"];static STATUS_STOPPED=1;static STATUS_RUNNING=2;constructor(o){Lite.debug&&console.log("Graph created"),this.list_of_graphcanvas=null,this.clear(),o&&this.configure(o)}getSupportedTypes(){return this.supported_types??Graph.supported_types}clear(){this.stop(),this.status=Graph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes?.forEach(node=>{node.onRemoved?.()}),this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.configApplyDefaults(),this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.history={actionHistory:[],actionHistoryVersions:[],actionHistoryPtr:0},this.nodes_executing=[],this.nodes_actioning=[],this.node_ancestorsCalculated=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}configApply(opts){this.config=Object.assign(this.config,opts)}configApplyDefaults(){var opts=Lite.graphDefaultConfig;this.configApply(opts)}attachCanvas(graphcanvas){if(!graphcanvas instanceof Canvas)throw new Error("attachCanvas expects a Canvas instance");graphcanvas.graph&&graphcanvas.graph!=this&&graphcanvas.graph.detachCanvas(graphcanvas),(graphcanvas.graph=this).list_of_graphcanvas??=[],this.list_of_graphcanvas.push(graphcanvas)}detachCanvas(graphcanvas){var pos;this.list_of_graphcanvas&&-1!=(pos=this.list_of_graphcanvas.indexOf(graphcanvas))&&(graphcanvas.graph=null,this.list_of_graphcanvas.splice(pos,1))}start(interval=0){if(this.status!==Graph.STATUS_RUNNING){this.status=Graph.STATUS_RUNNING,this.onPlayEvent?.(),this.sendEventToAllNodes("onStart"),this.starttime=Lite.getTime(),this.last_update_time=this.starttime;const onAnimationFrame=()=>{-1===this.execution_timer_id&&(window.requestAnimationFrame(onAnimationFrame),this.onBeforeStep?.(),this.runStep(1,!this.catch_errors),this.onAfterStep?.())};0===interval&&"object"==typeof window&&window.requestAnimationFrame?(this.execution_timer_id=-1,onAnimationFrame()):this.execution_timer_id=setInterval(()=>{this.onBeforeStep?.(),this.runStep(1,!this.catch_errors),this.onAfterStep?.()},interval)}}stop(){this.status!=Graph.STATUS_STOPPED&&(this.status=Graph.STATUS_STOPPED,this.onStopEvent?.(),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(num=1,do_not_catch_errors,limit){var start=Lite.getTime(),nodes=(this.globaltime=.001*(start-this.starttime),this._nodes_executable??this._nodes);if(nodes){if(limit||=nodes.length,do_not_catch_errors){for(let i=0;i<num;i++)nodes.forEach(node=>{Lite.use_deferred_actions&&node._waiting_actions?.length&&node.executePendingActions(),node.mode===Lite.ALWAYS&&node.doExecute?.()}),this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep?.();this.onAfterExecute?.()}else try{for(let i=0;i<num;i++)nodes.forEach(node=>{Lite.use_deferred_actions&&node._waiting_actions?.length&&node.executePendingActions(),node.mode===Lite.ALWAYS&&node.doExecute?.()}),this.fixedtime+=this.fixedtime_lapse,this.onExecuteStep?.();this.onAfterExecute?.(),this.errors_in_execution=!1}catch(err){if(this.errors_in_execution=!0,Lite.throw_errors)throw err;Lite.debug&&console.log("Error during execution: "+err),this.stop()}limit=Lite.getTime(),do_not_catch_errors=limit-start;this.execution_time=.001*(do_not_catch_errors=0==do_not_catch_errors?1:do_not_catch_errors),this.globaltime+=.001*do_not_catch_errors,this.iteration+=1,this.elapsed_time=.001*(limit-this.last_update_time),this.last_update_time=limit,this.nodes_executing=[],this.nodes_actioning=[],this.node_ancestorsCalculated=[],this.nodes_executedAction=[]}}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var i=0;i<this._nodes_in_order.length;++i)this._nodes_in_order[i].onExecute&&this._nodes_executable.push(this._nodes_in_order[i])}computeExecutionOrder(only_onExecute,set_level){var i,L=[],S=[],M={},visited_links={},remaining_links={};for(let i=0,l=this._nodes.length;i<l;++i){let node=this._nodes[i];if(!only_onExecute||node.onExecute){var num=0;if((M[node.id]=node).inputs)for(var j=0,l2=node.inputs.length;j<l2;j++)node.inputs[j]&&null!=node.inputs[j].link&&(num+=1);0==num?(S.push(node),set_level&&(node._level=1)):(set_level&&(node._level=0),remaining_links[node.id]=num)}}for(;0!=S.length;){var node=S.shift();if(L.push(node),delete M[node.id],node.outputs)for(let i=0;i<node.outputs.length;i++){var output=node.outputs[i];if(null!=output&&null!=output.links&&0!=output.links.length)for(let j=0;j<output.links.length;j++){var target_node,link_id=output.links[j],link_id=this.links[link_id];!link_id||visited_links[link_id.id]||(null==(target_node=this.getNodeById(link_id.target_id))?visited_links[link_id.id]=!0:(set_level&&(!target_node._level||target_node._level<=node._level)&&(target_node._level=node._level+1),visited_links[link_id.id]=!0,--remaining_links[target_node.id],0==remaining_links[target_node.id]&&S.push(target_node)))}}}for(i in M)L.push(M[i]);L.length!=this._nodes.length&&Lite.debug&&console.warn("something went wrong, nodes missing");var l=L.length;for(let i=0;i<l;++i)L[i].order=i;L=L.sort((A,B)=>{var Ap=A.constructor.priority||A.priority||0,Bp=B.constructor.priority||B.priority||0;return Ap==Bp?A.order-B.order:Ap-Bp});for(let i=0;i<l;++i)L[i].order=i;return L}getAncestors(node,optsIn={}){for(var opts=Object.assign({modesSkip:[],modesOnly:[],typesSkip:[],typesOnly:[]},optsIn),ancestors=[],ancestorsIds=[],pending=[node],visited={};pending.length;){var current=pending.shift();if(current&&!visited[current.id]){if(visited[current.id]=!0,current.id!=node.id){if(opts.modesSkip&&opts.modesSkip.length&&-1!=opts.modesSkip.indexOf(current.mode))continue;if(opts.modesOnly&&opts.modesOnly.length&&-1==opts.modesOnly.indexOf(current.mode))continue;-1==ancestorsIds.indexOf(current.id)&&(ancestors.push(current),ancestorsIds.push(current.id))}if(current.inputs)for(var i=0;i<current.inputs.length;++i){var inputType,input=current.getInputNode(i);input&&(inputType=current.inputs[i].type,opts.typesSkip&&opts.typesSkip.length&&-1!=opts.typesSkip.indexOf(inputType)||opts.typesOnly&&opts.typesOnly.length&&-1==opts.typesOnly.indexOf(input.mode)||-1!=ancestorsIds.indexOf(input.id)||visited[input.id]||pending.push(input))}}}return ancestors.sort((a,b)=>a.order-b.order),ancestors}arrange(margin=100,layout){var nodes=this.computeExecutionOrder(!1,!0),columns=[];for(let i=0;i<nodes.length;++i){var node=nodes[i],col=node._level||1;columns[col]??=[],columns[col].push(node)}let x=margin;for(let i=0;i<columns.length;++i){var column=columns[i];if(column){let max_size=100,y=margin+Lite.NODE_TITLE_HEIGHT;for(let j=0;j<column.length;++j){const node=column[j];node.pos[0]=layout==Lite.VERTICAL_LAYOUT?y:x,node.pos[1]=layout==Lite.VERTICAL_LAYOUT?x:y;var max_size_index=layout==Lite.VERTICAL_LAYOUT?1:0,max_size_index=(node.size[max_size_index]>max_size&&(max_size=node.size[max_size_index]),layout==Lite.VERTICAL_LAYOUT?0:1);y+=node.size[max_size_index]+margin+Lite.NODE_TITLE_HEIGHT}x+=max_size+margin}}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}sendEventToAllNodes(eventname,params,mode=Lite.ALWAYS){var nodes=this._nodes_in_order||this._nodes;if(nodes)for(let j=0,l=nodes.length;j<l;++j){var node=nodes[j];node.constructor===Lite.Subgraph&&"onExecute"!==eventname?node.mode==mode&&node.sendEventToAllNodes(eventname,params,mode):node[eventname]&&node.mode===mode&&(void 0===params?node[eventname]():Array.isArray(params)?node[eventname].apply(node,params):node[eventname](params))}}sendActionToCanvas(action,params){if(this.list_of_graphcanvas)for(const c of this.list_of_graphcanvas)c[action]&&params&&c[action](...params)}add(node,skip_compute_order,optsIn={}){optsIn=Object.assign({doProcessChange:!0,doCalcSize:!0},optsIn);if(node){if(node.constructor!==Lite.Group){if(-1!=node.id&&null!=this._nodes_by_id[node.id]&&(console.warn("Lite: there is already a node with this ID, changing it"),Lite.use_uuids?node.id=Lite.uuidv4():node.id=++this.last_node_id),this._nodes.length>=Lite.MAX_NUMBER_OF_NODES)throw new Error("Lite: max number of nodes in a graph reached");return Lite.use_uuids?null!=node.id&&-1!=node.id||(node.id=Lite.uuidv4()):null==node.id||-1==node.id?node.id=++this.last_node_id:this.last_node_id<node.id&&(this.last_node_id=node.id),(node.graph=this).onGraphChanged({action:"nodeAdd",doSave:optsIn.doProcessChange}),this._nodes.push(node),(this._nodes_by_id[node.id]=node).onAdded?.(this),this.config.align_to_grid&&node.alignToGrid(),skip_compute_order||this.updateExecutionOrder(),this.onNodeAdded?.(node),optsIn.doCalcSize&&node.setSize(node.computeSize()),this.setDirtyCanvas(!0),this.change(),node}this._groups.push(node),this.setDirtyCanvas(!0),this.change(),(node.graph=this).onGraphChanged({action:"groupAdd",doSave:optsIn.doProcessChange})}}remove(node){if(node.constructor===Lite.Group)-1!=(index=this._groups.indexOf(node))&&this._groups.splice(index,1),node.graph=null,this.onGraphChanged({action:"groupRemove"}),this.setDirtyCanvas(!0,!0),this.change();else if(null!=this._nodes_by_id[node.id]&&!node.ignore_remove){if(node.inputs)for(let i=0;i<node.inputs.length;i++)null!=node.inputs[i].link&&node.disconnectInput(i,{doProcessChange:!1});if(node.outputs)for(let i=0;i<node.outputs.length;i++){let slot=node.outputs[i];null!=slot.links&&slot.links.length&&node.disconnectOutput(i,!1,{doProcessChange:!1})}if(node.onRemoved?.(),node.graph=null,this.onGraphChanged({action:"nodeRemove"}),this.list_of_graphcanvas)for(let i=0;i<this.list_of_graphcanvas.length;++i){var canvas=this.list_of_graphcanvas[i];canvas.selected_nodes[node.id]&&delete canvas.selected_nodes[node.id],canvas.node_dragged==node&&(canvas.node_dragged=null)}var index=this._nodes.indexOf(node);-1!=index&&this._nodes.splice(index,1),delete this._nodes_by_id[node.id],this.onNodeRemoved?.(node),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.change(),this.updateExecutionOrder()}}getNodeById(id){return null==id?null:this._nodes_by_id[id]}findNodesByClass(classObject,result=0){return this._nodes.filter(node=>node.constructor===classObject)}findNodesByType(type,result=0){const lowerCaseType=type.toLowerCase();return this._nodes.filter(node=>node.type.toLowerCase()===lowerCaseType)}findNodeByTitle(title){return this._nodes.find(node=>node.title===title)??null}findNodesByTitle(title){return this._nodes.filter(node=>node.title===title)}getNodeOnPos(x,y,nodes_list=this._nodes,margin=0){return nodes_list.reverse().find(node=>node.isPointInside(x,y,margin))??null}getGroupOnPos(x,y){return this._groups.find(group=>group.isPointInside(x,y,2,!0))??null}checkNodeTypes(){for(var i=0;i<this._nodes.length;i++){var node=this._nodes[i],ctor=Lite.registered_node_types[node.type];node.constructor!=ctor&&(Lite.debug&&console.log("node being replaced by newer version: "+node.type),ctor=Lite.createNode(node.type),(this._nodes[i]=ctor).configure(node.serialize()),(ctor.graph=this)._nodes_by_id[ctor.id]=ctor,node.inputs&&(ctor.inputs=node.inputs.concat()),node.outputs)&&(ctor.outputs=node.outputs.concat())}this.updateExecutionOrder()}onAction(action,param,options){this._input_nodes=this.findNodesByClass(Lite.GraphInput,this._input_nodes);for(var i=0;i<this._input_nodes.length;++i){var node=this._input_nodes[i];if(node.properties.name==action){node.actionDo(action,param,options);break}}}trigger(action,param){this.onTrigger?.(action,param)}addInput(name,type,value){this.inputs[name]||(this.beforeChange(),this.inputs[name]={name:name,type:type,value:value},this.onGraphChanged({action:"addInput"}),this.afterChange(),this.onInputAdded?.(name,type),this.onInputsOutputsChange?.())}setInputData(name,data){name=this.inputs[name];name&&(name.value=data)}getInputData(name){name=this.inputs[name];return name?name.value:null}renameInput(old_name,name){if(name!=old_name)return!!this.inputs[old_name]&&(this.inputs[name]?(console.error("there is already one input with that name"),!1):(this.inputs[name]=this.inputs[old_name],delete this.inputs[old_name],this.onGraphChanged({action:"renameInput"}),this.onInputRenamed?.(old_name,name),void this.onInputsOutputsChange?.()))}changeInputType(name,type){if(!this.inputs[name])return!1;this.inputs[name].type&&String(this.inputs[name].type).toLowerCase()==String(type).toLowerCase()||(this.inputs[name].type=type,this.onGraphChanged({action:"changeInputType"}),this.onInputTypeChanged?.(name,type))}removeInput(name){return!!this.inputs[name]&&(delete this.inputs[name],this.onGraphChanged({action:"graphRemoveInput"}),this.onInputRemoved?.(name),this.onInputsOutputsChange?.(),!0)}addOutput(name,type,value){this.outputs[name]={name:name,type:type,value:value},this.onGraphChanged({action:"addOutput"}),this.onOutputAdded?.(name,type),this.onInputsOutputsChange?.()}setOutputData(name,value){name=this.outputs[name];name&&(name.value=value)}getOutputData(name){name=this.outputs[name];return name?name.value:null}renameOutput(old_name,name){return!!this.outputs[old_name]&&(this.outputs[name]?(console.error("there is already one output with that name"),!1):(this.outputs[name]=this.outputs[old_name],delete this.outputs[old_name],this._version++,this.onOutputRenamed?.(old_name,name),void this.onInputsOutputsChange?.()))}changeOutputType(name,type){if(!this.outputs[name])return!1;this.outputs[name].type&&String(this.outputs[name].type).toLowerCase()==String(type).toLowerCase()||(this.outputs[name].type=type,this.onGraphChanged({action:"changeOutputType"}),this.onOutputTypeChanged?.(name,type))}removeOutput(name){return!!this.outputs[name]&&(delete this.outputs[name],this.onGraphChanged({action:"removeOutput"}),this.onOutputRemoved?.(name),this.onInputsOutputsChange?.(),!0)}triggerInput(name,value){for(var nodes=this.findNodesByTitle(name),i=0;i<nodes.length;++i)nodes[i].onTrigger(value)}setCallback(name,func){for(var nodes=this.findNodesByTitle(name),i=0;i<nodes.length;++i)nodes[i].setTrigger(func)}beforeChange(info){this.onBeforeChange?.(this,info),this.sendActionToCanvas("onBeforeChange",this)}afterChange(info){this.onAfterChange?.(this,info),this.sendActionToCanvas("onAfterChange",this)}connectionChange(node){this.updateExecutionOrder(),this.onConnectionChange?.(node),this.onGraphChanged({action:"connectionChange",doSave:!1}),this.sendActionToCanvas("onConnectionChange")}isLive(){if(this.list_of_graphcanvas)for(var i=0;i<this.list_of_graphcanvas.length;++i)if(this.list_of_graphcanvas[i].live_mode)return!0;return!1}clearTriggeredSlots(){for(var i in this.links){i=this.links[i];i&&(i._last_time&&=0)}}change(){Lite.debug&&console.log("Graph visually changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.on_change?.(this)}setDirtyCanvas(fg,bg){this.sendActionToCanvas("setDirty",[fg,bg])}removeLink(link_id){var node,link_id=this.links[link_id];link_id&&(node=this.getNodeById(link_id.target_id))&&(this.beforeChange(),node.disconnectInput(link_id.target_slot),this.afterChange())}serialize(){var i,nodesInfo=this._nodes.map(node=>node.serialize()),links=[];for(i in this.links){var link=this.links[i];if(!link.serialize){console.warn("weird Link bug, link info is not a Link but a regular object");var j,link2=new Lite.Link;for(j in link)link2[j]=link[j];link=this.links[i]=link2}links.push(link.serialize())}var groupsInfo=this._groups.map(group=>group.serialize()),nodesInfo={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:nodesInfo,links:links,groups:groupsInfo,config:this.config,extra:this.extra,version:Lite.VERSION};return this.onSerialize?.(nodesInfo),nodesInfo}configure(data,keep_old){if(data){keep_old||this.clear();var nodes=data.nodes;if(data.links&&data.links.constructor===Array){for(var links=[],i=0;i<data.links.length;++i){var link,link_data=data.links[i];link_data?((link=new Lite.Link).configure(link_data),links[link.id]=link):console.warn("serialized graph link data contains errors, skipping.")}data.links=links}for(let i in data)["nodes","groups"].includes(i)||(this[i]=data[i]);var error=!1;if(this._nodes=[],nodes){for(let i=0,l=nodes.length;i<l;++i){var n_info=nodes[i],node=Lite.createNode(n_info.type,n_info.title);node||(Lite.debug&&console.log("Node not found or has errors: "+n_info.type),(node=new LGraphNode).last_serialization=n_info,error=node.has_errors=!0),node.id=n_info.id,this.add(node,!0,{doProcessChange:!1})}nodes.forEach(n_info=>{this.getNodeById(n_info.id)?.configure(n_info)})}return this._groups.length=0,data.groups&&data.groups.forEach(groupData=>{var group=new Lite.Group;group.configure(groupData),this.add(group,!0,{doProcessChange:!1})}),this.updateExecutionOrder(),this.extra=data.extra??{},this.onConfigure?.(data),data._version?Lite.debug&&console.debug("skip onGraphChanged when configure passing version too!"):this.onGraphChanged({action:"graphConfigure",doSave:!1}),this.setDirtyCanvas(!0,!0),error}}load(url,callback){var reader,req,that=this;url.constructor===File||url.constructor===Blob?((reader=new FileReader).addEventListener("load",event=>{event=JSON.parse(event.target.result);that.configure(event),callback?.()}),reader.readAsText(url)):((req=new XMLHttpRequest).open("GET",url,!0),req.send(null),req.onload=_event=>{var data;200!==req.status?console.error("Error loading graph:",req.status,req.response):(data=JSON.parse(req.response),that.configure(data),callback?.())},req.onerror=err=>{console.error("Error loading graph:",err)})}onGraphSaved(optsIn={}){Object.assign({},optsIn);this.savedVersion=this._version}onGraphLoaded(optsIn={}){Object.assign({},optsIn);this.savedVersion=this._version}onGraphChanged(optsIn={}){optsIn=Object.assign({action:"",doSave:!0,doSaveGraph:!0},optsIn);if(this._version++,optsIn.action?Lite.debug&&console.debug("Graph change",optsIn.action):Lite.debug&&console.debug("Graph change, no action",optsIn),optsIn.doSave&&Lite.actionHistory_enabled){Lite.debug&&console.debug("onGraphChanged SAVE :: "+optsIn.action);for(var oHistory={actionName:optsIn.action},obH=(optsIn.doSaveGraph&&(oHistory=Object.assign(oHistory,{graphSave:this.serialize()})),this.history);obH.actionHistoryPtr<obH.actionHistoryVersions.length-1;)Lite.debug&&console.debug("popping: gone back? "+obH.actionHistoryPtr+" < "+(obH.actionHistoryVersions.length-1)),obH.actionHistoryVersions.pop();obH.actionHistoryVersions.length>=Lite.actionHistoryMaxSave&&(optsIn=obH.actionHistoryVersions.shift(),Lite.debug&&console.debug("maximum saves reached: "+obH.actionHistoryVersions.length+", remove older: "+optsIn),obH.actionHistory[optsIn]=!1),obH.actionHistoryPtr=obH.actionHistoryVersions.length,obH.actionHistoryVersions.push(obH.actionHistoryPtr),obH.actionHistory[obH.actionHistoryPtr]=oHistory,Lite.debug&&console.debug("history saved: "+obH.actionHistoryPtr,oHistory.actionName)}}actionHistoryBack(optsIn={}){Object.assign({},optsIn);optsIn=this.history;return null!=optsIn.actionHistoryPtr&&0<=optsIn.actionHistoryPtr?(optsIn.actionHistoryPtr--,Lite.debug&&console.debug("history step back: "+optsIn.actionHistoryPtr),this.actionHistoryLoad({iVersion:optsIn.actionHistoryPtr})?(Lite.debug&&(console.debug("history loaded back: "+optsIn.actionHistoryPtr),console.debug(this.history)),!0):(console.warn("historyLoad failed, restore pointer? "+optsIn.actionHistoryPtr),optsIn.actionHistoryPtr++,!1)):(Lite.debug&&console.debug("history is already at older state"),!1)}actionHistoryForward(optsIn={}){Object.assign({},optsIn);optsIn=this.history;return optsIn.actionHistoryPtr<optsIn.actionHistoryVersions.length?(optsIn.actionHistoryPtr++,Lite.debug&&console.debug("history step forward: "+optsIn.actionHistoryPtr),this.actionHistoryLoad({iVersion:optsIn.actionHistoryPtr})?(Lite.debug&&console.debug("history loaded forward: "+optsIn.actionHistoryPtr),!0):(console.warn("historyLoad failed, restore pointer? "+optsIn.actionHistoryPtr),optsIn.actionHistoryPtr--,!1)):(Lite.debug&&console.debug("history is already at newer state"),!1)}actionHistoryLoad(optsIn={}){var tmpHistory,optsIn=Object.assign({iVersion:!1,backStep:!1},optsIn),obH=this.history;return!(!obH.actionHistory[optsIn.iVersion]||!obH.actionHistory[optsIn.iVersion].graphSave||(tmpHistory=JSON.stringify(this.history),this.configure(obH.actionHistory[optsIn.iVersion].graphSave),this.history=JSON.parse(tmpHistory),Lite.debug&&console.debug("history loaded: "+optsIn.iVersion,obH.actionHistory[optsIn.iVersion].actionName),0))}}export{Graph};

import{Lite}from"./Lite.js";class Link{constructor(id,type,origin_id,origin_slot,target_id,target_slot){this.id=id,this.type=type,this.origin_id=origin_id,this.origin_slot=origin_slot,this.target_id=target_id,this.target_slot=target_slot,this._data=null,this._pos=new Float32Array(2)}configure(o){o.constructor===Array?(this.id=o[0],this.origin_id=o[1],this.origin_slot=o[2],this.target_id=o[3],this.target_slot=o[4],this.type=o[5]):(this.id=o.id,this.type=o.type,this.origin_id=o.origin_id,this.origin_slot=o.origin_slot,this.target_id=o.target_id,this.target_slot=o.target_slot)}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}export{Link};

import{Lite}from"../Lite.js";class Time{static title="Time";static desc="Time";constructor(){this.addOutput("in ms","number"),this.addOutput("in sec","number")}onExecute(){this.setOutputData(0,1e3*this.graph.globaltime),this.setOutputData(1,this.graph.globaltime)}}Lite.registerNodeType("basic/time",Time);class Subgraph{static title="Subgraph";static desc="Graph inside a node";constructor(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new Lite.Graph,(this.subgraph._subgraph_node=this).subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}onGetInputs(){return[["enabled","boolean"]]}onDblClick(e,pos,graphcanvas){var that=this;setTimeout(function(){graphcanvas.openSubgraph(that.subgraph)},10)}onAction(action,param){this.subgraph.onAction(action,param)}onExecute(){if(this.enabled=this.getInputOrProperty("enabled"),this.enabled){if(this.inputs)for(let i=0;i<this.inputs.length;i++){var input=this.inputs[i],value=this.getInputData(i);this.subgraph.setInputData(input.name,value)}if(this.subgraph.runStep(),this.outputs)for(let i=0;i<this.outputs.length;i++){var output=this.outputs[i];let value=this.subgraph.getOutputData(output.name);this.setOutputData(i,value)}}}sendEventToAllNodes(eventname,param,mode){this.enabled&&this.subgraph.sendEventToAllNodes(eventname,param,mode)}onDrawBackground(ctx,graphcanvas,canvas,pos){var y,over;this.flags.collapsed||(y=this.size[1]-Lite.NODE_TITLE_HEIGHT+.5,over=Lite.isInsideRectangle(pos[0],pos[1],this.pos[0],this.pos[1]+y,this.size[0],Lite.NODE_TITLE_HEIGHT),pos=Lite.isInsideRectangle(pos[0],pos[1],this.pos[0],this.pos[1]+y,this.size[0]/2,Lite.NODE_TITLE_HEIGHT),ctx.fillStyle=over?"#555":"#222",ctx.beginPath(),this._shape==Lite.BOX_SHAPE?pos?ctx.rect(0,y,this.size[0]/2+1,Lite.NODE_TITLE_HEIGHT):ctx.rect(this.size[0]/2,y,this.size[0]/2+1,Lite.NODE_TITLE_HEIGHT):pos?ctx.roundRect(0,y,this.size[0]/2+1,Lite.NODE_TITLE_HEIGHT,[0,0,8,8]):ctx.roundRect(this.size[0]/2,y,this.size[0]/2+1,Lite.NODE_TITLE_HEIGHT,[0,0,8,8]),over?ctx.fill():ctx.fillRect(0,y,this.size[0]+1,Lite.NODE_TITLE_HEIGHT),ctx.textAlign="center",ctx.font="24px Arial",ctx.fillStyle=over?"#DDD":"#999",ctx.fillText("+",.25*this.size[0],24+y),ctx.fillText("+",.75*this.size[0],24+y))}onMouseDown(e,localpos,graphcanvas){var y=this.size[1]-Lite.NODE_TITLE_HEIGHT+.5;console.log(0),localpos[1]>y&&(localpos[0]<this.size[0]/2?(console.log(1),graphcanvas.showSubgraphPropertiesDialog(this)):(console.log(2),graphcanvas.showSubgraphPropertiesDialogRight(this)))}computeSize(){var num_inputs=this.inputs?this.inputs.length:0,num_outputs=this.outputs?this.outputs.length:0;return[200,Math.max(num_inputs,num_outputs)*Lite.NODE_SLOT_HEIGHT+Lite.NODE_TITLE_HEIGHT]}onSubgraphTrigger(event){event=this.findOutputSlot(event);-1!=event&&this.triggerSlot(event)}onSubgraphNewInput(name,type){-1==this.findInputSlot(name)&&this.addInput(name,type)}onSubgraphRenamedInput(oldname,name){oldname=this.findInputSlot(oldname);-1!=oldname&&(this.getInputInfo(oldname).name=name)}onSubgraphTypeChangeInput(name,type){name=this.findInputSlot(name);-1!=name&&(this.getInputInfo(name).type=type)}onSubgraphRemovedInput(name){name=this.findInputSlot(name);-1!=name&&this.removeInput(name)}onSubgraphNewOutput(name,type){-1==this.findOutputSlot(name)&&this.addOutput(name,type)}onSubgraphRenamedOutput(oldname,name){oldname=this.findOutputSlot(oldname);-1!=oldname&&(this.getOutputInfo(oldname).name=name)}onSubgraphTypeChangeOutput(name,type){name=this.findOutputSlot(name);-1!=name&&(this.getOutputInfo(name).type=type)}onSubgraphRemovedOutput(name){name=this.findOutputSlot(name);-1!=name&&this.removeOutput(name)}getExtraMenuOptions(graphcanvas){var that=this;return[{content:"Open",callback:function(){graphcanvas.openSubgraph(that.subgraph)}}]}onResize(size){size[1]+=20}serialize(){var data=Lite.Node.prototype.serialize.call(this);return data.subgraph=this.subgraph.serialize(),data}reassignSubgraphUUIDs(graph){const idMap={nodeIDs:{},linkIDs:{}};for(const node of graph.nodes){var oldID=node.id,newID=Lite.uuidv4();if(node.id=newID,idMap.nodeIDs[oldID]||idMap.nodeIDs[newID])throw new Error(`New/old node UUID wasn't unique in changed map! ${oldID} `+newID);idMap.nodeIDs[oldID]=newID,idMap.nodeIDs[newID]=oldID}for(const link of graph.links){const oldID=link[0],newID=Lite.uuidv4();if(link[0]=newID,idMap.linkIDs[oldID]||idMap.linkIDs[newID])throw new Error(`New/old link UUID wasn't unique in changed map! ${oldID} `+newID);idMap.linkIDs[oldID]=newID,idMap.linkIDs[newID]=oldID;var nodeFrom=link[1],nodeTo=link[3];if(!idMap.nodeIDs[nodeFrom])throw new Error("Old node UUID not found in mapping! "+nodeFrom);if(link[1]=idMap.nodeIDs[nodeFrom],!idMap.nodeIDs[nodeTo])throw new Error("Old node UUID not found in mapping! "+nodeTo);link[3]=idMap.nodeIDs[nodeTo]}for(const node of graph.nodes){if(node.inputs)for(const input of node.inputs)input.link&&(input.link=idMap.linkIDs[input.link]);if(node.outputs)for(const output of node.outputs)output.links&&(output.links=output.links.map(l=>idMap.linkIDs[l]))}for(const node of graph.nodes){var merge;"graph/subgraph"===node.type&&(merge=reassignGraphUUIDs(node.subgraph),idMap.nodeIDs.assign(merge.nodeIDs),idMap.linkIDs.assign(merge.linkIDs))}}clone(){var subgraph,node=Lite.createNode(this.type),data=this.serialize();return Lite.use_uuids&&(subgraph=Lite.cloneObject(data.subgraph),this.reassignSubgraphUUIDs(subgraph),data.subgraph=subgraph),delete data.id,delete data.inputs,delete data.outputs,node.configure(data),node}buildFromNodes(nodes){var ids={};for(let i=0;i<nodes.length;++i)ids[node.id]=nodes[i];for(let i=0;i<nodes.length;++i){let node=nodes[i];if(node.inputs)for(let j=0;j<node.inputs.length;++j){var link,input=node.inputs[j];input&&input.link&&((link=node.graph.links[input.link])&&!ids[link.origin_id]&&this.subgraph.addInput(input.name,link.type))}if(node.outputs)for(let j=0;j<node.outputs.length;++j){var output=node.outputs[j];if(output&&output.links&&output.links.length)for(let k=0;k<output.links.length;++k){let link=node.graph.links[output.links[k]];if(link&&!ids[link.target_id])break}}}}static title_color="#334"}Lite.Subgraph=Subgraph,Lite.registerNodeType("graph/subgraph",Subgraph);class GraphInput{static title="Input";static desc="Input of the graph";constructor(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var that=this;this.name_widget=this.addWidget("text","Name",this.properties.name,function(v){v&&that.setProperty("name",v)}),this.type_widget=this.addWidget("text","Type",this.properties.type,function(v){that.setProperty("type",v)}),this.value_widget=this.addWidget("number","Value",this.properties.value,function(v){that.setProperty("value",v)}),this.widgets_up=!0,this.size=[180,90]}onConfigure(){this.updateType()}updateType(){var type=this.properties.type;this.type_widget.value=type,this.outputs[0].type!=type&&(Lite.isValidConnection(this.outputs[0].type,type)||this.disconnectOutput(0),this.outputs[0].type=type),"number"==type?(this.value_widget.type="number",this.value_widget.value=0):"boolean"==type?(this.value_widget.type="toggle",this.value_widget.value=!0):"string"==type?(this.value_widget.type="text",this.value_widget.value=""):(this.value_widget.type=null,this.value_widget.value=null),this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,type)}onPropertyChanged(name,v){if("name"==name){if(""==v||v==this.name_in_graph||"enabled"==v)return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,v):this.graph.addInput(v,this.properties.type)),this.name_widget.value=v,this.name_in_graph=v}else"type"==name&&this.updateType()}getTitle(){return this.flags.collapsed?this.properties.name:this.title}onAction(action,param){this.properties.type==Lite.EVENT&&this.triggerSlot(0,param)}onExecute(){var name=this.properties.name,name=this.graph.inputs[name];name?this.setOutputData(0,(void 0!==name.value?name:this.properties).value):this.setOutputData(0,this.properties.value)}onRemoved(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)}}Lite.GraphInput=GraphInput,Lite.registerNodeType("graph/input",GraphInput);class GraphOutput{static title="Output";static desc="Output of the graph";constructor(){this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""},this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}onPropertyChanged(name,v){if("name"==name){if(""==v||v==this.name_in_graph||"enabled"==v)return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,v):this.graph.addOutput(v,this.properties.type)),this.name_widget.value=v,this.name_in_graph=v}else"type"==name&&this.updateType()}updateType(){var type=this.properties.type;this.type_widget&&(this.type_widget.value=type),this.inputs[0].type!=type&&("action"!=type&&"event"!=type||(type=Lite.EVENT),Lite.isValidConnection(this.inputs[0].type,type)||this.disconnectInput(0),this.inputs[0].type=type),this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,type)}onExecute(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)}onAction(action,param){this.properties.type==Lite.ACTION&&this.graph.trigger(this.properties.name,param)}onRemoved(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)}getTitle(){return this.flags.collapsed?this.properties.name:this.title}}Lite.GraphOutput=GraphOutput,Lite.registerNodeType("graph/output",GraphOutput);class ConstantNumber{static title="Const Number";static desc="Constant number";constructor(){this.addOutput("value","number"),this.addProperty("value",1),this.widget=this.addWidget("number","value",1,"value"),this.widgets_up=!0,this.size=[180,30]}onExecute(){this.setOutputData(0,parseFloat(this.properties.value))}getTitle(){return this.flags.collapsed?this.properties.value:this.title}setValue(v){this.setProperty("value",v)}onDrawBackground(){this.outputs[0].label=this.properties.value.toFixed(3)}}Lite.registerNodeType("basic/const",ConstantNumber);class ConstantBoolean{static title="Const Boolean";static desc="Constant boolean";constructor(){this.addOutput("bool","boolean"),this.addProperty("value",!0),this.widget=this.addWidget("toggle","value",!0,"value"),this.serialize_widgets=!0,this.widgets_up=!0,this.size=[140,30]}onExecute(){this.setOutputData(0,this.properties.value)}onGetInputs(){return[["toggle",Lite.ACTION]]}onAction(){this.setValue(!this.properties.value)}}ConstantBoolean.prototype.getTitle=ConstantNumber.prototype.getTitle,ConstantBoolean.prototype.setValue=ConstantNumber.prototype.setValue,Lite.registerNodeType("basic/boolean",ConstantBoolean);class ConstantString{static title="Const String";static desc="Constant string";constructor(){this.addOutput("string","string"),this.addProperty("value",""),this.widget=this.addWidget("text","value","","value"),this.widgets_up=!0,this.size=[180,30]}onExecute(){this.setOutputData(0,this.properties.value)}onDropFile(file){var that=this,reader=new FileReader;reader.onload=function(e){that.setProperty("value",e.target.result)},reader.readAsText(file)}}ConstantString.prototype.getTitle=ConstantNumber.prototype.getTitle,ConstantString.prototype.setValue=ConstantNumber.prototype.setValue,Lite.registerNodeType("basic/string",ConstantString);class ConstantObject{static title="Const Object";static desc="Constant Object";constructor(){this.addOutput("obj","object"),this.size=[120,30],this._object={}}onExecute(){this.setOutputData(0,this._object)}}Lite.registerNodeType("basic/object",ConstantObject);class ConstantFile{static title="Const File";static desc="Fetches a file from an url";constructor(){this.addInput("url","string"),this.addOutput("file","string"),this.addProperty("url",""),this.addProperty("type","text"),this.widget=this.addWidget("text","url","","url"),this._data=null}onPropertyChanged(name,value){"url"==name&&(null==value||""==value?this._data=null:this.fetchFile(value))}onExecute(){var url=this.getInputData(0)||this.properties.url;!url||url==this._url&&this._type==this.properties.type||this.fetchFile(url),this.setOutputData(0,this._data)}fetchFile(url){var that=this;url&&url.constructor===String?(this._url=url,this._type=this.properties.type,"http"==url.substr(0,4)&&Lite.proxy&&(url=Lite.proxy+url.substr(url.indexOf(":")+3)),fetch(url).then(function(response){if(response.ok)return"arraybuffer"==that.properties.type?response.arrayBuffer():"text"==that.properties.type?response.text():"json"==that.properties.type?response.json():"blob"==that.properties.type?response.blob():void 0;throw new Error("File not found")}).then(function(data){that._data=data,that.boxcolor="#AEA"}).catch(_error=>{that._data=null,that.boxcolor="red",console.error("error fetching file:",url)})):(that._data=null,that.boxcolor=null)}onDropFile(file){var that=this,reader=(this._url=file.name,this._type=this.properties.type,this.properties.url=file.name,new FileReader);if(reader.onload=function(e){that.boxcolor="#AEA";e=e.target.result;"json"==that.properties.type&&(e=JSON.parse(e)),that._data=e},"arraybuffer"==that.properties.type)reader.readAsArrayBuffer(file);else if("text"==that.properties.type||"json"==that.properties.type)reader.readAsText(file);else if("blob"==that.properties.type)return reader.readAsBinaryString(file)}static"@type"={type:"enum",values:["text","arraybuffer","blob","json"]}}ConstantFile.prototype.setValue=ConstantNumber.prototype.setValue,Lite.registerNodeType("basic/file",ConstantFile);class JSONParse{static title="JSON Parse";static desc="Parses JSON String into object";constructor(){this.addInput("parse",Lite.ACTION),this.addInput("json","string"),this.addOutput("done",Lite.EVENT),this.addOutput("object","object"),this.widget=this.addWidget("button","parse","",this.parse.bind(this)),this._str=null,this._obj=null}parse(){if(this._str)try{this._str=this.getInputData(1),this._obj=JSON.parse(this._str),this.boxcolor="#AEA",this.triggerSlot(0)}catch(err){this.boxcolor="red"}}onExecute(){this._str=this.getInputData(1),this.setOutputData(1,this._obj)}onAction(name){"parse"==name&&this.parse()}}Lite.registerNodeType("basic/jsonparse",JSONParse);class ConstantData{static title="Const Data";static desc="Constant Data";constructor(){this.addOutput("data","object"),this.addProperty("value",""),this.widget=this.addWidget("text","json","","value"),this.widgets_up=!0,this.size=[140,30],this._value=null}onPropertyChanged(name,value){if(null!=(this.widget.value=value)&&""!=value)try{this._value=JSON.parse(value),this.boxcolor="#AEA"}catch(err){this.boxcolor="red"}}onExecute(){this.setOutputData(0,this._value)}}ConstantData.prototype.setValue=ConstantNumber.prototype.setValue,Lite.registerNodeType("basic/data",ConstantData);class ConstantArray{static title="Const Array";static desc="Constant Array";constructor(){this._value=[],this.addInput("json",""),this.addOutput("arrayOut","array"),this.addOutput("length","number"),this.addProperty("value","[]"),this.widget=this.addWidget("text","array",this.properties.value,"value"),this.widgets_up=!0,this.size=[140,50]}onPropertyChanged(name,value){if(null!=(this.widget.value=value)&&""!=value)try{"["!=value[0]?this._value=JSON.parse("["+value+"]"):this._value=JSON.parse(value),this.boxcolor="#AEA"}catch(err){this.boxcolor="red"}}onExecute(){var v=this.getInputData(0);if(v&&v.length){this._value||(this._value=new Array),this._value.length=v.length;for(var i=0;i<v.length;++i)this._value[i]=v[i];this.changeOutputType("arrayOut","array")}this.setOutputData(0,this._value),this.setOutputData(1,this._value&&this._value.length||0)}}ConstantArray.prototype.setValue=ConstantNumber.prototype.setValue,Lite.registerNodeType("basic/array",ConstantArray);class ArrayLength{static title="aLength";static desc="Get the length of an array";constructor(){this.addInput("arr","array"),this.addOutput("length","number")}onExecute(){var arr=this.getInputData(0);arr&&(["array","object"].includes(typeof arr)&&void 0!==arr.length?this.setOutputData(0,arr.length):(console.debug("Not an array or object",typeof arr,arr),this.setOutputData(0,null)))}}Lite.registerNodeType("basic/array_length",ArrayLength);class SetArray{static title="Set Array";static desc="Sets index of array";constructor(){this.addInput("arr","array"),this.addInput("value",""),this.addOutput("arr","array"),this.properties={index:0},this.widget=this.addWidget("number","i",this.properties.index,"index",{precision:0,step:10,min:0})}onExecute(){var v,arr=this.getInputData(0);arr&&void 0!==(v=this.getInputData(1))&&(this.properties.index&&(arr[Math.floor(this.properties.index)]=v),this.setOutputData(0,arr))}}Lite.registerNodeType("basic/set_array",SetArray);class ArrayElement{static title="Array[i]";static desc="Returns an element from an array";constructor(){this.addInput("array","array,table,string"),this.addInput("index","number"),this.addOutput("value",""),this.addProperty("index",0)}onExecute(){var array=this.getInputData(0),index=this.getInputData(1);null==index&&(index=this.properties.index),null!=array&&null!=index&&this.setOutputData(0,array[Math.floor(Number(index))])}}Lite.registerNodeType("basic/array[]",ArrayElement);class TableElement{static title="Table[row][col]";static desc="Returns an element from a table";constructor(){this.addInput("table","table"),this.addInput("row","number"),this.addInput("col","number"),this.addOutput("value",""),this.addProperty("row",0),this.addProperty("column",0)}onExecute(){var table=this.getInputData(0),row=this.getInputData(1),col=this.getInputData(2);null==row&&(row=this.properties.row),null==col&&(col=this.properties.column),null!=table&&null!=row&&null!=col&&((row=table[Math.floor(Number(row))])?this.setOutputData(0,row[Math.floor(Number(col))]):this.setOutputData(0,null))}}Lite.registerNodeType("basic/table[][]",TableElement);class ObjectProperty{static title="Object property";static desc="Outputs the property of an object";constructor(){this.addInput("obj","object"),this.addOutput("property",0),this.addProperty("value",0),this.widget=this.addWidget("text","prop.","",this.setValue.bind(this)),this.widgets_up=!0,this.size=[140,30],this._value=null}setValue(v){this.properties.value=v,this.widget.value=v}getTitle(){return this.flags.collapsed?"in."+this.properties.value:this.title}onPropertyChanged(name,value){this.widget.value=value}onExecute(){var data=this.getInputData(0);null!=data&&this.setOutputData(0,data[this.properties.value])}}Lite.registerNodeType("basic/object_property",ObjectProperty);class ObjectKeys{static title="Object keys";static desc="Outputs an array with the keys of an object";constructor(){this.addInput("obj",""),this.addOutput("keys","array"),this.size=[140,30]}onExecute(){var data=this.getInputData(0);null!=data&&this.setOutputData(0,Object.keys(data))}}Lite.registerNodeType("basic/object_keys",ObjectKeys);class SetObject{static title="Set Object";static desc="Adds propertiesrty to object";constructor(){this.addInput("obj",""),this.addInput("value",""),this.addOutput("obj",""),this.properties={property:""},this.name_widget=this.addWidget("text","prop.",this.properties.property,"property")}onExecute(){var v,obj=this.getInputData(0);obj&&void 0!==(v=this.getInputData(1))&&(this.properties.property&&(obj[this.properties.property]=v),this.setOutputData(0,obj))}}Lite.registerNodeType("basic/set_object",SetObject);class MergeObjects{static title="Merge Objects";static desc="Creates an object copying properties from others";constructor(){this.addInput("A","object"),this.addInput("B","object"),this.addOutput("out","object"),this._result={};var that=this;this.addWidget("button","clear","",function(){that._result={}}),this.size=this.computeSize()}onExecute(){var A=this.getInputData(0),B=this.getInputData(1),C=this._result;if(A)for(var i in A)C[i]=A[i];if(B)for(let i in B)C[i]=B[i];this.setOutputData(0,C)}}Lite.registerNodeType("basic/merge_objects",MergeObjects);class Variable{static title="Variable";static desc="store/read variable value";constructor(){this.size=[60,30],this.addInput("in"),this.addOutput("out"),this.properties={varname:"myname",container:Variable.LITEGRAPH},this.value=null}onExecute(){var container=this.getContainer();this.isInputConnected(0)?(this.value=this.getInputData(0),container[this.properties.varname]=this.value,this.setOutputData(0,this.value)):this.setOutputData(0,container[this.properties.varname])}getContainer(){switch(this.properties.container){case Variable.GRAPH:return this.graph?this.graph.vars:{};case Variable.GLOBALSCOPE:return global;default:return Lite.Globals}}getTitle(){return this.properties.varname}}function length(v){return v&&null!=v.length?Number(v.length):0}Variable.LITEGRAPH=0,Variable.GRAPH=1,Variable.GLOBALSCOPE=2,Variable["@container"]={type:"enum",values:{litegraph:Variable.LITEGRAPH,graph:Variable.GRAPH,global:Variable.GLOBALSCOPE}},Lite.registerNodeType("basic/variable",Variable),Lite.wrapFunctionAsNode("basic/length",length,[""],"number"),Lite.wrapFunctionAsNode("basic/not",function(a){return!a},[""],"boolean");class DownloadData{static title="Download";static desc="Download some data";constructor(){this.size=[60,30],this.addInput("data",0),this.addInput("download",Lite.ACTION),this.properties={filename:"data.json"},this.value=null;var that=this;this.addWidget("button","Download","",()=>{that.value&&that.downloadAsFile()})}downloadAsFile(){var url,str;null!=this.value&&(str=null,str=this.value.constructor===String?this.value:JSON.stringify(this.value),str=new Blob([str]),url=URL.createObjectURL(str),(str=document.createElement("a")).setAttribute("href",url),str.setAttribute("download",this.properties.filename),str.style.display="none",document.body.appendChild(str),str.click(),document.body.removeChild(str),setTimeout(function(){URL.revokeObjectURL(url)},6e4))}onAction(){var that=this;setTimeout(function(){that.downloadAsFile()},100)}onExecute(){this.inputs[0]&&(this.value=this.getInputData(0))}getTitle(){return this.flags.collapsed?this.properties.filename:this.title}}Lite.registerNodeType("basic/download",DownloadData);class Watch{static title="Watch";static desc="Show value of input";constructor(){this.size=[60,30],this.addInput("value",0,{label:""}),this.value=0}onExecute(){this.inputs[0]&&(this.value=this.getInputData(0))}getTitle(){return this.flags.collapsed?this.inputs[0].label:this.title}static toString(o){if(null==o)return"null";if(o.constructor===Number)return o.toFixed(3);if(o.constructor!==Array)return String(o);for(var str="[",i=0;i<o.length;++i)str+=Watch.toString(o[i])+(i+1!=o.length?",":"");return str+="]"}onDrawBackground(){this.inputs[0].label=Watch.toString(this.value)}}Lite.registerNodeType("basic/watch",Watch);class Cast{static title="Cast";static desc="Allows to connect different types";constructor(){this.addInput("in",0),this.addOutput("out",0),this.size=[40,30]}onExecute(){this.setOutputData(0,this.getInputData(0))}}Lite.registerNodeType("basic/cast",Cast);class Console{static title="Console";static desc="Show value inside the console";constructor(){this.mode=Lite.ON_EVENT,this.size=[80,30],this.addProperty("msg",""),this.addInput("log",Lite.EVENT),this.addInput("msg",0)}onAction(action,param){var msg=this.getInputData(1);msg=(msg=msg||this.properties.msg)||"Event: "+param,"log"==action?console.log(msg):"warn"==action?console.warn(msg):"error"==action&&console.error(msg)}onExecute(){var msg=this.getInputData(1);null!=(msg=msg||this.properties.msg)&&void 0!==msg&&(this.properties.msg=msg,console.log(msg))}onGetInputs(){return[["log",Lite.ACTION],["warn",Lite.ACTION],["error",Lite.ACTION]]}}Lite.registerNodeType("basic/console",Console);class Alert{static title="Alert";static desc="Show an alert window";constructor(){this.mode=Lite.ON_EVENT,this.addProperty("msg",""),this.addInput("",Lite.EVENT),this.widget=this.addWidget("text","Text","","msg"),this.widgets_up=!0,this.size=[200,30]}onConfigure(o){this.widget.value=o.properties.msg}onAction(){var msg=this.properties.msg;setTimeout(function(){alert(msg)},10)}static color="#510"}Lite.registerNodeType("basic/alert",Alert);class NodeScript{static title="Script";static desc="executes a code (max 256 characters)";constructor(){this.size=[60,30],this.addProperty("onExecute","return A;"),this.addInput("A",0),this.addInput("B",0),this.addOutput("out",0),this._func=null,this.data={}}onConfigure(o){o.properties.onExecute&&Lite.allow_scripts?this.compileCode(o.properties.onExecute):console.warn("Script not compiled, Lite.allow_scripts is false")}onPropertyChanged(name,value){"onExecute"==name&&Lite.allow_scripts?this.compileCode(value):console.warn("Script not compiled, Lite.allow_scripts is false")}compileCode(code){if(this._func=null,256<code.length)console.warn("Script too long, max 256 chars");else{for(var code_low=code.toLowerCase(),forbidden_words=["script","body","document","eval","nodescript","function"],i=0;i<forbidden_words.length;++i)if(-1!=code_low.indexOf(forbidden_words[i]))return void console.warn("invalid script");try{this._func=new Function("A","B","C","DATA","node",code)}catch(err){console.error("Error parsing script"),console.error(err)}}}onExecute(){if(this._func)try{var A=this.getInputData(0),B=this.getInputData(1),C=this.getInputData(2);this.setOutputData(0,this._func(A,B,C,this.data,this))}catch(err){console.error("Error in script"),console.error(err)}}onGetOutputs(){return[["C",""]]}static widgets_info={onExecute:{type:"code"}}}Lite.registerNodeType("basic/script",NodeScript);class GenericCompare{static title="Compare *";static desc="evaluates condition between A and B";constructor(){this.addInput("A",0),this.addInput("B",0),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","==","enum",{values:GenericCompare.values}),this.addWidget("combo","Op.",this.properties.OP,{property:"OP",values:GenericCompare.values}),this.size=[80,60]}getTitle(){return"*A "+this.properties.OP+" *B"}onExecute(){var A=this.getInputData(0),B=(void 0===A?A=this.properties.A:this.properties.A=A,this.getInputData(1)),result=(void 0===B?B=this.properties.B:this.properties.B=B,!1);if(typeof A==typeof B)switch(this.properties.OP){case"==":case"!=":if(result=!0,"object"==typeof A){var aProps=Object.getOwnPropertyNames(A),bProps=Object.getOwnPropertyNames(B);if(aProps.length!=bProps.length)result=!1;else for(var i=0;i<aProps.length;i++){var propName=aProps[i];if(A[propName]!==B[propName]){result=!1;break}}}else result=A==B;"!="==this.properties.OP&&(result=!result)}this.setOutputData(0,result),this.setOutputData(1,!result)}static values=["==","!="];static"@OP"={type:"enum",title:"operation",values:GenericCompare.values}}Lite.registerNodeType("basic/CompareValues",GenericCompare);

import{Lite}from"../Lite.js";class LogEvent{static title="Log Event";static desc="Log event in console";constructor(){this.size=[60,30],this.addInput("event",Lite.ACTION)}onAction(action,param){console.log(action,param)}}Lite.registerNodeType("events/log",LogEvent);class TriggerEvent{static title="TriggerEvent";static desc="Triggers event if input evaluates to true";constructor(){this.size=[60,30],this.addInput("if",""),this.addOutput("true",Lite.EVENT),this.addOutput("change",Lite.EVENT),this.addOutput("false",Lite.EVENT),this.properties={only_on_change:!0,tooltip:"Triggers event if input evaluates to true"},this.prev=0}onExecute(param,options){var v=this.getInputData(0),changed=v!=this.prev,must_resend=(changed=0===this.prev?!1:changed)&&this.properties.only_on_change||!changed&&!this.properties.only_on_change;v&&must_resend&&this.triggerSlot(0,param,null,options),!v&&must_resend&&this.triggerSlot(2,param,null,options),changed&&this.triggerSlot(1,param,null,options),this.prev=v}}Lite.registerNodeType("events/trigger",TriggerEvent);class Sequence{static title="Sequence";static desc="Triggers a sequence of events when an event arrives";constructor(){var that=this;this.addInput("",Lite.ACTION),this.addInput("",Lite.ACTION),this.addInput("",Lite.ACTION),this.addOutput("",Lite.EVENT),this.addOutput("",Lite.EVENT),this.addOutput("",Lite.EVENT),this.addWidget("button","+",null,function(){that.addInput("",Lite.ACTION),that.addOutput("",Lite.EVENT)}),this.size=[90,70],this.flags={horizontal:!0,render_box:!1}}getTitle(){return""}onAction(action,param,options){if(this.outputs){options=options||{};for(var i=0;i<this.outputs.length;++i)options.action_call?options.action_call=options.action_call+"_seq_"+i:options.action_call=this.id+"_"+(action||"action")+"_seq_"+i+"_"+Math.floor(9999*Math.random()),this.triggerSlot(i,param,null,options)}}}Lite.registerNodeType("events/sequence",Sequence);class WaitAll{static title="WaitAll";static desc="Wait until all input events arrive then triggers output";constructor(){var that=this;this.addInput("",Lite.ACTION),this.addInput("",Lite.ACTION),this.addOutput("",Lite.EVENT),this.addWidget("button","+",null,function(){that.addInput("",Lite.ACTION),that.size[0]=90}),this.size=[90,70],this.ready=[]}getTitle(){return""}onDrawBackground(ctx){if(!this.flags.collapsed)for(var i=0;i<this.inputs.length;++i){var y=i*Lite.NODE_SLOT_HEIGHT+10;ctx.fillStyle=this.ready[i]?"#AFB":"#000",ctx.fillRect(20,y,10,10)}}onAction(action,param,options,slot_index){if(null!=slot_index){this.ready.length=this.outputs.length,this.ready[slot_index]=!0;for(var i=0;i<this.ready.length;++i)if(!this.ready[i])return;this.reset(),this.triggerSlot(0)}}reset(){this.ready.length=0}}Lite.registerNodeType("events/waitAll",WaitAll);class Stepper{static title="Stepper";static desc="Trigger events sequentially when an tick arrives";constructor(){var that=this;this.properties={index:0},this.addInput("index","number"),this.addInput("step",Lite.ACTION),this.addInput("reset",Lite.ACTION),this.addOutput("index","number"),this.addOutput("",Lite.EVENT),this.addOutput("",Lite.EVENT),this.addOutput("",Lite.EVENT,{removable:!0}),this.addWidget("button","+",null,function(){that.addOutput("",Lite.EVENT,{removable:!0})}),this.size=[120,120],this.flags={render_box:!1}}onDrawBackground(ctx){var w,index;this.flags.collapsed||(index=this.properties.index||0,ctx.fillStyle="#AFB",w=this.size[0],index=(index+1)*Lite.NODE_SLOT_HEIGHT+4,ctx.beginPath(),ctx.moveTo(w-30,index),ctx.lineTo(w-30,index+Lite.NODE_SLOT_HEIGHT),ctx.lineTo(w-15,index+.5*Lite.NODE_SLOT_HEIGHT),ctx.fill())}onExecute(){var index=this.getInputData(0);null!=index&&(index=Math.floor(index),(index=Lite.clamp(index,0,this.outputs?this.outputs.length-2:0))!=this.properties.index)&&(this.properties.index=index,this.triggerSlot(index+1)),this.setOutputData(0,this.properties.index)}onAction(action,param){"reset"==action?this.properties.index=0:"step"==action&&(this.triggerSlot(this.properties.index+1,param),action=this.outputs?this.outputs.length-1:0,this.properties.index=(this.properties.index+1)%action)}}Lite.registerNodeType("events/stepper",Stepper);class FilterEvent{static title="Filter Event";static desc="Blocks events that do not match the filter";constructor(){this.size=[60,30],this.addInput("event",Lite.ACTION),this.addOutput("event",Lite.EVENT),this.properties={equal_to:"",has_property:"",property_equal_to:""}}onAction(action,param,options){if(null!=param&&(!this.properties.equal_to||this.properties.equal_to==param)){if(this.properties.has_property){var prop=param[this.properties.has_property];if(null==prop)return;if(this.properties.property_equal_to&&this.properties.property_equal_to!=prop)return}this.triggerSlot(0,param,null,options)}}}Lite.registerNodeType("events/filter",FilterEvent);class EventBranch{static title="Branch";static desc="If condition is true, outputs triggers true, otherwise false";constructor(){this.addInput("in",Lite.ACTION),this.addInput("cond","boolean"),this.addOutput("true",Lite.EVENT),this.addOutput("false",Lite.EVENT),this.size=[120,60],this._value=!1}onExecute(){this._value=this.getInputData(1)}onAction(action,param,options){this._value=this.getInputData(1),this.triggerSlot(this._value?0:1,param,null,options)}}Lite.registerNodeType("events/branch",EventBranch);class EventCounter{static title="Counter";static desc="Counts events";constructor(){this.addInput("inc",Lite.ACTION),this.addInput("dec",Lite.ACTION),this.addInput("reset",Lite.ACTION),this.addOutput("change",Lite.EVENT),this.addOutput("num","number"),this.addProperty("doCountExecution",!1,"boolean",{name:"Count Executions"}),this.addWidget("toggle","Count Exec.",this.properties.doCountExecution,"doCountExecution"),this.num=0}getTitle(){return this.flags.collapsed?String(this.num):this.title}onAction(action){var v=this.num;"inc"==action?this.num+=1:"dec"==action?--this.num:"reset"==action&&(this.num=0),this.num!=v&&this.trigger("change",this.num)}onDrawBackground(ctx){this.flags.collapsed||(ctx.fillStyle="#AAA",ctx.font="20px Arial",ctx.textAlign="center",ctx.fillText(this.num,.5*this.size[0],.5*this.size[1]))}onExecute(){this.properties.doCountExecution&&(this.num+=1),this.setOutputData(1,this.num)}}Lite.registerNodeType("events/counter",EventCounter);class DelayEvent{static title="Delay";static desc="Delays one event";constructor(){this.size=[60,30],this.addProperty("time_in_ms",1e3),this.addInput("event",Lite.ACTION),this.addOutput("on_time",Lite.EVENT),this._pending=[]}onAction(action,param,options){var time=this.properties.time_in_ms;time<=0?this.trigger(null,param,options):this._pending.push([time,param])}onExecute(param,options){var dt=1e3*this.graph.elapsed_time;this.isInputConnected(1)&&(this.properties.time_in_ms=this.getInputData(1));for(var i=0;i<this._pending.length;++i){var actionPass=this._pending[i];actionPass[0]-=dt,0<actionPass[0]||(this._pending.splice(i,1),--i,this.trigger(null,actionPass[1],options))}}onGetInputs(){return[["event",Lite.ACTION],["time_in_ms","number"]]}}Lite.registerNodeType("events/delay",DelayEvent);class TimerEvent{static title="Timer";static desc="Sends an event every N milliseconds";constructor(){this.addProperty("interval",1e3),this.addProperty("event","tick"),this.addOutput("on_tick",Lite.EVENT),this.time=0,this.last_interval=1e3,this.triggered=!1}onStart(){this.time=0}getTitle(){return"Timer: "+this.last_interval.toString()+"ms"}onDrawBackground(){this.boxcolor=this.triggered?TimerEvent.on_color:TimerEvent.off_color,this.triggered=!1}onExecute(){var dt=1e3*this.graph.elapsed_time,trigger=0==this.time;this.time+=dt,this.last_interval=Math.max(1,0|this.getInputOrProperty("interval")),!trigger&&(this.time<this.last_interval||isNaN(this.last_interval))?this.inputs&&1<this.inputs.length&&this.inputs[1]&&this.setOutputData(1,!1):(this.triggered=!0,this.time=this.time%this.last_interval,this.trigger("on_tick",this.properties.event),this.inputs&&1<this.inputs.length&&this.inputs[1]&&this.setOutputData(1,!0))}onGetInputs(){return[["interval","number"]]}onGetOutputs(){return[["tick","boolean"]]}}TimerEvent.on_color="#AAA",TimerEvent.off_color="#222",Lite.registerNodeType("events/timer",TimerEvent);class SemaphoreEvent{static title="Semaphore Event";static desc="Until both events are not triggered, it doesnt continue.";constructor(){this.addInput("go",Lite.ACTION),this.addInput("green",Lite.ACTION),this.addInput("red",Lite.ACTION),this.addOutput("continue",Lite.EVENT),this.addOutput("blocked",Lite.EVENT),this.addOutput("is_green","boolean"),this._ready=!1,this.properties={};var that=this;this.addWidget("button","reset","",function(){that._ready=!1})}onExecute(){this.setOutputData(1,this._ready),this.boxcolor=this._ready?"#9F9":"#FA5"}onAction(action){"go"==action?this.triggerSlot(this._ready?0:1):"green"==action?this._ready=!0:"red"==action&&(this._ready=!1)}}Lite.registerNodeType("events/semaphore",SemaphoreEvent);class OnceEvent{static title="Once";static desc="Only passes an event once, then gets locked";constructor(){this.addInput("in",Lite.ACTION),this.addInput("reset",Lite.ACTION),this.addOutput("out",Lite.EVENT),this._once=!1,this.properties={};var that=this;this.addWidget("button","reset","",function(){that._once=!1})}onAction(action,param){"in"!=action||this._once?"reset"==action&&(this._once=!1):(this._once=!0,this.triggerSlot(0,param))}}Lite.registerNodeType("events/once",OnceEvent);class DataStore{static title="Data Store";static desc="Stores data and only changes when event is received";constructor(){this.addInput("data",0),this.addInput("assign",Lite.ACTION),this.addOutput("data",0),this._last_value=null,this.properties={data:null,serialize:!0};var that=this;this.addWidget("button","store","",function(){that.properties.data=that._last_value})}onExecute(){this._last_value=this.getInputData(0),this.setOutputData(0,this.properties.data)}onAction(){this.properties.data=this._last_value}onSerialize(o){null==o.data||this.properties.serialize&&(o.data.constructor===String||o.data.constructor===Number||o.data.constructor===Boolean||o.data.constructor===Array||o.data.constructor===Object)||(o.data=null)}}Lite.registerNodeType("basic/data_store",DataStore);

import{Lite}from"../Lite.js";class GamepadInput{static title="Gamepad";static desc="gets the input of the gamepad";constructor(){this.addOutput("left_x_axis","number"),this.addOutput("left_y_axis","number"),this.addOutput("button_pressed",Lite.EVENT),this.properties={gamepad_index:0,threshold:.1},this._left_axis=new Float32Array(2),this._right_axis=new Float32Array(2),this._triggers=new Float32Array(2),this._previous_buttons=new Uint8Array(17),this._current_buttons=new Uint8Array(17)}onExecute(){var gamepad=this.getGamepad(),threshold=this.properties.threshold||0;if(gamepad&&(this._left_axis[0]=Math.abs(gamepad.xbox.axes.lx)>threshold?gamepad.xbox.axes.lx:0,this._left_axis[1]=Math.abs(gamepad.xbox.axes.ly)>threshold?gamepad.xbox.axes.ly:0,this._right_axis[0]=Math.abs(gamepad.xbox.axes.rx)>threshold?gamepad.xbox.axes.rx:0,this._right_axis[1]=Math.abs(gamepad.xbox.axes.ry)>threshold?gamepad.xbox.axes.ry:0,this._triggers[0]=Math.abs(gamepad.xbox.axes.ltrigger)>threshold?gamepad.xbox.axes.ltrigger:0,this._triggers[1]=Math.abs(gamepad.xbox.axes.rtrigger)>threshold?gamepad.xbox.axes.rtrigger:0),this.outputs)for(var i=0;i<this.outputs.length;i++){var output=this.outputs[i];if(output.links&&output.links.length){var v=null;if(gamepad)switch(output.name){case"left_axis":v=this._left_axis;break;case"right_axis":v=this._right_axis;break;case"left_x_axis":v=this._left_axis[0];break;case"left_y_axis":v=this._left_axis[1];break;case"right_x_axis":v=this._right_axis[0];break;case"right_y_axis":v=this._right_axis[1];break;case"trigger_left":v=this._triggers[0];break;case"trigger_right":v=this._triggers[1];break;case"a_button":v=gamepad.xbox.buttons.a?1:0;break;case"b_button":v=gamepad.xbox.buttons.b?1:0;break;case"x_button":v=gamepad.xbox.buttons.x?1:0;break;case"y_button":v=gamepad.xbox.buttons.y?1:0;break;case"lb_button":v=gamepad.xbox.buttons.lb?1:0;break;case"rb_button":v=gamepad.xbox.buttons.rb?1:0;break;case"ls_button":v=gamepad.xbox.buttons.ls?1:0;break;case"rs_button":v=gamepad.xbox.buttons.rs?1:0;break;case"hat_left":v=gamepad.xbox.hatmap&GamepadInput.LEFT;break;case"hat_right":v=gamepad.xbox.hatmap&GamepadInput.RIGHT;break;case"hat_up":v=gamepad.xbox.hatmap&GamepadInput.UP;break;case"hat_down":v=gamepad.xbox.hatmap&GamepadInput.DOWN;break;case"hat":v=gamepad.xbox.hatmap;break;case"start_button":v=gamepad.xbox.buttons.start?1:0;break;case"back_button":v=gamepad.xbox.buttons.back?1:0;break;case"button_pressed":for(var j=0;j<this._current_buttons.length;++j)this._current_buttons[j]&&!this._previous_buttons[j]&&this.triggerSlot(i,GamepadInput.buttons[j])}else switch(output.name){case"button_pressed":break;case"left_axis":case"right_axis":v=GamepadInput.zero;break;default:v=0}this.setOutputData(i,v)}}}getGamepad(){var getGamepads=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(!getGamepads)return null;var gamepads=getGamepads.call(navigator),gamepad=null;this._previous_buttons.set(this._current_buttons);for(var i=this.properties.gamepad_index;i<4;i++)if(gamepads[i]){var gamepad=gamepads[i],xbox=this.xbox_mapping;(xbox=xbox||(this.xbox_mapping={axes:[],buttons:{},hat:"",hatmap:GamepadInput.CENTER})).axes.lx=gamepad.axes[0],xbox.axes.ly=gamepad.axes[1],xbox.axes.rx=gamepad.axes[2],xbox.axes.ry=gamepad.axes[3],xbox.axes.ltrigger=gamepad.buttons[6].value,xbox.axes.rtrigger=gamepad.buttons[7].value,xbox.hat="",xbox.hatmap=GamepadInput.CENTER;for(var j=0;j<gamepad.buttons.length;j++)if(this._current_buttons[j]=gamepad.buttons[j].pressed,j<12)xbox.buttons[GamepadInput.mapping_array[j]]=gamepad.buttons[j].pressed,gamepad.buttons[j].was_pressed&&this.trigger(GamepadInput.mapping_array[j]+"_button_event");else switch(j){case 12:gamepad.buttons[j].pressed&&(xbox.hat+="up",xbox.hatmap|=GamepadInput.UP);break;case 13:gamepad.buttons[j].pressed&&(xbox.hat+="down",xbox.hatmap|=GamepadInput.DOWN);break;case 14:gamepad.buttons[j].pressed&&(xbox.hat+="left",xbox.hatmap|=GamepadInput.LEFT);break;case 15:gamepad.buttons[j].pressed&&(xbox.hat+="right",xbox.hatmap|=GamepadInput.RIGHT);break;case 16:xbox.buttons.home=gamepad.buttons[j].pressed}return gamepad.xbox=xbox,gamepad}}onDrawBackground(ctx){if(!this.flags.collapsed){var la=this._left_axis,ra=this._right_axis,h=(ctx.strokeStyle="#88A",ctx.strokeRect(.5*(la[0]+1)*this.size[0]-4,.5*(la[1]+1)*this.size[1]-4,8,8),ctx.strokeStyle="#8A8",ctx.strokeRect(.5*(ra[0]+1)*this.size[0]-4,.5*(ra[1]+1)*this.size[1]-4,8,8),this.size[1]/this._current_buttons.length);ctx.fillStyle="#AEB";for(var i=0;i<this._current_buttons.length;++i)this._current_buttons[i]&&ctx.fillRect(0,h*i,6,h)}}onGetOutputs(){return[["left_axis","vec2"],["right_axis","vec2"],["left_x_axis","number"],["left_y_axis","number"],["right_x_axis","number"],["right_y_axis","number"],["trigger_left","number"],["trigger_right","number"],["a_button","number"],["b_button","number"],["x_button","number"],["y_button","number"],["lb_button","number"],["rb_button","number"],["ls_button","number"],["rs_button","number"],["start_button","number"],["back_button","number"],["a_button_event",Lite.EVENT],["b_button_event",Lite.EVENT],["x_button_event",Lite.EVENT],["y_button_event",Lite.EVENT],["lb_button_event",Lite.EVENT],["rb_button_event",Lite.EVENT],["ls_button_event",Lite.EVENT],["rs_button_event",Lite.EVENT],["start_button_event",Lite.EVENT],["back_button_event",Lite.EVENT],["hat_left","number"],["hat_right","number"],["hat_up","number"],["hat_down","number"],["hat","number"],["button_pressed",Lite.EVENT]]}static zero=new Float32Array(2);static buttons=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs","home"];static mapping={a:0,b:1,x:2,y:3,lb:4,rb:5,lt:6,rt:7,back:8,start:9,ls:10,rs:11};static mapping_array=["a","b","x","y","lb","rb","lt","rt","back","start","ls","rs"]}GamepadInput.CENTER=0,GamepadInput.LEFT=1,GamepadInput.RIGHT=2,GamepadInput.UP=4,GamepadInput.DOWN=8,Lite.registerNodeType("input/gamepad",GamepadInput);

import{Lite}from"../Lite.js";class Converter{static title="Converter";static desc="type A to type B";constructor(){this.addInput("in",0),this.addOutput("out",0),this.size=[80,30]}onExecute(){var v=this.getInputData(0);if(null!=v&&this.outputs)for(var i=0;i<this.outputs.length;i++){var output=this.outputs[i];if(output.links&&output.links.length){var result=null;switch(output.name){case"number":result=v.length?v[0]:parseFloat(v);break;case"vec2":case"vec3":case"vec4":var result=null,count=1;switch(output.name){case"vec2":count=2;break;case"vec3":count=3;break;case"vec4":count=4}if(result=new Float32Array(count),v.length)for(var j=0;j<v.length&&j<result.length;j++)result[j]=v[j];else result[0]=parseFloat(v)}this.setOutputData(i,result)}}}onGetOutputs(){return[["number","number"],["vec2","vec2"],["vec3","vec3"],["vec4","vec4"]]}}Lite.registerNodeType("math/converter",Converter);class Bypass{static title="Bypass";static desc="removes the type";constructor(){this.addInput("in"),this.addOutput("out"),this.size=[80,30]}onExecute(){var v=this.getInputData(0);this.setOutputData(0,v)}}Lite.registerNodeType("math/bypass",Bypass);class ToNumber{static title="to Number";static desc="Cast to number";constructor(){this.addInput("in"),this.addOutput("out")}onExecute(){var v=this.getInputData(0);this.setOutputData(0,Number(v))}}Lite.registerNodeType("math/to_number",ToNumber);class MathRange{static title="Range";static desc="Convert a number from one range to another";constructor(){this.addInput("in","number",{locked:!0}),this.addOutput("out","number",{locked:!0}),this.addOutput("clamped","number",{locked:!0}),this.addProperty("in",0),this.addProperty("in_min",0),this.addProperty("in_max",1),this.addProperty("out_min",0),this.addProperty("out_max",1),this.size=[120,50]}getTitle(){return this.flags.collapsed?(this._last_v||0).toFixed(2):this.title}onExecute(){let v;if(this.inputs)for(let i=0;i<this.inputs.length;i++){var input=this.inputs[i];void 0!==(v=this.getInputData(i))&&(this.properties[input.name]=v)}void 0!==(v=this.properties.in)&&null!==v&&v.constructor===Number||(v=0);var in_min=this.properties.in_min,in_max=this.properties.in_max,out_min=this.properties.out_min,out_max=this.properties.out_max;this._last_v=(v-in_min)/(in_max-in_min)*(out_max-out_min)+out_min,this.setOutputData(0,this._last_v),this.setOutputData(1,Lite.clamp(this._last_v,out_min,out_max))}onDrawBackground(_ctx){this._last_v?this.outputs[0].label=this._last_v.toFixed(3):this.outputs[0].label="?"}onGetInputs(){return[["in_min","number"],["in_max","number"],["out_min","number"],["out_max","number"]]}}Lite.registerNodeType("math/range",MathRange);class MathRand{static title="Rand";static desc="Random number";constructor(){this.addOutput("value","number"),this.addProperty("min",0),this.addProperty("max",1),this.size=[80,30]}onExecute(){if(this.inputs)for(var i=0;i<this.inputs.length;i++){var input=this.inputs[i],v=this.getInputData(i);void 0!==v&&(this.properties[input.name]=v)}var min=this.properties.min,max=this.properties.max;this._last_v=Math.random()*(max-min)+min,this.setOutputData(0,this._last_v)}onDrawBackground(_ctx){this.outputs[0].label=(this._last_v||0).toFixed(3)}onGetInputs(){return[["min","number"],["max","number"]]}}Lite.registerNodeType("math/rand",MathRand);class MathNoise{static title="Noise";static desc="Random number with temporal continuity";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("min",0),this.addProperty("max",1),this.addProperty("smooth",!0),this.addProperty("seed",0),this.addProperty("octaves",1),this.addProperty("persistence",.8),this.addProperty("speed",1),this.size=[90,30]}static getValue(f,smooth){if(!MathNoise.data){MathNoise.data=new Float32Array(1024);for(var i=0;i<MathNoise.data.length;++i)MathNoise.data[i]=Math.random()}(f%=1024)<0&&(f+=1024);var f_min=Math.floor(f);return f-=f_min,MathNoise.data[f_min]*(1-(f=smooth?f*f*f*(f*(6*f-15)+10):f))+MathNoise.data[1023==f_min?0:f_min+1]*f}onExecute(){for(var f=this.getInputData(0)||0,iterations=this.properties.octaves||1,r=0,amp=1,speed=(f+=this.properties.seed||0,this.properties.speed||1),total_amp=0,i=0;i<iterations&&(r+=MathNoise.getValue(f*(1+i)*speed,this.properties.smooth)*amp,total_amp+=amp,!((amp*=this.properties.persistence)<.001));++i);var min=this.properties.min,max=this.properties.max;this._last_v=(r/=total_amp)*(max-min)+min,this.setOutputData(0,this._last_v)}onDrawBackground(_ctx){this.outputs[0].label=(this._last_v||0).toFixed(3)}static data=null}Lite.registerNodeType("math/noise",MathNoise);class MathSpikes{constructor(){this.addOutput("out","number"),this.addProperty("min_time",1),this.addProperty("max_time",2),this.addProperty("duration",.2),this.size=[90,30],this._remaining_time=0,this._blink_time=0}onExecute(){var f,dt=this.graph.elapsed_time,dt=(this._remaining_time-=dt,this._blink_time-=dt,0);0<this._blink_time&&(f=this._blink_time/this.properties.duration,dt=1/(Math.pow(8*f-4,4)+1)),this._remaining_time<0?(this._remaining_time=Math.random()*(this.properties.max_time-this.properties.min_time)+this.properties.min_time,this._blink_time=this.properties.duration,this.boxcolor="#FFF"):this.boxcolor="#000",this.setOutputData(0,dt)}}Lite.registerNodeType("math/spikes",MathSpikes);class MathClamp{static title="Clamp";static desc="Clamp number between min and max";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("min",0),this.addProperty("max",1)}onExecute(){var v=this.getInputData(0);null!=v&&(v=Math.max(this.properties.min,v),v=Math.min(this.properties.max,v),this.setOutputData(0,v))}getCode(){var code="";return this.isInputConnected(0)&&(code+="clamp({{0}},"+this.properties.min+","+this.properties.max+")"),code}}Lite.registerNodeType("math/clamp",MathClamp);class MathLerp{static title="Lerp";static desc="Linear Interpolation";constructor(){this.properties={f:.5},this.addInput("A","number"),this.addInput("B","number"),this.addOutput("out","number")}onExecute(){var v1=this.getInputData(0),v2=(null==v1&&(v1=0),this.getInputData(1)),f=(null==v2&&(v2=0),this.properties.f),_f=this.getInputData(2);this.setOutputData(0,v1*(1-(f=void 0!==_f?_f:f))+v2*f)}onGetInputs(){return[["f","number"]]}}Lite.registerNodeType("math/lerp",MathLerp);class MathAbs{static title="Abs";static desc="Absolute";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}onExecute(){var v=this.getInputData(0);null!=v&&this.setOutputData(0,Math.abs(v))}}Lite.registerNodeType("math/abs",MathAbs);class MathFloor{static title="Floor";static desc="Floor number to remove fractional part";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}onExecute(){var v=this.getInputData(0);null!=v&&this.setOutputData(0,Math.floor(v))}}Lite.registerNodeType("math/floor",MathFloor);class MathFrac{static title="Frac";static desc="Returns fractional part";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30]}onExecute(){var v=this.getInputData(0);null!=v&&this.setOutputData(0,v%1)}}Lite.registerNodeType("math/frac",MathFrac);class MathSmoothStep{static title="Smoothstep";static desc="Smoothstep";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.properties={A:0,B:1}}onExecute(){var edge0,edge1,v=this.getInputData(0);void 0!==v&&(edge0=this.properties.A,edge1=this.properties.B,v=Lite.clamp((v-edge0)/(edge1-edge0),0,1),this.setOutputData(0,v=v*v*(3-2*v)))}}Lite.registerNodeType("math/smoothstep",MathSmoothStep);class MathScale{static title="Scale";static desc="v * factor";constructor(){this.addInput("in","number",{label:""}),this.addOutput("out","number",{label:""}),this.size=[80,30],this.addProperty("factor",1)}onExecute(){var value=this.getInputData(0);null!=value&&this.setOutputData(0,value*this.properties.factor)}}Lite.registerNodeType("math/scale",MathScale);class Gate{static title="Gate";static desc="if v is true, then outputs A, otherwise B";constructor(){this.addInput("v","boolean"),this.addInput("A"),this.addInput("B"),this.addOutput("out")}onExecute(){var v=this.getInputData(0);this.setOutputData(0,this.getInputData(v?1:2))}}Lite.registerNodeType("math/gate",Gate);class MathAverageFilter{static title="Average";static desc="Average Filter";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.size=[80,30],this.addProperty("samples",10),this._values=new Float32Array(10),this._current=0}onExecute(){for(var v=this.getInputData(0),num_samples=this._values.length,avr=(this._values[this._current%num_samples]=v=null==v?0:v,this._current+=1,this._current>num_samples&&(this._current=0),0),i=0;i<num_samples;++i)avr+=this._values[i];this.setOutputData(0,avr/num_samples)}onPropertyChanged(name,value){value<1&&(value=1),this.properties.samples=Math.round(value);value=this._values;this._values=new Float32Array(this.properties.samples),value.length<=this._values.length?this._values.set(value):this._values.set(value.subarray(0,this._values.length))}onPropertyChanged(name,value){"formula"==name&&(this.code_widget.value=value)}}Lite.registerNodeType("math/average",MathAverageFilter);class MathTendTo{static title="TendTo";static desc="moves the output value always closer to the input";constructor(){this.addInput("in","number"),this.addOutput("out","number"),this.addProperty("factor",.1),this.size=[80,30],this._value=null}onExecute(){var v=this.getInputData(0),f=(null==v&&(v=0),this.properties.factor);null==this._value?this._value=v:this._value=this._value*(1-f)+v*f,this.setOutputData(0,this._value)}}Lite.registerNodeType("math/tendTo",MathTendTo);class MathOperation{static title="Operation";static desc="Easy math operators";constructor(){this.addInput("A","number,array,object"),this.addInput("B","number"),this.addOutput("=","number"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP","+","enum",{values:MathOperation.values}),this._func=MathOperation.funcs[this.properties.OP],this._result=[]}getTitle(){return"max"==this.properties.OP||"min"==this.properties.OP?this.properties.OP+"(A,B)":"A "+this.properties.OP+" B"}setValue(v){"string"==typeof v&&(v=parseFloat(v)),this.properties.value=v}onPropertyChanged(name,_value){"OP"!=name||(this._func=MathOperation.funcs[this.properties.OP],this._func)||(console.warn("Unknown operation: "+this.properties.OP),this._func=function(A){return A})}onExecute(){var result,A=this.getInputData(0),B=this.getInputData(1),func=(null!=A?A.constructor===Number&&(this.properties.A=A):A=this.properties.A,null!=B?this.properties.B=B:B=this.properties.B,MathOperation.funcs[this.properties.OP]);if(A.constructor===Number)result=0,result=func(A,B);else if(A.constructor===Array){(result=this._result).length=A.length;for(let i=0;i<A.length;++i)result[i]=func(A[i],B)}else for(var i in result={},A)result[i]=func(A[i],B);this.setOutputData(0,result)}onDrawBackground(ctx){this.flags.collapsed||(ctx.font="40px Arial",ctx.fillStyle="#666",ctx.textAlign="center",ctx.fillText(this.properties.OP,.5*this.size[0],.5*(this.size[1]+Lite.NODE_TITLE_HEIGHT)),ctx.textAlign="left")}static values=["+","-","*","/","%","^","max","min"];static funcs={"+":function(A,B){return A+B},"-":function(A,B){return A-B},x:function(A,B){return A*B},X:function(A,B){return A*B},"*":function(A,B){return A*B},"/":function(A,B){return A/B},"%":function(A,B){return A%B},"^":function(A,B){return Math.pow(A,B)},max:function(A,B){return Math.max(A,B)},min:function(A,B){return Math.min(A,B)}};static"@OP"={type:"enum",title:"operation",values:MathOperation.values};static size=[100,60]}Lite.registerNodeType("math/operation",MathOperation),Lite.registerSearchboxExtra("math/operation","MAX",{properties:{OP:"max"},title:"MAX()"}),Lite.registerSearchboxExtra("math/operation","MIN",{properties:{OP:"min"},title:"MIN()"});class MathCompare{static title="Compare";static desc="compares between two values";constructor(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("A==B","boolean"),this.addOutput("A!=B","boolean"),this.addProperty("A",0),this.addProperty("B",0)}onExecute(){var A=this.getInputData(0),B=this.getInputData(1);void 0!==A?this.properties.A=A:A=this.properties.A,void 0!==B?this.properties.B=B:B=this.properties.B;for(var i=0,l=this.outputs.length;i<l;++i){var value,output=this.outputs[i];if(output.links&&output.links.length){switch(output.name){case"A==B":value=A==B;break;case"A!=B":value=A!=B;break;case"A>B":value=B<A;break;case"A<B":value=A<B;break;case"A<=B":value=A<=B;break;case"A>=B":value=B<=A}this.setOutputData(i,value)}}}onGetOutputs(){return[["A==B","boolean"],["A!=B","boolean"],["A>B","boolean"],["A<B","boolean"],["A>=B","boolean"],["A<=B","boolean"]]}}Lite.registerNodeType("math/compare",MathCompare),Lite.registerSearchboxExtra("math/compare","==",{outputs:[["A==B","boolean"]],title:"A==B"}),Lite.registerSearchboxExtra("math/compare","!=",{outputs:[["A!=B","boolean"]],title:"A!=B"}),Lite.registerSearchboxExtra("math/compare",">",{outputs:[["A>B","boolean"]],title:"A>B"}),Lite.registerSearchboxExtra("math/compare","<",{outputs:[["A<B","boolean"]],title:"A<B"}),Lite.registerSearchboxExtra("math/compare",">=",{outputs:[["A>=B","boolean"]],title:"A>=B"}),Lite.registerSearchboxExtra("math/compare","<=",{outputs:[["A<=B","boolean"]],title:"A<=B"});class MathCondition{static title="Condition";static desc="evaluates condition between A and B";constructor(){this.addInput("A","number"),this.addInput("B","number"),this.addOutput("true","boolean"),this.addOutput("false","boolean"),this.addProperty("A",1),this.addProperty("B",1),this.addProperty("OP",">","enum",{values:MathCondition.values}),this.addWidget("combo","Cond.",this.properties.OP,{property:"OP",values:MathCondition.values}),this.size=[80,60]}getTitle(){return"A "+this.properties.OP+" B"}onExecute(){var A=this.getInputData(0),B=(void 0===A?A=this.properties.A:this.properties.A=A,this.getInputData(1)),result=(void 0===B?B=this.properties.B:this.properties.B=B,!0);switch(this.properties.OP){case">":result=B<A;break;case"<":result=A<B;break;case"==":result=A==B;break;case"!=":result=A!=B;break;case"<=":result=A<=B;break;case">=":result=B<=A;break;case"||":result=A||B;break;case"&&":result=A&&B}this.setOutputData(0,result),this.setOutputData(1,!result)}static values=[">","<","==","!=","<=",">=","||","&&"];static"@OP"={type:"enum",title:"operation",values:MathCondition.values}}Lite.registerNodeType("math/condition",MathCondition);class MathBranch{static title="Branch";static desc="If condition is true, outputs IN in true, otherwise in false";constructor(){this.addInput("in",0),this.addInput("cond","boolean"),this.addOutput("true",0),this.addOutput("false",0),this.size=[80,60]}onExecute(){var V=this.getInputData(0);this.getInputData(1)?(this.setOutputData(0,V),this.setOutputData(1,null)):(this.setOutputData(0,null),this.setOutputData(1,V))}}Lite.registerNodeType("math/branch",MathBranch);class MathAccumulate{static title="Accumulate";static desc="Increments a value every time";constructor(){this.addInput("inc","number"),this.addOutput("total","number"),this.addProperty("increment",1),this.addProperty("value",0)}onExecute(){null===this.properties.value&&(this.properties.value=0);var inc=this.getInputData(0);this.properties.value+=null!==inc?inc:this.properties.increment,this.setOutputData(0,this.properties.value)}}Lite.registerNodeType("math/accumulate",MathAccumulate);class MathTrigonometry{static title="Trigonometry";static desc="Sin Cos Tan";constructor(){this.addInput("v","number"),this.addOutput("sin","number"),this.addProperty("amplitude",1),this.addProperty("offset",0),this.bgImageUrl="nodes/imgs/icon-sin.png"}onExecute(){var v=this.getInputData(0),amplitude=(null==v&&(v=0),this.properties.amplitude),slot=this.findInputSlot("amplitude"),offset=(-1!=slot&&(amplitude=this.getInputData(slot)),this.properties.offset);-1!=(slot=this.findInputSlot("offset"))&&(offset=this.getInputData(slot));for(var value,i=0,l=this.outputs.length;i<l;++i){switch(this.outputs[i].name){case"sin":value=Math.sin(v);break;case"cos":value=Math.cos(v);break;case"tan":value=Math.tan(v);break;case"asin":value=Math.asin(v);break;case"acos":value=Math.acos(v);break;case"atan":value=Math.atan(v)}this.setOutputData(i,amplitude*value+offset)}}onGetInputs(){return[["v","number"],["amplitude","number"],["offset","number"]]}onGetOutputs(){return[["sin","number"],["cos","number"],["tan","number"],["asin","number"],["acos","number"],["atan","number"]]}}Lite.registerNodeType("math/trigonometry",MathTrigonometry),Lite.registerSearchboxExtra("math/trigonometry","SIN()",{outputs:[["sin","number"]],title:"SIN()"}),Lite.registerSearchboxExtra("math/trigonometry","COS()",{outputs:[["cos","number"]],title:"COS()"}),Lite.registerSearchboxExtra("math/trigonometry","TAN()",{outputs:[["tan","number"]],title:"TAN()"});class MathFormula{static title="Formula";static desc="Compute formula";constructor(){this.addInput("x","number"),this.addInput("y","number"),this.addOutput("","number"),this.properties={x:1,y:1,formula:"x+y"},this.code_widget=this.addWidget("text","F(x,y)",this.properties.formula,function(v,canvas,node){node.properties.formula=v}),this.addWidget("toggle","allow",Lite.allow_scripts,function(v){Lite.allow_scripts=v}),this._func=null}onExecute(){if(Lite.allow_scripts){var value,x=this.getInputData(0),y=this.getInputData(1);null!=x?this.properties.x=x:x=this.properties.x,null!=y?this.properties.y=y:y=this.properties.y;try{this._func&&this._func_code==this.properties.formula||(this._func=new Function("x","y","TIME","return "+this.properties.formula),this._func_code=this.properties.formula),value=this._func(x,y,this.graph.globaltime),this.boxcolor=null}catch(err){this.boxcolor="red"}this.setOutputData(0,value)}}getTitle(){return this._func_code||"Formula"}onDrawBackground(){var f=this.properties.formula;this.outputs&&this.outputs.length&&(this.outputs[0].label=f)}static size=[160,100]}Lite.registerNodeType("math/formula",MathFormula);class Math3DVec2ToXY{static title="Vec2->XY";static desc="vector 2 to components";constructor(){this.addInput("vec2","vec2"),this.addOutput("x","number"),this.addOutput("y","number")}onExecute(){var v=this.getInputData(0);null!=v&&(this.setOutputData(0,v[0]),this.setOutputData(1,v[1]))}}Lite.registerNodeType("math3d/vec2-to-xy",Math3DVec2ToXY);class Math3DXYToVec2{static title="XY->Vec2";static desc="components to vector2";constructor(){this.addInputs([["x","number"],["y","number"]]),this.addOutput("vec2","vec2"),this.properties={x:0,y:0},this._data=new Float32Array(2)}onExecute(){var x=this.getInputData(0),y=(null==x&&(x=this.properties.x),this.getInputData(1)),data=(null==y&&(y=this.properties.y),this._data);data[0]=x,data[1]=y,this.setOutputData(0,data)}}Lite.registerNodeType("math3d/xy-to-vec2",Math3DXYToVec2);class Math3DVec3ToXYZ{static title="Vec3->XYZ";static desc="vector 3 to components";constructor(){this.addInput("vec3","vec3"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number")}onExecute(){var v=this.getInputData(0);null!=v&&(this.setOutputData(0,v[0]),this.setOutputData(1,v[1]),this.setOutputData(2,v[2]))}}Lite.registerNodeType("math3d/vec3-to-xyz",Math3DVec3ToXYZ);class Math3DXYZToVec3{static title="XYZ->Vec3";static desc="components to vector3";constructor(){this.addInputs([["x","number"],["y","number"],["z","number"]]),this.addOutput("vec3","vec3"),this.properties={x:0,y:0,z:0},this._data=new Float32Array(3)}onExecute(){var x=this.getInputData(0),y=(null==x&&(x=this.properties.x),this.getInputData(1)),z=(null==y&&(y=this.properties.y),this.getInputData(2)),data=(null==z&&(z=this.properties.z),this._data);data[0]=x,data[1]=y,data[2]=z,this.setOutputData(0,data)}}Lite.registerNodeType("math3d/xyz-to-vec3",Math3DXYZToVec3);class Math3DVec4ToXYZW{static title="Vec4->XYZW";static desc="vector 4 to components";constructor(){this.addInput("vec4","vec4"),this.addOutput("x","number"),this.addOutput("y","number"),this.addOutput("z","number"),this.addOutput("w","number")}onExecute(){var v=this.getInputData(0);null!=v&&(this.setOutputData(0,v[0]),this.setOutputData(1,v[1]),this.setOutputData(2,v[2]),this.setOutputData(3,v[3]))}}Lite.registerNodeType("math3d/vec4-to-xyzw",Math3DVec4ToXYZW);class Math3DXYZWToVec4{static title="XYZW->Vec4";static desc="components to vector4";constructor(){this.addInputs([["x","number"],["y","number"],["z","number"],["w","number"]]),this.addOutput("vec4","vec4"),this.properties={x:0,y:0,z:0,w:0},this._data=new Float32Array(4)}onExecute(){var x=this.getInputData(0),y=(null==x&&(x=this.properties.x),this.getInputData(1)),z=(null==y&&(y=this.properties.y),this.getInputData(2)),w=(null==z&&(z=this.properties.z),this.getInputData(3)),data=(null==w&&(w=this.properties.w),this._data);data[0]=x,data[1]=y,data[2]=z,data[3]=w,this.setOutputData(0,data)}}Lite.registerNodeType("math3d/xyzw-to-vec4",Math3DXYZWToVec4);

import{Lite}from"../Lite.js";function toString(a){if(a&&a.constructor===Object)try{return JSON.stringify(a)}catch(err){}return String(a)}function compare(a,b){return a==b}function concatenate(a,b){return void 0===a?b:void 0===b?a:a+""+b}function contains(a,b){return void 0!==a&&void 0!==b&&-1!=a.indexOf(b)}function toUpperCase(a){return null!=a&&a.constructor===String?a.toUpperCase():a}function split(str,separator){if(null==separator&&(separator=this.properties.separator),null==str)return[];if(str.constructor===String)return str.split(separator||" ");if(str.constructor!==Array)return null;for(var r=[],i=0;i<str.length;++i)"string"==typeof str[i]&&(r[i]=str[i].split(separator||" "));return r}function toFixed(a){return null!=a&&a.constructor===Number?a.toFixed(this.properties.precision):a}Lite.wrapFunctionAsNode("string/toString",toString,[""],"string"),Lite.wrapFunctionAsNode("string/compare",compare,["string","string"],"boolean"),Lite.wrapFunctionAsNode("string/concatenate",concatenate,["string","string"],"string"),Lite.wrapFunctionAsNode("string/contains",contains,["string","string"],"boolean"),Lite.wrapFunctionAsNode("string/toUpperCase",toUpperCase,["string"],"string"),Lite.wrapFunctionAsNode("string/split",split,["string,array","string"],"array",{separator:","}),Lite.wrapFunctionAsNode("string/toFixed",toFixed,["number"],"string",{precision:0});class StringToTable{static title="toTable";static desc="Splits a string to table";constructor(){this.addInput("","string"),this.addOutput("table","table"),this.addOutput("rows","number"),this.addProperty("value",""),this.addProperty("separator",","),this._table=null}onExecute(){var separator,input=this.getInputData(0);input&&(separator=this.properties.separator||",",input==this._str&&separator==this._last_separator||(this._last_separator=separator,this._str=input,this._table=input.split("\n").map(function(a){return a.trim().split(separator)})),this.setOutputData(0,this._table),this.setOutputData(1,this._table?this._table.length:0))}}Lite.registerNodeType("string/toTable",StringToTable);

import{Lite}from"../Lite.js";class Selector{static title="Selector";static desc="selects an output";constructor(){this.addInput("sel","number"),this.addInput("A"),this.addInput("B"),this.addInput("C"),this.addInput("D"),this.addOutput("out"),this.selected=0}onDrawBackground(ctx){var y;this.flags.collapsed||(ctx.fillStyle="#AFB",y=(this.selected+1)*Lite.NODE_SLOT_HEIGHT+6,ctx.beginPath(),ctx.moveTo(50,y),ctx.lineTo(50,y+Lite.NODE_SLOT_HEIGHT),ctx.lineTo(34,y+.5*Lite.NODE_SLOT_HEIGHT),ctx.fill())}onExecute(){var sel=this.getInputData(0),sel=(null!=sel&&sel.constructor===Number||(sel=0),this.selected=sel=Math.round(sel)%(this.inputs.length-1),this.getInputData(sel+1));void 0!==sel&&this.setOutputData(0,sel)}onGetInputs(){return[["E",0],["F",0],["G",0],["H",0]]}}Lite.registerNodeType("logic/selector",Selector);class Sequence{static title="Sequence";static desc="select one element from a sequence from a string";constructor(){this.properties={sequence:"A,B,C"},this.addInput("index","number"),this.addInput("seq"),this.addOutput("out"),this.index=0,this.values=this.properties.sequence.split(",")}onPropertyChanged(name,value){"sequence"==name&&(this.values=value.split(","))}onExecute(){var seq=this.getInputData(1),seq=(seq&&seq!=this.current_sequence&&(this.values=seq.split(","),this.current_sequence=seq),this.getInputData(0));null==seq&&(seq=0),this.index=seq=Math.round(seq)%this.values.length,this.setOutputData(0,this.values[seq])}}Lite.registerNodeType("logic/sequence",Sequence);class logicAnd{static title="AND";static desc="Return true if all inputs are true";constructor(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}onExecute(){let ret=!0;for(var inX in this.inputs)if(!this.getInputData(inX)){ret=!1;break}this.setOutputData(0,ret)}onGetInputs(){return[["and","boolean"]]}}Lite.registerNodeType("logic/AND",logicAnd);class logicOr{static title="OR";static desc="Return true if at least one input is true";constructor(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}onExecute(){var inX,ret=!1;for(inX in this.inputs)if(this.getInputData(inX)){ret=!0;break}this.setOutputData(0,ret)}onGetInputs(){return[["or","boolean"]]}}Lite.registerNodeType("logic/OR",logicOr);class logicNot{static title="NOT";static desc="Return the logical negation";constructor(){this.properties={},this.addInput("in","boolean"),this.addOutput("out","boolean")}onExecute(){var ret=!this.getInputData(0);this.setOutputData(0,ret)}}Lite.registerNodeType("logic/NOT",logicNot);class logicCompare{static title="bool == bool";static desc="Compare for logical equality";constructor(){this.properties={},this.addInput("a","boolean"),this.addInput("b","boolean"),this.addOutput("out","boolean")}onExecute(){var inX,last=null,ret=!0;for(inX in this.inputs)if(null===last)last=this.getInputData(inX);else if(last!=this.getInputData(inX)){ret=!1;break}this.setOutputData(0,ret)}onGetInputs(){return[["bool","boolean"]]}}Lite.registerNodeType("logic/CompareBool",logicCompare);class logicBranch{static title="Branch";static desc="Branch execution on condition";constructor(){this.properties={},this.addInput("onTrigger",Lite.ACTION),this.addInput("condition","boolean"),this.addOutput("true",Lite.EVENT),this.addOutput("false",Lite.EVENT),this.mode=Lite.ON_TRIGGER}onExecute(_param,_options){this.getInputData(1)?this.triggerSlot(0):this.triggerSlot(1)}}Lite.registerNodeType("logic/IF",logicBranch);class logicFor{constructor(){this.properties={},this.addInput("start","number"),this.addInput("nElements","number"),this.addInput("do",Lite.ACTION),this.addInput("break",Lite.ACTION),this.addOutput("do",Lite.EVENT),this.addOutput("index","number"),this.started=!1,this.stopped=!1}static title="FOR";static desc="Cycle FOR";onExecute(param){if(this.started){for(var iI=this.getInputData(0),num=this.getInputData(1),k=iI;k<iI+num;k++){if(console.debug("for cycle "+k),this.triggerSlot(0,param),this.stopped){console.debug("for cycle stopped on index "+k);break}this.setOutputData(1,k)}this.started=!1,this.stopped=!0}}onAction(action,param){switch(action){case"break":this.stopped=!0;break;case"do":this.started=!0,this.stopped=!1,this.execute()}}}Lite.registerNodeType("logic/CycleFOR",logicFor);class logicWhile{constructor(){this.properties={cycleLimit:999,checkOnStart:!0},this.addInput("do",Lite.ACTION),this.addInput("condition","boolean"),this.addInput("break",Lite.ACTION),this.addOutput("do",Lite.EVENT),this.addOutput("index","number"),this.started=!1,this.stopped=!1,this.k=0,this.cond=!1,this.addWidget("toggle","checkOnStart",this.properties.checkOnStart,"checkOnStart")}static title="WHILE";static desc="Cycle WHILE";onExecute(param){this.setOutputData(1,this.k),this.cond=this.getInputData(1)}onAction(action,param){switch(action){case"break":this.stopped=!0;break;case"do":this.started=!0,this.stopped=!1;var checkOnStart=this.getInputOrProperty("checkOnStart");for(this.cond=!checkOnStart||this.getInputData(1),this.k=0,cycleLimit=this.properties.cycleLimit||999;this.cond&&this.k<cycleLimit;){if(console.debug("while cycle "+this.k),this.setOutputData(1,this.k),this.triggerSlot(0,param),this.stopped){console.debug("while cycle stopped on index "+k);break}this.k++,this.cond=this.getInputData(1,!0,!0)}this.k=0,this.setOutputData(1,this.k),this.cond=this.getInputData(1),this.started=!1,this.stopped=!0}}}Lite.registerNodeType("logic/CycleWHILE",logicWhile);

import{Lite}from"../Lite.js";class LGWebSocket{static title="WebSocket";static desc="Send data through a websocket";constructor(){this.size=[60,20],this.addInput("send",Lite.ACTION),this.addOutput("received",Lite.EVENT),this.addInput("in",0),this.addOutput("out",0),this.properties={url:"",room:"lgraph",only_send_changes:!0},this._ws=null,this._last_sent_data=[],this._last_received_data=[]}onPropertyChanged(name,_value){"url"==name&&this.connectSocket()}onExecute(){if(!this._ws&&this.properties.url&&this.connectSocket(),this._ws&&this._ws.readyState==WebSocket.OPEN){var room=this.properties.room,only_changes=this.properties.only_send_changes;for(let i=1;i<this.inputs.length;++i){var json,data=this.getInputData(i);if(null!=data){try{json=JSON.stringify({type:0,room:room,channel:i,data:data})}catch(err){continue}only_changes&&this._last_sent_data[i]==json||(this._last_sent_data[i]=json,this._ws.send(json))}}for(let i=1;i<this.outputs.length;++i)this.setOutputData(i,this._last_received_data[i]);"#AFA"==this.boxcolor&&(this.boxcolor="#6C6")}}connectSocket(){var that=this,url=this.properties.url;"ws"!=url.substr(0,2)&&(url="ws://"+url),this._ws=new WebSocket(url),this._ws.onopen=function(){console.log("ready"),that.boxcolor="#6C6"},this._ws.onmessage=function(e){that.boxcolor="#AFA";e=JSON.parse(e.data);if(!e.room||e.room==that.properties.room)if(1==e.type)if(e.data.object_class&&Lite[e.data.object_class]){var obj;try{obj=new Lite[e.data.object_class](e.data),that.triggerSlot(0,obj)}catch(err){}}else that.triggerSlot(0,e.data);else that._last_received_data[e.channel||0]=e.data},this._ws.onerror=function(_e){console.log("couldnt connect to websocket"),that.boxcolor="#E88"},this._ws.onclose=function(_e){console.log("connection closed"),that.boxcolor="#000"}}send(data){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send(JSON.stringify({type:1,msg:data}))}onAction(action,param){this._ws&&this._ws.readyState==WebSocket.OPEN&&this._ws.send({type:1,room:this.properties.room,action:action,data:param})}onGetInputs(){return[["in",0]]}onGetOutputs(){return[["out",0]]}}Lite.registerNodeType("network/websocket",LGWebSocket);class HTTPRequestNode{static title="HTTP Request";static desc="Fetch data through HTTP";constructor(){this.addInput("request",Lite.ACTION),this.addInput("url","string"),this.addProperty("url",""),this.addOutput("ready",Lite.EVENT),this.addOutput("data","string"),this.addWidget("button","Fetch",null,this.fetch.bind(this)),this._data=null,this._fetching=null}fetch(){var that,url=this.getInputOrProperty("url");url&&(this.boxcolor="#FF0",(that=this)._fetching=fetch(url).then(resp=>{if(resp.ok)return this.boxcolor="#0F0",resp.text();this.boxcolor="#F00",that.trigger("error")}).then(data=>{that._data=data,that._fetching=null,that.trigger("ready")}))}onAction(evt){"request"==evt&&this.fetch()}onExecute(){this.setOutputData(1,this._data)}onGetOutputs(){return[["error",Lite.EVENT]]}}Lite.registerNodeType("network/httprequest",HTTPRequestNode);

